<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
  
  <!-- PWA Meta Tags -->
  <meta name="application-name" content="XRP ORACULUM">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="XRP ORACULUM">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#02060c">
  <meta name="msapplication-TileColor" content="#02060c">
  <meta name="msapplication-navbutton-color" content="#00d4ff">
  
  <!-- SEO & Social -->
  <meta name="description" content="Advanced XRP Trading Dashboard with Real-Time Data, Predictive Engine, and Professional Analytics">
  <meta name="keywords" content="XRP, trading, dashboard, crypto, analysis, ripple, ORACULUM">
  <meta name="author" content="OkrtSystem Labs">
  
  <title>XRP ORACULUM OkrtSystem Labs</title>
  
  <!-- PWA Icons -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%2300d4ff'/%3E%3Cstop offset='100%25' stop-color='%23a855f7'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' rx='100' fill='%2302060c'/%3E%3Crect x='128' y='128' width='256' height='256' rx='40' fill='url(%23g)' transform='rotate(45 256 256)'/%3E%3Ctext x='256' y='290' text-anchor='middle' font-family='Arial Black' font-size='180' font-weight='900' fill='%2302060c'%3EX%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%2300d4ff'/%3E%3Cstop offset='100%25' stop-color='%23a855f7'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' rx='100' fill='%2302060c'/%3E%3Crect x='128' y='128' width='256' height='256' rx='40' fill='url(%23g)' transform='rotate(45 256 256)'/%3E%3Ctext x='256' y='290' text-anchor='middle' font-family='Arial Black' font-size='180' font-weight='900' fill='%2302060c'%3EX%3C/text%3E%3C/svg%3E">
  
  <!-- Splash Screens iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-startup-image" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1242 2688'%3E%3Crect fill='%2302060c' width='1242' height='2688'/%3E%3Ctext x='621' y='1344' text-anchor='middle' font-family='Arial' font-size='120' fill='%2300d4ff'%3EXRP ORACULUM%3C/text%3E%3C/svg%3E">
  
  <!-- Web App Manifest (inline) -->
  <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22XRP%20ORACULUM%20V3%20PRO%22%2C%22short_name%22%3A%22ORACULUM%22%2C%22description%22%3A%22Advanced%20XRP%20Trading%20Dashboard%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22orientation%22%3A%22any%22%2C%22background_color%22%3A%22%2302060c%22%2C%22theme_color%22%3A%22%2300d4ff%22%2C%22categories%22%3A%5B%22finance%22%2C%22utilities%22%5D%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%2520viewBox%3D%270%25200%2520512%2520512%27%253E%253Cdefs%253E%253ClinearGradient%2520id%3D%27g%27%2520x1%3D%270%2525%27%2520y1%3D%270%2525%27%2520x2%3D%27100%2525%27%2520y2%3D%27100%2525%27%253E%253Cstop%2520offset%3D%270%2525%27%2520stop-color%3D%27%252300d4ff%27%2F%253E%253Cstop%2520offset%3D%27100%2525%27%2520stop-color%3D%27%2523a855f7%27%2F%253E%253C%2FlinearGradient%253E%253C%2Fdefs%253E%253Crect%2520width%3D%27512%27%2520height%3D%27512%27%2520rx%3D%27100%27%2520fill%3D%27%252302060c%27%2F%253E%253Crect%2520x%3D%27128%27%2520y%3D%27128%27%2520width%3D%27256%27%2520height%3D%27256%27%2520rx%3D%2740%27%2520fill%3D%27url%28%2523g%29%27%2520transform%3D%27rotate%2845%2520256%2520256%29%27%2F%253E%253Ctext%2520x%3D%27256%27%2520y%3D%27290%27%2520text-anchor%3D%27middle%27%2520font-family%3D%27Arial%2520Black%27%2520font-size%3D%27180%27%2520font-weight%3D%27900%27%2520fill%3D%27%252302060c%27%253EX%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D">
  
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-primary: #02060c;
      --bg-card: rgba(13, 24, 41, 0.85); 
      --bg-header: rgba(2, 6, 12, 0.95);
      
      --accent-cyan: #00d4ff;
      --accent-purple: #a855f7;
      --accent-green: #00ff88;
      --accent-red: #ff4466;
      --accent-orange: #ff9500;
      --accent-yellow: #f4b942;
      --text-main: #f0f4f8;
      --text-dim: #94a3b8;
      
      --border-glass: 1px solid rgba(255, 255, 255, 0.15);
      --font-tech: 'Orbitron', sans-serif;
      --font-data: 'JetBrains Mono', monospace;
    }

    /* Modo Claro */
    body.light-mode {
      --bg-primary: #f0f4f8;
      --bg-card: rgba(255, 255, 255, 0.9);
      --bg-header: rgba(240, 244, 248, 0.98);
      --text-main: #1a202c;
      --text-dim: #4a5568;
      --border-glass: 1px solid rgba(0, 0, 0, 0.1);
    }
    body.light-mode { background: radial-gradient(circle at 50% 0%, #e2e8f0 0%, #f0f4f8 80%); }
    body.light-mode .grid-bg {
      background-image: 
        linear-gradient(rgba(0, 100, 150, 0.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 100, 150, 0.08) 1px, transparent 1px);
    }
    body.light-mode .panel { background: var(--bg-card); border: 1px solid rgba(0,0,0,0.1); }
    body.light-mode .kpi-card { background: linear-gradient(180deg, rgba(255,255,255,0.8), rgba(240,244,248,0.9)); border: 1px solid rgba(0,0,0,0.08); }
    body.light-mode .ob-bid { color: #059669; }
    body.light-mode .ob-ask { color: #dc2626; }

    /* Controles del header */
    .header-controls {
      display: flex; gap: 8px; align-items: center;
    }
    .control-btn {
      font-family: var(--font-data); font-size: 10px;
      padding: 5px 10px; border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px; background: rgba(0,0,0,0.3);
      color: var(--text-dim); cursor: pointer; transition: all 0.2s;
    }
    .control-btn:hover { background: rgba(0,212,255,0.2); border-color: var(--accent-cyan); color: var(--accent-cyan); }
    .control-btn.active { background: var(--accent-cyan); color: #000; border-color: var(--accent-cyan); }
    
    .timeframe-select {
      font-family: var(--font-data); font-size: 10px;
      padding: 5px 8px; border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px; background: rgba(0,0,0,0.5);
      color: var(--accent-cyan); cursor: pointer;
    }
    .timeframe-select option { background: #0d1829; color: #fff; }

    body.light-mode .control-btn { background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.2); color: var(--text-dim); }
    body.light-mode .control-btn:hover { background: rgba(0,212,255,0.1); }
    body.light-mode .timeframe-select { background: rgba(255,255,255,0.8); color: #1a202c; border-color: rgba(0,0,0,0.2); }

    /* Mini gr√°fico de accuracy */
    .accuracy-chart {
      display: flex; align-items: flex-end; gap: 1px; height: 30px; padding: 5px;
      background: rgba(0,0,0,0.2); border-radius: 3px; margin: 5px 10px;
    }
    .accuracy-bar-mini {
      width: 4px; border-radius: 1px; transition: height 0.3s;
      min-height: 2px;
    }

    /* ============================================
       TOOLS PANEL - Multi-TF, Risk Calc, Alerts
       ============================================ */
    .tools-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .tools-overlay.active { display: flex; }

    .tools-panel {
      width: 900px;
      max-height: 85vh;
      background: linear-gradient(180deg, #0d1829 0%, #061018 100%);
      border: 1px solid rgba(0,212,255,0.3);
      border-radius: 16px;
      box-shadow: 0 0 60px rgba(0,212,255,0.2);
      overflow: hidden;
    }

    .tools-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .tools-header h2 {
      font-family: var(--font-tech);
      font-size: 16px;
      color: var(--accent-cyan);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .tools-close {
      background: none;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text-dim);
      width: 30px; height: 30px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s;
    }
    .tools-close:hover {
      background: var(--accent-red);
      border-color: var(--accent-red);
      color: #fff;
    }

    .tools-tabs {
      display: flex;
      gap: 5px;
      padding: 10px 20px;
      background: rgba(0,0,0,0.2);
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .tools-tab {
      padding: 10px 20px;
      border: none;
      background: rgba(255,255,255,0.05);
      color: var(--text-dim);
      border-radius: 8px;
      cursor: pointer;
      font-family: var(--font-tech);
      font-size: 11px;
      transition: all 0.2s;
    }
    .tools-tab:hover { background: rgba(0,212,255,0.1); color: var(--accent-cyan); }
    .tools-tab.active { background: var(--accent-cyan); color: #000; }

    .tools-content {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .tool-section { display: none; }
    .tool-section.active { display: block; }

    /* Multi-Timeframe Panel */
    .mtf-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
    }

    .mtf-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }

    .mtf-card.bullish { border-color: rgba(0,255,136,0.3); background: rgba(0,255,136,0.05); }
    .mtf-card.bearish { border-color: rgba(255,68,102,0.3); background: rgba(255,68,102,0.05); }

    .mtf-tf {
      font-family: var(--font-tech);
      font-size: 18px;
      color: var(--accent-cyan);
      margin-bottom: 10px;
    }

    .mtf-price {
      font-family: var(--font-data);
      font-size: 14px;
      color: var(--text-main);
      margin-bottom: 8px;
    }

    .mtf-signal {
      font-size: 11px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
      margin-bottom: 8px;
    }
    .mtf-signal.bullish { background: rgba(0,255,136,0.2); color: var(--accent-green); }
    .mtf-signal.bearish { background: rgba(255,68,102,0.2); color: var(--accent-red); }
    .mtf-signal.neutral { background: rgba(255,255,255,0.1); color: var(--text-dim); }

    .mtf-indicators {
      font-size: 9px;
      color: var(--text-dim);
      line-height: 1.6;
    }

    .mtf-rsi { font-weight: 600; }
    .mtf-rsi.oversold { color: var(--accent-green); }
    .mtf-rsi.overbought { color: var(--accent-red); }
    .mtf-rsi.neutral { color: var(--text-dim); }

    /* Risk Calculator */
    .risk-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .risk-inputs, .risk-results {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 20px;
    }

    .risk-inputs h3, .risk-results h3 {
      font-family: var(--font-tech);
      font-size: 12px;
      color: var(--accent-cyan);
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 5px;
    }

    .input-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      background: rgba(0,0,0,0.3);
      color: var(--text-main);
      font-family: var(--font-data);
      font-size: 13px;
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--accent-cyan);
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .result-item:last-child { border: none; }

    .result-label {
      font-size: 11px;
      color: var(--text-dim);
    }

    .result-value {
      font-family: var(--font-data);
      font-size: 13px;
      font-weight: 600;
    }
    .result-value.green { color: var(--accent-green); }
    .result-value.red { color: var(--accent-red); }
    .result-value.cyan { color: var(--accent-cyan); }

    .risk-ratio {
      text-align: center;
      padding: 15px;
      background: rgba(0,212,255,0.1);
      border-radius: 8px;
      margin-top: 15px;
    }

    .risk-ratio-value {
      font-family: var(--font-tech);
      font-size: 28px;
      color: var(--accent-cyan);
    }

    .risk-ratio-label {
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 5px;
    }

    /* Price Alerts */
    .alerts-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .alerts-form, .alerts-list-panel {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 20px;
    }

    .alerts-form h3, .alerts-list-panel h3 {
      font-family: var(--font-tech);
      font-size: 12px;
      color: var(--accent-cyan);
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .alert-type-btns {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .alert-type-btn {
      flex: 1;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.2);
      color: var(--text-dim);
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }
    .alert-type-btn:hover { border-color: var(--accent-cyan); }
    .alert-type-btn.active.above { background: rgba(0,255,136,0.2); border-color: var(--accent-green); color: var(--accent-green); }
    .alert-type-btn.active.below { background: rgba(255,68,102,0.2); border-color: var(--accent-red); color: var(--accent-red); }

    .add-alert-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      border: none;
      border-radius: 8px;
      color: #000;
      font-family: var(--font-tech);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .add-alert-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,212,255,0.3); }

    .custom-alerts-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .custom-alert-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 3px solid;
    }
    .custom-alert-item.above { border-color: var(--accent-green); }
    .custom-alert-item.below { border-color: var(--accent-red); }
    .custom-alert-item.triggered { opacity: 0.5; }

    .alert-info {
      flex: 1;
    }

    .alert-price {
      font-family: var(--font-data);
      font-size: 14px;
      font-weight: 600;
      color: var(--text-main);
    }

    .alert-condition {
      font-size: 10px;
      color: var(--text-dim);
    }

    .alert-delete {
      background: none;
      border: none;
      color: var(--accent-red);
      cursor: pointer;
      font-size: 16px;
      opacity: 0.6;
      transition: opacity 0.2s;
    }
    .alert-delete:hover { opacity: 1; }

    .no-alerts {
      text-align: center;
      padding: 30px;
      color: var(--text-dim);
      font-size: 12px;
    }

    /* ============================================
       NEW TOOLS: Fibo, Session, Strategy, Correlation, Watchlist
       ============================================ */
    
    /* Session Stats */
    .session-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    .session-stat {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
    }
    .session-stat-value {
      font-family: var(--font-tech);
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    .session-stat-label {
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .session-timeline {
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 15px;
    }
    .timeline-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 11px;
    }
    .timeline-row:last-child { border: none; }

    /* Fibonacci */
    .fibo-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .fibo-levels, .fibo-info {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 20px;
    }
    .fibo-level-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .fibo-level-row:last-child { border: none; }
    .fibo-label {
      font-size: 12px;
      color: var(--text-dim);
    }
    .fibo-price {
      font-family: var(--font-data);
      font-size: 13px;
      font-weight: 600;
    }
    .fibo-bar {
      flex: 1;
      height: 4px;
      background: rgba(255,255,255,0.1);
      margin: 0 15px;
      border-radius: 2px;
      position: relative;
    }
    .fibo-bar-fill {
      position: absolute;
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s;
    }
    .fibo-current-marker {
      position: absolute;
      width: 8px;
      height: 8px;
      background: var(--accent-cyan);
      border-radius: 50%;
      top: -2px;
      transform: translateX(-50%);
      box-shadow: 0 0 10px var(--accent-cyan);
    }

    /* Correlation */
    .corr-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }
    .corr-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .corr-pair {
      font-family: var(--font-tech);
      font-size: 14px;
      color: var(--accent-cyan);
      margin-bottom: 10px;
    }
    .corr-value {
      font-family: var(--font-data);
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    .corr-value.positive { color: var(--accent-green); }
    .corr-value.negative { color: var(--accent-red); }
    .corr-value.neutral { color: var(--text-dim); }
    .corr-label {
      font-size: 10px;
      color: var(--text-dim);
    }
    .corr-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      margin-top: 10px;
      overflow: hidden;
    }
    .corr-bar-fill {
      height: 100%;
      transition: width 0.5s;
    }

    /* Watchlist */
    .watchlist-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .watchlist-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .watchlist-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      background: rgba(255,255,255,0.05);
    }
    .watchlist-info { flex: 1; }
    .watchlist-symbol {
      font-family: var(--font-tech);
      font-size: 14px;
      color: var(--text-main);
    }
    .watchlist-name {
      font-size: 10px;
      color: var(--text-dim);
    }
    .watchlist-price {
      text-align: right;
    }
    .watchlist-price-value {
      font-family: var(--font-data);
      font-size: 16px;
      font-weight: 600;
    }
    .watchlist-change {
      font-size: 11px;
      font-family: var(--font-data);
    }
    .watchlist-change.up { color: var(--accent-green); }
    .watchlist-change.down { color: var(--accent-red); }
    .watchlist-mini-chart {
      width: 60px;
      height: 30px;
      display: flex;
      align-items: flex-end;
      gap: 2px;
    }
    .mini-bar {
      flex: 1;
      border-radius: 1px;
      transition: height 0.3s;
    }

    /* Strategy Builder */
    .strategy-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .strategy-builder, .strategy-list {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 20px;
    }
    .condition-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .condition-row select, .condition-row input {
      padding: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      background: rgba(0,0,0,0.3);
      color: var(--text-main);
      font-family: var(--font-data);
      font-size: 11px;
    }
    .condition-row select { flex: 1; }
    .condition-row input { width: 80px; }
    .logic-connector {
      text-align: center;
      padding: 5px;
      font-size: 10px;
      color: var(--accent-purple);
      font-weight: 600;
    }
    .strategy-item {
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      border-left: 3px solid var(--accent-purple);
    }
    .strategy-item.active { border-color: var(--accent-green); }
    .strategy-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .strategy-item-name {
      font-family: var(--font-tech);
      font-size: 12px;
      color: var(--accent-cyan);
    }
    .strategy-item-toggle {
      width: 40px;
      height: 20px;
      border-radius: 10px;
      background: rgba(255,255,255,0.1);
      position: relative;
      cursor: pointer;
      transition: background 0.3s;
    }
    .strategy-item-toggle.active {
      background: var(--accent-green);
    }
    .strategy-item-toggle::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: white;
      top: 2px;
      left: 2px;
      transition: left 0.3s;
    }
    .strategy-item-toggle.active::after {
      left: 22px;
    }
    .strategy-conditions {
      font-size: 10px;
      color: var(--text-dim);
      line-height: 1.6;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: radial-gradient(circle at 50% 0%, #112240 0%, var(--bg-primary) 80%);
      color: var(--text-main);
      font-family: 'Rajdhani', sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .grid-bg {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
      background-image: 
        linear-gradient(rgba(0, 212, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 212, 255, 0.05) 1px, transparent 1px);
      background-size: 50px 50px;
      mask-image: radial-gradient(circle at 50% 50%, black 40%, transparent 90%);
    }

    header {
      height: 55px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: var(--bg-header);
      border-bottom: var(--border-glass);
      z-index: 10;
    }

    .brand { display: flex; align-items: center; gap: 10px; }
    .brand h1 { font-family: var(--font-tech); font-size: 18px; letter-spacing: 2px; color: var(--accent-cyan); text-shadow: 0 0 10px rgba(0,212,255,0.4); }
    
    .header-center {
      display: flex; gap: 15px; align-items: center;
    }
    .header-stat {
      font-family: var(--font-data); font-size: 11px;
      padding: 4px 10px; border: 1px solid rgba(255,255,255,0.1);
      border-radius: 4px; background: rgba(0,0,0,0.3);
    }
    .header-stat span { color: var(--text-dim); }

    .status-pill {
      font-family: var(--font-data); font-size: 11px; padding: 4px 10px;
      border: 1px solid #333; border-radius: 4px;
      display: flex; align-items: center; gap: 6px;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; }
    .status-live .status-dot { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }
    .status-err .status-dot { background: var(--accent-red); }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: 320px 1fr 340px;
      grid-template-rows: 80px 1fr 190px;
      gap: 10px;
      padding: 10px;
      overflow: hidden;
    }

    .panel {
      background: var(--bg-card);
      border: var(--border-glass);
      border-radius: 4px;
      backdrop-filter: blur(5px);
      display: flex; flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    
    .panel-head {
      font-family: var(--font-tech); font-size: 10px; color: var(--text-dim);
      padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex; justify-content: space-between; letter-spacing: 1px;
      flex-shrink: 0; align-items: center;
    }

    .metrics-wrapper {
      grid-column: 1 / -1; grid-row: 1;
      display: flex; gap: 10px;
    }
    .kpi-card {
      flex: 1; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.2));
      border: var(--border-glass); padding: 8px 12px;
      display: flex; flex-direction: column; justify-content: center;
    }
    .kpi-val { font-family: var(--font-data); font-size: 20px; font-weight: 700; color: var(--text-main); margin-top: 3px; }
    .kpi-lbl { font-size: 10px; color: var(--text-dim); text-transform: uppercase; }
    .kpi-sub { font-size: 9px; color: var(--text-dim); margin-top: 2px; }

    .chart-box {
      grid-column: 2; grid-row: 2;
      position: relative;
      overflow: hidden; 
    }
    #chartContainer { width: 100%; height: 100%; }

    .side-left { grid-column: 1; grid-row: 2 / 4; display: flex; flex-direction: column; gap: 10px; }
    .side-right { grid-column: 3; grid-row: 2 / 4; display: flex; flex-direction: column; gap: 10px; }
    .bottom-box { grid-column: 2; grid-row: 3; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

    .ob-row {
      display: flex; justify-content: space-between; font-family: var(--font-data); font-size: 11px;
      padding: 2px 8px;
    }
    .ob-ask { color: var(--accent-red); }
    .ob-bid { color: var(--accent-green); }
    
    .whale-item {
      font-size: 10px; padding: 5px 10px; border-left: 3px solid var(--accent-purple);
      margin-bottom: 3px; background: rgba(255,255,255,0.02); font-family: var(--font-data);
      display: flex; justify-content: space-between; align-items: center;
    }
    .whale-item.buy { border-left-color: var(--accent-green); }
    .whale-item.sell { border-left-color: var(--accent-red); }

    .indicator-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 5px 10px; border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 11px;
    }
    .indicator-label { color: var(--text-dim); }
    .indicator-value { font-family: var(--font-data); font-weight: 600; font-size: 11px; }
    .indicator-signal {
      font-size: 8px; padding: 2px 5px; border-radius: 3px;
      text-transform: uppercase; font-weight: 700;
    }
    .signal-buy { background: rgba(0,255,136,0.2); color: var(--accent-green); }
    .signal-sell { background: rgba(255,68,102,0.2); color: var(--accent-red); }
    .signal-neutral { background: rgba(255,255,255,0.1); color: var(--text-dim); }
    .signal-warning { background: rgba(255,149,0,0.2); color: var(--accent-orange); }

    .prediction-box {
      text-align: center; padding: 12px;
      border: 1px solid rgba(0, 212, 255, 0.3);
      background: rgba(0, 212, 255, 0.05);
      margin: 8px; border-radius: 4px;
    }

    .score-meter {
      height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px;
      margin: 8px 10px; overflow: hidden; position: relative;
    }
    .score-fill {
      height: 100%; border-radius: 3px; transition: all 0.5s ease;
      position: absolute; left: 50%;
    }

    .wall-indicator {
      font-size: 9px; padding: 3px 6px; margin: 2px 6px;
      background: rgba(168, 85, 247, 0.15); border-radius: 3px;
      border-left: 2px solid var(--accent-purple);
    }

    .alert-item {
      font-size: 10px; padding: 6px 10px; margin: 3px 8px;
      border-radius: 4px; font-family: var(--font-data);
      animation: alertPulse 0.5s ease;
    }
    .alert-bullish { background: rgba(0,255,136,0.15); border-left: 3px solid var(--accent-green); }
    .alert-bearish { background: rgba(255,68,102,0.15); border-left: 3px solid var(--accent-red); }
    .alert-warning { background: rgba(255,149,0,0.15); border-left: 3px solid var(--accent-orange); }
    .alert-info { background: rgba(0,212,255,0.15); border-left: 3px solid var(--accent-cyan); }

    @keyframes alertPulse {
      0% { opacity: 0; transform: translateX(-10px); }
      100% { opacity: 1; transform: translateX(0); }
    }

    .divergence-badge {
      position: absolute; top: 8px; right: 8px;
      font-size: 9px; padding: 3px 8px; border-radius: 3px;
      font-family: var(--font-data); font-weight: 700;
      animation: pulse 2s infinite;
    }
    .div-bullish { background: var(--accent-green); color: #000; }
    .div-bearish { background: var(--accent-red); color: #fff; }

    .pattern-tag {
      display: inline-block; font-size: 9px; padding: 2px 6px;
      margin: 2px; border-radius: 3px; background: rgba(168,85,247,0.2);
      color: var(--accent-purple); font-family: var(--font-data);
    }

    .accuracy-bar {
      height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px;
      overflow: hidden; margin-top: 5px;
    }
    .accuracy-fill { height: 100%; background: var(--accent-cyan); transition: width 0.5s; }

    .derivatives-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 5px;
      padding: 8px; font-size: 10px;
    }
    .deriv-item {
      background: rgba(0,0,0,0.2); padding: 6px 8px; border-radius: 3px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .deriv-label { color: var(--text-dim); font-size: 9px; }
    .deriv-value { font-family: var(--font-data); font-size: 13px; font-weight: 600; margin-top: 2px; }

    .etf-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 4px;
      font-size: 10px;
    }
    .etf-item {
      background: rgba(0,0,0,0.2); padding: 5px 7px; border-radius: 3px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .etf-label { color: var(--text-dim); font-size: 8px; text-transform: uppercase; }
    .etf-value { font-family: var(--font-data); font-size: 11px; font-weight: 600; margin-top: 2px; }

    .c-green { color: var(--accent-green); }
    .c-red { color: var(--accent-red); }
    .c-orange { color: var(--accent-orange); }
    .c-purple { color: var(--accent-purple); }
    .c-cyan { color: var(--accent-cyan); }

    .scrollable { overflow-y: auto; flex: 1; }
    .scrollable::-webkit-scrollbar { width: 4px; }
    .scrollable::-webkit-scrollbar-track { background: transparent; }
    .scrollable::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .pulse { animation: pulse 2s infinite; }

    .tab-buttons {
      display: flex; gap: 5px; padding: 5px 8px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .tab-btn {
      font-size: 9px; padding: 3px 8px; border: none;
      background: rgba(255,255,255,0.05); color: var(--text-dim);
      border-radius: 3px; cursor: pointer; font-family: var(--font-tech);
    }
    .tab-btn.active { background: var(--accent-cyan); color: #000; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ============================================
       PWA INSTALL BANNER
       ============================================ */
    .pwa-install-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #0d1829 0%, #1a0a2e 100%);
      border-top: 1px solid rgba(0, 212, 255, 0.3);
      padding: 15px 20px;
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      z-index: 10000;
      box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.3s ease;
    }
    .pwa-install-banner.show { display: flex; }
    
    @keyframes slideUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .pwa-install-content {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 1;
    }
    
    .pwa-install-icon {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 900;
      color: #000;
      font-family: var(--font-tech);
      transform: rotate(45deg);
    }
    .pwa-install-icon span { transform: rotate(-45deg); }
    
    .pwa-install-text h4 {
      font-family: var(--font-tech);
      font-size: 14px;
      color: var(--accent-cyan);
      margin-bottom: 3px;
    }
    .pwa-install-text p {
      font-size: 12px;
      color: var(--text-dim);
    }
    
    .pwa-install-btn {
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      color: #000;
      font-family: var(--font-tech);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .pwa-install-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
    }
    
    .pwa-install-close {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
    }
    .pwa-install-close:hover { color: var(--accent-red); }

    /* iOS Install Instructions Modal */
    .ios-install-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10001;
      padding: 20px;
    }
    .ios-install-modal.show { display: flex; }
    
    .ios-install-content {
      background: linear-gradient(180deg, #0d1829 0%, #061018 100%);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 20px;
      padding: 30px;
      max-width: 350px;
      text-align: center;
    }
    
    .ios-install-content h3 {
      font-family: var(--font-tech);
      color: var(--accent-cyan);
      margin-bottom: 20px;
    }
    
    .ios-step {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      margin-bottom: 10px;
      text-align: left;
    }
    
    .ios-step-num {
      width: 30px;
      height: 30px;
      background: var(--accent-cyan);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #000;
      flex-shrink: 0;
    }
    
    .ios-step-text {
      font-size: 13px;
      color: var(--text-main);
    }
    
    .ios-step-icon {
      font-size: 20px;
    }

    /* ============================================
       MOBILE RESPONSIVE STYLES
       ============================================ */
    @media screen and (max-width: 1200px) {
      main {
        grid-template-columns: 280px 1fr 280px;
      }
      .kpi-card { padding: 8px; }
      .kpi-val { font-size: 18px; }
    }

    @media screen and (max-width: 992px) {
      main {
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        padding: 10px;
        gap: 10px;
      }
      
      .metrics-wrapper {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        order: 1;
      }
      
      .kpi-card {
        padding: 10px;
      }
      
      .chart-box {
        order: 2;
        height: 300px;
        min-height: 300px;
        grid-column: auto;
        grid-row: auto;
      }
      
      .side-left, .side-right {
        order: 3;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .bottom-box {
        order: 4;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      
      .panel { min-height: auto; }
      
      header {
        flex-wrap: wrap;
        height: auto;
        padding: 10px;
        gap: 10px;
      }
      
      .header-center {
        order: 3;
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .brand { order: 1; }
      .header-controls { order: 2; }
      .status-pill { order: 4; }
    }

    @media screen and (max-width: 768px) {
      .metrics-wrapper {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .chart-box {
        height: 280px;
        min-height: 280px;
      }
      
      .side-left, .side-right {
        grid-template-columns: 1fr;
      }
      
      .bottom-box {
        grid-template-columns: 1fr;
      }
      
      .brand h1 { font-size: 14px; }
      
      .header-controls {
        gap: 5px;
      }
      
      .control-btn {
        padding: 4px 8px;
        font-size: 9px;
      }
      
      .header-stat {
        padding: 3px 6px;
        font-size: 9px;
      }
      
      .tools-panel {
        width: 95vw;
        max-height: 90vh;
        margin: 10px;
      }
      
      .tools-tabs {
        flex-wrap: wrap;
        gap: 5px;
      }
      
      .tools-tab {
        padding: 8px 12px;
        font-size: 10px;
      }
      
      .mtf-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .risk-grid,
      .fibo-container,
      .alerts-container,
      .strategy-container,
      .corr-grid {
        grid-template-columns: 1fr;
      }
      
      .watchlist-grid {
        grid-template-columns: 1fr;
      }
      
      .session-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media screen and (max-width: 480px) {
      .metrics-wrapper {
        grid-template-columns: 1fr 1fr;
      }
      
      .kpi-card {
        padding: 8px;
      }
      
      .kpi-lbl { font-size: 8px; }
      .kpi-val { font-size: 16px; }
      .kpi-sub { font-size: 9px; }
      
      .chart-box {
        height: 220px;
        min-height: 220px;
      }
      
      .brand h1 {
        font-size: 12px;
        letter-spacing: 1px;
      }
      
      .header-center {
        display: none;
      }
      
      .panel-head {
        font-size: 10px;
        padding: 8px;
      }
      
      .mtf-grid {
        grid-template-columns: 1fr;
      }
      
      .ob-row {
        font-size: 9px;
      }
      
      .alert-item {
        font-size: 9px;
        padding: 5px 8px;
      }
    }

    /* PWA Standalone Mode Adjustments */
    @media all and (display-mode: standalone) {
      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }
      
      header {
        padding-top: calc(10px + env(safe-area-inset-top));
      }
      
      .pwa-install-banner {
        display: none !important;
      }
    }

    /* Landscape mobile */
    @media screen and (max-height: 500px) and (orientation: landscape) {
      header { height: 45px; padding: 5px 10px; }
      .brand h1 { font-size: 12px; }
      .metrics-wrapper { display: none; }
      main { padding: 5px; }
      .chart-box { height: calc(100vh - 60px); }
    }

  </style>
</head>
<body>

  <div class="grid-bg"></div>

  <header>
    <div class="brand">
      <div style="width:15px; height:15px; background:var(--accent-cyan); transform:rotate(45deg);"></div>
      <h1>XRP ORACULUM <span style="opacity:0.5; font-weight:300">OkrtSystem Labs</span></h1>
    </div>
    <div class="header-center">
      <div class="header-stat">
        <span>BTC:</span> <span id="btcPrice" class="c-cyan">--</span>
      </div>
      <div class="header-stat">
        <span>ETF AUM:</span> <span id="etfAum" class="c-green">$1.41B</span>
      </div>
      <div class="header-stat">
        <span>XRP Locked:</span> <span id="xrpLocked" class="c-purple">746.3M</span>
      </div>
      <div class="header-stat">
        <span>Accuracy:</span> <span id="accuracyPct" class="c-green">--%</span>
      </div>
    </div>
    
    <!-- CONTROLES -->
    <div class="header-controls">
      <select id="timeframeSelect" class="timeframe-select" title="Timeframe">
        <option value="1m">1m</option>
        <option value="5m">5m</option>
        <option value="15m">15m</option>
        <option value="1h">1h</option>
        <option value="4h">4h</option>
      </select>
      <button id="soundBtn" class="control-btn" onclick="toggleSound()" title="Sound Alerts">
        üîá OFF
      </button>
      <button id="themeBtn" class="control-btn" onclick="toggleTheme()" title="Toggle Theme">
        ‚òÄÔ∏è
      </button>
      <button class="control-btn" onclick="exportData()" title="Export CSV">
        üì• CSV
      </button>
      <button id="toolsBtn" class="control-btn" onclick="toggleToolsPanel()" title="Trading Tools" style="background:linear-gradient(135deg, rgba(0,212,255,0.2), rgba(168,85,247,0.2)); border-color:var(--accent-cyan);">
        üõ†Ô∏è TOOLS
      </button>
    </div>
    
    <div class="status-pill" id="statusPill">
      <div class="status-dot"></div>
      <span id="apiStatusText">INITIALIZING...</span>
      <span id="clock" style="margin-left:10px; color:#fff;">00:00:00</span>
    </div>
  </header>

  <main>
    <!-- KPIs TOP -->
    <div class="metrics-wrapper">
      <div class="kpi-card">
        <span class="kpi-lbl">XRP/USDT</span>
        <span id="priceDisplay" class="kpi-val">--.----</span>
        <span id="priceChange" class="kpi-sub">--</span>
      </div>
      <div class="kpi-card">
        <span class="kpi-lbl">24H VOL</span>
        <span id="volDisplay" class="kpi-val">--</span>
        <span class="kpi-sub">USDT</span>
      </div>
      <div class="kpi-card">
        <span class="kpi-lbl">FEAR & GREED</span>
        <span id="fgIndex" class="kpi-val" style="color:#f4b942">--</span>
        <span id="fgLabel" class="kpi-sub">Loading...</span>
      </div>
      <div class="kpi-card">
        <span class="kpi-lbl">FUNDING RATE</span>
        <span id="fundingRate" class="kpi-val c-cyan">--</span>
        <span id="fundingLabel" class="kpi-sub">8h</span>
      </div>
      <div class="kpi-card">
        <span class="kpi-lbl">OPEN INTEREST</span>
        <span id="openInterest" class="kpi-val c-purple">--</span>
        <span id="oiChange" class="kpi-sub">--</span>
      </div>
      <div class="kpi-card">
        <span class="kpi-lbl">MARKET SCORE</span>
        <span id="totalScore" class="kpi-val">--</span>
        <span id="scoreLabel" class="kpi-sub">Calculating...</span>
      </div>
    </div>

    <!-- SIDEBAR IZQUIERDA -->
    <div class="side-left">
      <div class="panel" style="flex:1.3">
        <div class="panel-head">
          üß† PREDICTIVE ENGINE V3 
          <span class="pulse" style="color:var(--accent-green)">‚óè</span>
        </div>
        
        <div class="prediction-box">
          <div style="font-size:9px; text-transform:uppercase; color:var(--text-dim)">Ensemble Target (5min)</div>
          <div id="aiTarget" style="font-size:26px; font-weight:bold; color:var(--accent-cyan); margin:4px 0;">Calculating...</div>
          <div style="font-size:10px;">
            Confidence: <span id="confLevel" style="color:var(--accent-green)">--%</span>
            <span style="margin-left:10px;">Accuracy: <span id="modelAccuracy">--%</span></span>
          </div>
          <div class="accuracy-bar"><div id="accuracyBar" class="accuracy-fill" style="width:0%"></div></div>
          
          <!-- Mini gr√°fico de historial de predicciones -->
          <div style="margin-top:5px;">
            <div style="font-size:8px; color:var(--text-dim); margin-bottom:3px; padding:0 5px;">PREDICTION HISTORY (Last 20)</div>
            <div id="accuracyHistoryChart" class="accuracy-chart"></div>
          </div>
        </div>

        <div class="score-meter">
          <div id="scoreFill" class="score-fill" style="width:0; background:var(--accent-cyan);"></div>
        </div>
        <div style="text-align:center; font-size:9px; color:var(--text-dim); margin-bottom:5px;">
          <span style="float:left; margin-left:10px;">BEAR</span>
          <span style="float:right; margin-right:10px;">BULL</span>
          <span>NEUTRAL</span>
        </div>

        <!-- Tabs para indicadores -->
        <div class="tab-buttons">
          <button class="tab-btn active" onclick="switchTab('momentum')">MOMENTUM</button>
          <button class="tab-btn" onclick="switchTab('trend')">TREND</button>
          <button class="tab-btn" onclick="switchTab('volume')">VOLUME</button>
        </div>

        <div class="scrollable">
          <!-- TAB: Momentum -->
          <div id="tab-momentum" class="tab-content active">
            <div class="indicator-row">
              <span class="indicator-label">RSI (14)</span>
              <span id="rsiValue" class="indicator-value">--</span>
              <span id="rsiSignal" class="indicator-signal signal-neutral">--</span>
            </div>
            <div class="indicator-row">
              <span class="indicator-label">Stoch RSI</span>
              <span id="stochValue" class="indicator-value">--</span>
              <span id="stochSignal" class="indicator-signal signal-neutral">--</span>
            </div>
            <div class="indicator-row">
              <span class="indicator-label">Williams %R</span>
              <span id="willrValue" class="indicator-value">--</span>
              <span id="willrSignal" class="indicator-signal signal-neutral">--</span>
            </div>
            <div class="indicator-row">
              <span class="indicator-label">Momentum</span>
              <span id="momValue" class="indicator-value">--</span>
              <span id="momSignal" class="indicator-signal signal-neutral">--</span>
            </div>
            <div class="indicator-row">
              <span class="indicator-label">RSI Divergence</span>
              <span id="divValue" class="indicator-value">--</span>
              <span id="divSignal" class="indicator-signal signal-neutral">--</span>
            </div>
          </div>

          <!-- TAB: Trend -->
          <div id="tab-trend" class="tab-content">
            <div class="indicator-row">
              <span class="indicator-label">MACD</span>
              <span id="macdValue" class="indicator-value">--</span>
              <span id="macdSignal" class="indicator-signal signal-neutral">--</span>
            </div>
            <div class="indicator-row">
              <span class="indicator-label">EMA Cross</span>
              <span id="emaValue" class="indicator-value">--</span>
              <span id="emaSignal" class="indicator-signal signal-neutral">--</span>
            </div>
            <div class="indicator-row">
              <span class="indicator-label">ADX</span>
              <span id="adxValue" class="indicator-value">--</span>
              <span id="adxSignal" class="indicator-signal signal-neutral">--</span>
            </div>
            <div class="indicator-row">
              <span class="indicator-label">Bollinger</span>
              <span id="bbValue" class="indicator-value">--</span>
              <span id="bbSignal" class="indicator-signal signal-neutral">--</span>
            </div>
            <div class="indicator-row">
              <span class="indicator-label">VWAP</span>
              <span id="vwapValue" class="indicator-value">--</span>
              <span id="vwapSignal" class="indicator-signal signal-neutral">--</span>
            </div>
          </div>

          <!-- TAB: Volume -->
          <div id="tab-volume" class="tab-content">
            <div class="indicator-row">
              <span class="indicator-label">OBV Trend</span>
              <span id="obvValue" class="indicator-value">--</span>
              <span id="obvSignal" class="indicator-signal signal-neutral">--</span>
            </div>
            <div class="indicator-row">
              <span class="indicator-label">OB Imbalance</span>
              <span id="obValue" class="indicator-value">--</span>
              <span id="obSignal" class="indicator-signal signal-neutral">--</span>
            </div>
            <div class="indicator-row">
              <span class="indicator-label">CVD</span>
              <span id="cvdValue" class="indicator-value">--</span>
              <span id="cvdSignal" class="indicator-signal signal-neutral">--</span>
            </div>
            <div class="indicator-row">
              <span class="indicator-label">Long/Short</span>
              <span id="lsValue" class="indicator-value">--</span>
              <span id="lsSignal" class="indicator-signal signal-neutral">--</span>
            </div>
            <div class="indicator-row">
              <span class="indicator-label">Whale Flow</span>
              <span id="whaleFlowValue" class="indicator-value">--</span>
              <span id="whaleFlowSignal" class="indicator-signal signal-neutral">--</span>
            </div>
          </div>

          <!-- Patterns Detected -->
          <div style="padding:8px 10px; border-top:1px solid rgba(255,255,255,0.05);">
            <div style="font-size:9px; color:var(--text-dim); margin-bottom:5px;">PATTERNS DETECTED</div>
            <div id="patternsContainer">
              <span style="color:var(--text-dim); font-size:10px;">Analyzing...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- XRP ETF DATA -->
      <div class="panel" style="flex:1; min-height:220px;">
        <div class="panel-head">
          üìà XRP ETF TRACKER 
          <span style="background:var(--accent-green); color:#000; padding:1px 6px; border-radius:3px; font-size:8px;">LIVE</span>
        </div>
        
        <!-- Main Stats -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; padding:8px;">
          <div style="background:rgba(0,255,136,0.1); border:1px solid rgba(0,255,136,0.3); padding:8px; border-radius:4px; text-align:center;">
            <div style="font-size:8px; color:var(--text-dim);">TOTAL AUM</div>
            <div id="etfTotalAum" style="font-size:18px; font-weight:bold; color:var(--accent-green); font-family:var(--font-data);">$1.41B</div>
          </div>
          <div style="background:rgba(168,85,247,0.1); border:1px solid rgba(168,85,247,0.3); padding:8px; border-radius:4px; text-align:center;">
            <div style="font-size:8px; color:var(--text-dim);">XRP LOCKED</div>
            <div id="etfXrpLocked" style="font-size:18px; font-weight:bold; color:var(--accent-purple); font-family:var(--font-data);">746.3M</div>
          </div>
        </div>
        
        <!-- Progress to 1B -->
        <div style="padding:0 8px 8px 8px;">
          <div style="display:flex; justify-content:space-between; font-size:8px; color:var(--text-dim); margin-bottom:3px;">
            <span>Progress to 1B XRP</span>
            <span id="etfSupplyPct">74.6%</span>
          </div>
          <div style="height:6px; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden;">
            <div id="etfProgressBar" style="height:100%; width:74.6%; background:linear-gradient(90deg, var(--accent-purple), var(--accent-cyan)); border-radius:3px;"></div>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:7px; color:var(--text-dim); margin-top:2px;">
            <span>0</span>
            <span>0.746% of 100B supply</span>
            <span>1B</span>
          </div>
        </div>
        
        <!-- ETF List -->
        <div class="scrollable" style="padding:0 8px 8px 8px; font-size:9px;">
          <div style="display:grid; grid-template-columns:1fr auto auto; gap:5px; padding:4px 0; border-bottom:1px solid rgba(255,255,255,0.05);">
            <span style="color:var(--text-dim);">TICKER / ENTITY</span>
            <span style="color:var(--text-dim); text-align:right;">AUM</span>
            <span style="color:var(--text-dim); text-align:right;">XRP</span>
          </div>
          <div style="display:grid; grid-template-columns:1fr auto auto; gap:5px; padding:4px 0; border-bottom:1px solid rgba(255,255,255,0.03);">
            <span><span class="c-cyan">‚óè</span> <strong>XRPC</strong> <span style="color:var(--accent-orange); font-size:9px;">Canary</span></span>
            <span class="c-green" style="text-align:right;">$328.5M</span>
            <span style="color:var(--text-dim); text-align:right;">176.2M</span>
          </div>
          <div style="display:grid; grid-template-columns:1fr auto auto; gap:5px; padding:4px 0; border-bottom:1px solid rgba(255,255,255,0.03);">
            <span><span class="c-cyan">‚óè</span> <strong>TOXR</strong> <span style="color:var(--accent-orange); font-size:9px;">21Shares</span></span>
            <span class="c-green" style="text-align:right;">$257.2M</span>
            <span style="color:var(--text-dim); text-align:right;">135.7M</span>
          </div>
          <div style="display:grid; grid-template-columns:1fr auto auto; gap:5px; padding:4px 0; border-bottom:1px solid rgba(255,255,255,0.03);">
            <span><span class="c-cyan">‚óè</span> <strong>XRP</strong> <span style="color:var(--accent-orange); font-size:9px;">Bitwise</span></span>
            <span class="c-green" style="text-align:right;">$233.0M</span>
            <span style="color:var(--text-dim); text-align:right;">122.8M</span>
          </div>
          <div style="display:grid; grid-template-columns:1fr auto auto; gap:5px; padding:4px 0; border-bottom:1px solid rgba(255,255,255,0.03);">
            <span><span class="c-purple">‚óè</span> <strong>GXRP</strong> <span style="color:var(--accent-orange); font-size:9px;">Grayscale</span></span>
            <span class="c-green" style="text-align:right;">$228.3M</span>
            <span style="color:var(--text-dim); text-align:right;">121.5M</span>
          </div>
          <div style="display:grid; grid-template-columns:1fr auto auto; gap:5px; padding:4px 0; border-bottom:1px solid rgba(255,255,255,0.03);">
            <span><span class="c-purple">‚óè</span> <strong>XRPZ</strong> <span style="color:var(--accent-orange); font-size:9px;">Franklin</span></span>
            <span class="c-green" style="text-align:right;">$208.6M</span>
            <span style="color:var(--text-dim); text-align:right;">111.9M</span>
          </div>
          <div style="display:grid; grid-template-columns:1fr auto auto; gap:5px; padding:4px 0; border-bottom:1px solid rgba(255,255,255,0.03);">
            <span><span class="c-orange">‚óè</span> <strong>XRPR</strong> <span style="color:var(--accent-orange); font-size:9px;">REX-Osprey</span></span>
            <span class="c-green" style="text-align:right;">$101.4M</span>
            <span style="color:var(--text-dim); text-align:right;">50.7M</span>
          </div>
          <div style="display:grid; grid-template-columns:1fr auto auto; gap:5px; padding:4px 0;">
            <span><span style="color:var(--text-dim);">‚óè</span> <strong>BITW</strong> <span style="color:var(--accent-orange); font-size:9px;">Bitwise Idx</span></span>
            <span class="c-green" style="text-align:right;">$52.3M</span>
            <span style="color:var(--text-dim); text-align:right;">27.5M</span>
          </div>
        </div>
      </div>
    </div>

    <!-- GR√ÅFICO CENTRAL -->
    <div class="panel chart-box">
      <div class="panel-head">
        XRPUSDT ‚Ä¢ 1m 
        <span style="color:var(--accent-cyan)">TradingView</span>
      </div>
      <div id="divergenceBadge" class="divergence-badge" style="display:none;"></div>
      <div id="chartContainer"></div>
    </div>

    <!-- SIDEBAR DERECHA -->
    <div class="side-right">
      <!-- ALERTS -->
      <div class="panel" style="height:180px">
        <div class="panel-head">
          üö® SMART ALERTS 
          <span id="alertCount" style="background:var(--accent-red); color:#fff; padding:1px 6px; border-radius:10px; font-size:9px;">0</span>
        </div>
        <div id="alertsContainer" class="scrollable" style="padding:5px 0;"></div>
      </div>

      <!-- ORDER BOOK -->
      <div class="panel" style="flex:1">
        <div class="panel-head">üìä ORDER BOOK <span id="spoofWarning" style="display:none; color:var(--accent-orange);">‚ö† SPOOF</span></div>
        <div style="padding:3px 0; font-size:9px; color:var(--text-dim); text-align:center; border-bottom:1px solid rgba(255,255,255,0.05);">
          ASK (SELL)
        </div>
        <div id="askSide" style="flex:1; overflow:hidden;"></div>
        
        <div style="padding:6px; text-align:center; background:rgba(0,212,255,0.1); border-top:1px solid rgba(0,212,255,0.3); border-bottom:1px solid rgba(0,212,255,0.3);">
          <span style="font-family:var(--font-data); font-size:15px; font-weight:bold;" id="midPrice">--</span>
        </div>
        
        <div id="bidSide" style="flex:1; overflow:hidden;"></div>
        <div style="padding:3px 0; font-size:9px; color:var(--text-dim); text-align:center; border-top:1px solid rgba(255,255,255,0.05);">
          BID (BUY)
        </div>
        <div id="wallDetection" style="padding:3px;"></div>
      </div>

      <!-- WHALE TRACKER + ETF DATA -->
      <div class="panel" style="height:160px">
        <div class="panel-head">
          <span>üêã WHALES / üìä ETF FLOW</span>
          <span id="whaleCount" style="background:var(--accent-purple); padding:1px 6px; border-radius:10px; font-size:9px;">0</span>
        </div>
        
        <!-- Tabs para Whales y ETF -->
        <div class="tab-buttons" style="padding:3px 5px;">
          <button class="tab-btn active" onclick="switchWhaleTab('whales')">WHALES</button>
          <button class="tab-btn" onclick="switchWhaleTab('etf')">ETF DATA</button>
        </div>
        
        <!-- Tab: Whales -->
        <div id="tab-whales" class="tab-content active scrollable" style="padding:3px 0;">
          <div id="whaleList">
            <div style="padding:10px; text-align:center; color:var(--text-dim); font-size:10px;">
              Monitoring large trades...<br>
              <span style="font-size:9px; opacity:0.6;">Trades >5K XRP will appear here</span>
            </div>
          </div>
        </div>
        
        <!-- Tab: XRP ETF Data -->
        <div id="tab-etf" class="tab-content" style="padding:5px;">
          <div class="etf-grid">
            <div class="etf-item">
              <div class="etf-label">XRP ETF AUM</div>
              <div class="etf-value c-green">$1.41B</div>
            </div>
            <div class="etf-item">
              <div class="etf-label">XRP Locked</div>
              <div class="etf-value c-purple">746.3M</div>
            </div>
            <div class="etf-item">
              <div class="etf-label">Active ETFs</div>
              <div class="etf-value c-cyan">7</div>
            </div>
            <div class="etf-item">
              <div class="etf-label">% of Supply</div>
              <div class="etf-value">0.746%</div>
            </div>
          </div>
          <div style="margin-top:5px; padding:4px 6px; background:rgba(0,255,136,0.1); border-radius:3px; font-size:9px; color:var(--text-dim);">
            <span class="c-green">‚óè</span> LIVE: XRPC, TOXR, XRP, GXRP, XRPZ, XRPR, BITW
          </div>
        </div>
      </div>
    </div>

    <!-- BOTTOM -->
    <div class="bottom-box">
      <div class="panel">
        <div class="panel-head">üìà SIGNAL CONSENSUS</div>
        <div style="padding:10px;">
          <div style="display:flex; justify-content:space-around; text-align:center;">
            <div>
              <div style="font-size:9px; color:var(--text-dim);">BULLISH</div>
              <div id="bullCount" style="font-size:22px; font-weight:bold; color:var(--accent-green);">0</div>
            </div>
            <div>
              <div style="font-size:9px; color:var(--text-dim);">NEUTRAL</div>
              <div id="neutCount" style="font-size:22px; font-weight:bold; color:var(--text-dim);">0</div>
            </div>
            <div>
              <div style="font-size:9px; color:var(--text-dim);">BEARISH</div>
              <div id="bearCount" style="font-size:22px; font-weight:bold; color:var(--accent-red);">0</div>
            </div>
          </div>
          <div style="margin-top:10px; text-align:center;">
            <span id="consensus" style="font-size:14px; font-weight:bold;">ANALYZING...</span>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">üéØ TRADE LEVELS (ATR)</div>
        <div style="padding:10px; font-family:var(--font-data); font-size:11px;">
          <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span style="color:var(--text-dim);">R2:</span>
            <span id="r2" class="c-red">--</span>
          </div>
          <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span style="color:var(--text-dim);">R1:</span>
            <span id="r1" class="c-red">--</span>
          </div>
          <div style="display:flex; justify-content:space-between; margin-bottom:5px; padding:4px; background:rgba(0,212,255,0.1); border-radius:3px;">
            <span class="c-cyan">Current:</span>
            <span id="currentLevel" class="c-cyan">--</span>
          </div>
          <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span style="color:var(--text-dim);">S1:</span>
            <span id="s1" class="c-green">--</span>
          </div>
          <div style="display:flex; justify-content:space-between;">
            <span style="color:var(--text-dim);">S2:</span>
            <span id="s2" class="c-green">--</span>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">‚ö° LIQUIDITY FLOW</div>
        <div style="padding:10px;">
          <div style="display:flex; height:16px; border-radius:3px; overflow:hidden; margin-bottom:8px;">
            <div id="liqBarBid" style="background:var(--accent-green); height:100%; transition:width 0.3s;"></div>
            <div id="liqBarAsk" style="background:var(--accent-red); height:100%; transition:width 0.3s;"></div>
          </div>
          <div id="liqText" style="font-size:10px; color:var(--text-dim); line-height:1.5;"></div>
          <div id="cvdText" style="font-size:10px; color:var(--text-dim); margin-top:5px;"></div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
  
  <script>
    // ============================================
    // XRP ORACULUM V3 - ADVANCED ENGINE
    // ============================================

    const CONFIG = {
      WHALE_THRESHOLD: 5000,       // 5K XRP (~$9K USD) para ver m√°s actividad
      WALL_THRESHOLD: 50000,       // 50K para paredes
      SPOOF_THRESHOLD: 200000,     // 200K para spoof detection
      HISTORY_SIZE: 100,
      ATR_PERIOD: 14,
      RSI_PERIOD: 14,
      MACD_FAST: 12,
      MACD_SLOW: 26,
      MACD_SIGNAL: 9,
      EMA_FAST: 9,
      EMA_SLOW: 21,
      STOCH_PERIOD: 14,
      BB_PERIOD: 20,
      BB_STD: 2,
      ADX_PERIOD: 14,
      WILLR_PERIOD: 14
    };

    const state = {
      candles: [],
      currentPrice: 0,
      btcPrice: 0,
      whaleCount: 0,
      cvd: 0,
      whaleBuyVol: 0,
      whaleSellVol: 0,
      predictions: [],
      alertCount: 0,
      lastOrderBook: { bids: [], asks: [] },
      obvHistory: [],
      priceHistory: [],
      rsiHistory: [],
      // Nuevas variables para funcionalidades
      soundEnabled: false,
      currentTimeframe: '1m',
      predictionHistory: [],  // Historial de aciertos/fallos
      exportData: []          // Datos para exportar
    };

    // --- AUDIO CONTEXT para alertas sonoras ---
    let audioCtx = null;
    
    function initAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
    }
    
    function playSound(type = 'alert') {
      if (!state.soundEnabled || !audioCtx) return;
      
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      
      if (type === 'bullish') {
        oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // A5
        oscillator.frequency.setValueAtTime(1108, audioCtx.currentTime + 0.1); // C#6
      } else if (type === 'bearish') {
        oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // A4
        oscillator.frequency.setValueAtTime(330, audioCtx.currentTime + 0.1); // E4
      } else if (type === 'whale') {
        oscillator.frequency.setValueAtTime(220, audioCtx.currentTime); // A3 deep
        oscillator.type = 'sawtooth';
      } else {
        oscillator.frequency.setValueAtTime(660, audioCtx.currentTime); // E5
      }
      
      gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
      
      oscillator.start(audioCtx.currentTime);
      oscillator.stop(audioCtx.currentTime + 0.3);
    }

    // --- TOGGLE FUNCIONES ---
    function toggleSound() {
      initAudio();
      state.soundEnabled = !state.soundEnabled;
      const btn = document.getElementById('soundBtn');
      if (state.soundEnabled) {
        btn.innerHTML = 'üîä ON';
        btn.classList.add('active');
        playSound('alert'); // Sonido de confirmaci√≥n
      } else {
        btn.innerHTML = 'üîá OFF';
        btn.classList.remove('active');
      }
    }
    
    function toggleTheme() {
      document.body.classList.toggle('light-mode');
      const btn = document.getElementById('themeBtn');
      if (document.body.classList.contains('light-mode')) {
        btn.innerHTML = 'üåô';
      } else {
        btn.innerHTML = '‚òÄÔ∏è';
      }
    }

    // --- TIMEFRAME CHANGE ---
    function changeTimeframe(tf) {
      state.currentTimeframe = tf;
      state.candles = [];
      state.priceHistory = [];
      state.rsiHistory = [];
      state.obvHistory = [];
      
      // Reconectar WebSocket con nuevo timeframe
      if (ws) ws.close();
      fetchHistoricalData();
      connectAPI();
      
      addAlert(`Timeframe changed to ${tf}`, 'info');
    }

    // --- EXPORT DATA TO CSV ---
    function exportData() {
      if (state.candles.length === 0) {
        alert('No data to export yet!');
        return;
      }
      
      // Preparar datos
      let csv = 'Timestamp,Open,High,Low,Close,Volume,RSI,Prediction,Actual,Correct\\n';
      
      state.predictions.forEach((pred, idx) => {
        const candle = state.candles[idx] || {};
        const correct = pred.correct !== undefined ? (pred.correct ? 'YES' : 'NO') : 'PENDING';
        csv += `${new Date(pred.timestamp).toISOString()},`;
        csv += `${candle.open || ''},${candle.high || ''},${candle.low || ''},${candle.close || ''},${candle.volume || ''},`;
        csv += `${pred.rsi || ''},${pred.target.toFixed(6)},${pred.actual.toFixed(6)},${correct}\\n`;
      });
      
      // Crear y descargar archivo
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `XRP_ORACULUM_${state.currentTimeframe}_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      addAlert('Data exported to CSV', 'info');
    }

    // --- UPDATE PREDICTION HISTORY CHART ---
    function updatePredictionHistoryChart() {
      const container = document.getElementById('accuracyHistoryChart');
      if (!container) return;
      
      container.innerHTML = '';
      
      // Mostrar √∫ltimas 20 predicciones
      const history = state.predictionHistory.slice(-20);
      
      if (history.length === 0) {
        container.innerHTML = '<span style="font-size:8px; color:var(--text-dim);">Collecting data...</span>';
        return;
      }
      
      history.forEach((result, idx) => {
        const bar = document.createElement('div');
        bar.className = 'accuracy-bar-mini';
        bar.style.height = '100%';
        bar.style.background = result ? 'var(--accent-green)' : 'var(--accent-red)';
        bar.style.opacity = 0.3 + (idx / history.length) * 0.7; // M√°s recientes m√°s brillantes
        bar.title = result ? 'Correct' : 'Incorrect';
        container.appendChild(bar);
      });
    }

    // --- UI REFS ---
    const ui = {
      statusPill: document.getElementById('statusPill'),
      statusText: document.getElementById('apiStatusText'),
      clock: document.getElementById('clock'),
      price: document.getElementById('priceDisplay'),
      priceChange: document.getElementById('priceChange'),
      volume: document.getElementById('volDisplay'),
      fg: document.getElementById('fgIndex'),
      fgLabel: document.getElementById('fgLabel'),
      fundingRate: document.getElementById('fundingRate'),
      fundingLabel: document.getElementById('fundingLabel'),
      openInterest: document.getElementById('openInterest'),
      oiChange: document.getElementById('oiChange'),
      totalScore: document.getElementById('totalScore'),
      scoreLabel: document.getElementById('scoreLabel'),
      aiTarget: document.getElementById('aiTarget'),
      conf: document.getElementById('confLevel'),
      modelAccuracy: document.getElementById('modelAccuracy'),
      accuracyBar: document.getElementById('accuracyBar'),
      accuracyPct: document.getElementById('accuracyPct'),
      scoreFill: document.getElementById('scoreFill'),
      bids: document.getElementById('bidSide'),
      asks: document.getElementById('askSide'),
      midPrice: document.getElementById('midPrice'),
      wallDetection: document.getElementById('wallDetection'),
      spoofWarning: document.getElementById('spoofWarning'),
      liqBarBid: document.getElementById('liqBarBid'),
      liqBarAsk: document.getElementById('liqBarAsk'),
      liqText: document.getElementById('liqText'),
      cvdText: document.getElementById('cvdText'),
      whaleList: document.getElementById('whaleList'),
      whaleCount: document.getElementById('whaleCount'),
      bullCount: document.getElementById('bullCount'),
      neutCount: document.getElementById('neutCount'),
      bearCount: document.getElementById('bearCount'),
      consensus: document.getElementById('consensus'),
      alertsContainer: document.getElementById('alertsContainer'),
      alertCount: document.getElementById('alertCount'),
      btcPrice: document.getElementById('btcPrice'),
      divergenceBadge: document.getElementById('divergenceBadge'),
      patternsContainer: document.getElementById('patternsContainer'),
      etfAum: document.getElementById('etfAum'),
      xrpLocked: document.getElementById('xrpLocked')
    };

    // --- TAB SWITCH ---
    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('tab-' + tabName).classList.add('active');
    }

    function switchWhaleTab(tabName) {
      const container = event.target.closest('.panel');
      container.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      container.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      container.querySelector('#tab-' + tabName).classList.add('active');
    }

    // --- CHART ---
    let chart, candleSeries, trendLineUp, trendLineDown;

    function initChart() {
      const container = document.getElementById('chartContainer');
      chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: container.clientHeight,
        layout: { background: { type: 'solid', color: 'transparent' }, textColor: '#94a3b8' },
        grid: { vertLines: { color: 'rgba(255,255,255,0.03)' }, horzLines: { color: 'rgba(255,255,255,0.03)' } },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
        rightPriceScale: { borderColor: 'rgba(255,255,255,0.1)' },
        timeScale: { borderColor: 'rgba(255,255,255,0.1)', timeVisible: true }
      });

      candleSeries = chart.addCandlestickSeries({
        upColor: '#00ff88', downColor: '#ff4466',
        borderUpColor: '#00ff88', borderDownColor: '#ff4466',
        wickUpColor: '#00ff88', wickDownColor: '#ff4466'
      });

      // L√≠nea de tendencia alcista (soporte)
      trendLineUp = chart.addLineSeries({
        color: '#00ff88',
        lineWidth: 2,
        lineStyle: 0, // Solid
        crosshairMarkerVisible: false,
        lastValueVisible: false,
        priceLineVisible: false,
      });

      // L√≠nea de tendencia bajista (resistencia)
      trendLineDown = chart.addLineSeries({
        color: '#ff4466',
        lineWidth: 2,
        lineStyle: 0, // Solid
        crosshairMarkerVisible: false,
        lastValueVisible: false,
        priceLineVisible: false,
      });

      new ResizeObserver(() => {
        chart.applyOptions({ width: container.clientWidth, height: container.clientHeight });
      }).observe(container);
    }

    // ============================================
    // AUTO TREND LINES
    // ============================================

    function findSwingPoints(candles, lookback = 5) {
      if (candles.length < lookback * 2 + 1) return { highs: [], lows: [] };
      
      const highs = [];
      const lows = [];
      
      for (let i = lookback; i < candles.length - lookback; i++) {
        let isSwingHigh = true;
        let isSwingLow = true;
        
        for (let j = 1; j <= lookback; j++) {
          if (candles[i].high <= candles[i - j].high || candles[i].high <= candles[i + j].high) {
            isSwingHigh = false;
          }
          if (candles[i].low >= candles[i - j].low || candles[i].low >= candles[i + j].low) {
            isSwingLow = false;
          }
        }
        
        if (isSwingHigh) {
          highs.push({ time: candles[i].time, value: candles[i].high });
        }
        if (isSwingLow) {
          lows.push({ time: candles[i].time, value: candles[i].low });
        }
      }
      
      return { highs, lows };
    }

    function calculateTrendLine(points) {
      if (points.length < 2) return null;
      
      // Tomar los √∫ltimos 2-3 puntos significativos
      const recentPoints = points.slice(-3);
      if (recentPoints.length < 2) return null;
      
      const p1 = recentPoints[0];
      const p2 = recentPoints[recentPoints.length - 1];
      
      // Calcular pendiente
      const timeDiff = p2.time - p1.time;
      if (timeDiff === 0) return null;
      
      const slope = (p2.value - p1.value) / timeDiff;
      
      // Extender la l√≠nea hacia el futuro
      const futureTime = p2.time + (timeDiff * 0.5);
      const futureValue = p2.value + (slope * timeDiff * 0.5);
      
      return [
        { time: p1.time, value: p1.value },
        { time: p2.time, value: p2.value },
        { time: futureTime, value: futureValue }
      ];
    }

    function updateTrendLines() {
      if (!state.candles || state.candles.length < 20) return;
      
      const { highs, lows } = findSwingPoints(state.candles, 3);
      
      // L√≠nea de soporte (conectando m√≠nimos ascendentes)
      const ascendingLows = lows.filter((p, i) => {
        if (i === 0) return true;
        return p.value >= lows[i - 1].value * 0.995; // Tolerancia del 0.5%
      });
      
      const supportLine = calculateTrendLine(ascendingLows);
      if (supportLine && trendLineUp) {
        try {
          trendLineUp.setData(supportLine);
        } catch (e) {}
      }
      
      // L√≠nea de resistencia (conectando m√°ximos descendentes)
      const descendingHighs = highs.filter((p, i) => {
        if (i === 0) return true;
        return p.value <= highs[i - 1].value * 1.005; // Tolerancia del 0.5%
      });
      
      const resistanceLine = calculateTrendLine(descendingHighs);
      if (resistanceLine && trendLineDown) {
        try {
          trendLineDown.setData(resistanceLine);
        } catch (e) {}
      }
    }

    // ============================================
    // TECHNICAL INDICATORS
    // ============================================

    function calcEMA(data, period) {
      if (data.length < period) return null;
      const k = 2 / (period + 1);
      let ema = data.slice(0, period).reduce((a, b) => a + b, 0) / period;
      for (let i = period; i < data.length; i++) {
        ema = data[i] * k + ema * (1 - k);
      }
      return ema;
    }

    function calcSMA(data, period) {
      if (data.length < period) return null;
      return data.slice(-period).reduce((a, b) => a + b, 0) / period;
    }

    function calcRSI(closes, period = 14) {
      if (closes.length < period + 1) return null;
      let gains = 0, losses = 0;
      for (let i = closes.length - period; i < closes.length; i++) {
        const change = closes[i] - closes[i - 1];
        if (change > 0) gains += change;
        else losses -= change;
      }
      const avgGain = gains / period;
      const avgLoss = losses / period;
      if (avgLoss === 0) return 100;
      return 100 - (100 / (1 + avgGain / avgLoss));
    }

    function calcMACD(closes) {
      const emaFast = calcEMA(closes, CONFIG.MACD_FAST);
      const emaSlow = calcEMA(closes, CONFIG.MACD_SLOW);
      if (!emaFast || !emaSlow) return { macd: null, signal: null, histogram: null };
      const macdLine = emaFast - emaSlow;
      const macdHistory = [];
      for (let i = CONFIG.MACD_SLOW; i <= closes.length; i++) {
        const fast = calcEMA(closes.slice(0, i), CONFIG.MACD_FAST);
        const slow = calcEMA(closes.slice(0, i), CONFIG.MACD_SLOW);
        if (fast && slow) macdHistory.push(fast - slow);
      }
      const signalLine = calcEMA(macdHistory, CONFIG.MACD_SIGNAL) || 0;
      return { macd: macdLine, signal: signalLine, histogram: macdLine - signalLine };
    }

    function calcStochRSI(closes, period = 14) {
      if (closes.length < period * 2) return null;
      const rsiValues = [];
      for (let i = period + 1; i <= closes.length; i++) {
        const rsi = calcRSI(closes.slice(0, i), period);
        if (rsi !== null) rsiValues.push(rsi);
      }
      if (rsiValues.length < period) return null;
      const recentRSI = rsiValues.slice(-period);
      const minRSI = Math.min(...recentRSI);
      const maxRSI = Math.max(...recentRSI);
      if (maxRSI === minRSI) return 50;
      return ((rsiValues[rsiValues.length - 1] - minRSI) / (maxRSI - minRSI)) * 100;
    }

    function calcWilliamsR(candles, period = 14) {
      if (candles.length < period) return null;
      const recent = candles.slice(-period);
      const highestHigh = Math.max(...recent.map(c => c.high));
      const lowestLow = Math.min(...recent.map(c => c.low));
      const currentClose = candles[candles.length - 1].close;
      if (highestHigh === lowestLow) return -50;
      return ((highestHigh - currentClose) / (highestHigh - lowestLow)) * -100;
    }

    function calcBollingerBands(closes, period = 20, stdDev = 2) {
      if (closes.length < period) return null;
      const sma = calcSMA(closes, period);
      const slice = closes.slice(-period);
      const variance = slice.reduce((sum, val) => sum + Math.pow(val - sma, 2), 0) / period;
      const std = Math.sqrt(variance);
      return {
        upper: sma + (std * stdDev),
        middle: sma,
        lower: sma - (std * stdDev),
        bandwidth: ((sma + std * stdDev) - (sma - std * stdDev)) / sma * 100
      };
    }

    function calcATR(candles, period = 14) {
      if (candles.length < period + 1) return null;
      const trueRanges = [];
      for (let i = 1; i < candles.length; i++) {
        const tr = Math.max(
          candles[i].high - candles[i].low,
          Math.abs(candles[i].high - candles[i - 1].close),
          Math.abs(candles[i].low - candles[i - 1].close)
        );
        trueRanges.push(tr);
      }
      return calcSMA(trueRanges.slice(-period), period);
    }

    function calcADX(candles, period = 14) {
      if (candles.length < period * 2) return null;
      const plusDM = [], minusDM = [], tr = [];
      
      for (let i = 1; i < candles.length; i++) {
        const highDiff = candles[i].high - candles[i - 1].high;
        const lowDiff = candles[i - 1].low - candles[i].low;
        
        plusDM.push(highDiff > lowDiff && highDiff > 0 ? highDiff : 0);
        minusDM.push(lowDiff > highDiff && lowDiff > 0 ? lowDiff : 0);
        
        tr.push(Math.max(
          candles[i].high - candles[i].low,
          Math.abs(candles[i].high - candles[i - 1].close),
          Math.abs(candles[i].low - candles[i - 1].close)
        ));
      }
      
      const atr = calcSMA(tr.slice(-period), period);
      const plusDI = (calcSMA(plusDM.slice(-period), period) / atr) * 100;
      const minusDI = (calcSMA(minusDM.slice(-period), period) / atr) * 100;
      
      const dx = Math.abs(plusDI - minusDI) / (plusDI + minusDI) * 100;
      return { adx: dx, plusDI, minusDI };
    }

    function calcVWAP(candles) {
      if (candles.length < 1) return null;
      let cumVolPrice = 0, cumVol = 0;
      for (const c of candles) {
        const typical = (c.high + c.low + c.close) / 3;
        cumVolPrice += typical * (c.volume || 1);
        cumVol += (c.volume || 1);
      }
      return cumVolPrice / cumVol;
    }

    function calcOBV(candles) {
      if (candles.length < 2) return { obv: 0, trend: 'neutral' };
      let obv = 0;
      for (let i = 1; i < candles.length; i++) {
        if (candles[i].close > candles[i - 1].close) {
          obv += candles[i].volume || 1;
        } else if (candles[i].close < candles[i - 1].close) {
          obv -= candles[i].volume || 1;
        }
      }
      
      // Trend based on OBV EMA
      state.obvHistory.push(obv);
      if (state.obvHistory.length > 20) state.obvHistory.shift();
      
      const obvEma = calcEMA(state.obvHistory, 10);
      const trend = obv > obvEma ? 'bullish' : (obv < obvEma ? 'bearish' : 'neutral');
      
      return { obv, trend };
    }

    function calcMomentum(closes, period = 10) {
      if (closes.length < period + 1) return null;
      return ((closes[closes.length - 1] / closes[closes.length - period - 1]) - 1) * 100;
    }

    // ============================================
    // DIVERGENCE DETECTION
    // ============================================

    function detectRSIDivergence(prices, rsiValues) {
      if (prices.length < 20 || rsiValues.length < 20) return null;
      
      const recentPrices = prices.slice(-20);
      const recentRSI = rsiValues.slice(-20);
      
      // Find local highs and lows in last 20 periods
      let priceHigh1 = -Infinity, priceHigh2 = -Infinity;
      let priceLow1 = Infinity, priceLow2 = Infinity;
      let rsiHigh1 = -Infinity, rsiHigh2 = -Infinity;
      let rsiLow1 = Infinity, rsiLow2 = Infinity;
      
      const mid = Math.floor(recentPrices.length / 2);
      
      for (let i = 0; i < mid; i++) {
        if (recentPrices[i] > priceHigh1) priceHigh1 = recentPrices[i];
        if (recentPrices[i] < priceLow1) priceLow1 = recentPrices[i];
        if (recentRSI[i] > rsiHigh1) rsiHigh1 = recentRSI[i];
        if (recentRSI[i] < rsiLow1) rsiLow1 = recentRSI[i];
      }
      
      for (let i = mid; i < recentPrices.length; i++) {
        if (recentPrices[i] > priceHigh2) priceHigh2 = recentPrices[i];
        if (recentPrices[i] < priceLow2) priceLow2 = recentPrices[i];
        if (recentRSI[i] > rsiHigh2) rsiHigh2 = recentRSI[i];
        if (recentRSI[i] < rsiLow2) rsiLow2 = recentRSI[i];
      }
      
      // Bullish divergence: price makes lower low, RSI makes higher low
      if (priceLow2 < priceLow1 && rsiLow2 > rsiLow1) {
        return 'bullish';
      }
      
      // Bearish divergence: price makes higher high, RSI makes lower high
      if (priceHigh2 > priceHigh1 && rsiHigh2 < rsiHigh1) {
        return 'bearish';
      }
      
      return null;
    }

    // ============================================
    // CANDLE PATTERN DETECTION
    // ============================================

    function detectCandlePatterns(candles) {
      if (candles.length < 5) return [];
      const patterns = [];
      
      const c = candles[candles.length - 1];      // Current
      const prev = candles[candles.length - 2];   // Previous
      const prev2 = candles[candles.length - 3];  // 2 candles ago
      const prev3 = candles[candles.length - 4];  // 3 candles ago
      
      const body = Math.abs(c.close - c.open);
      const upperWick = c.high - Math.max(c.open, c.close);
      const lowerWick = Math.min(c.open, c.close) - c.low;
      const range = c.high - c.low;
      const isBullish = c.close > c.open;
      const isBearish = c.close < c.open;
      
      const prevBody = Math.abs(prev.close - prev.open);
      const prevRange = prev.high - prev.low;
      
      // Evitar divisi√≥n por cero
      if (range === 0 || body === 0) return patterns;
      
      // --- SINGLE CANDLE PATTERNS ---
      
      // Doji (cuerpo muy peque√±o)
      if (body < range * 0.15 && range > 0) {
        if (upperWick > body * 1.5 && lowerWick > body * 1.5) {
          patterns.push({ name: 'DOJI', type: 'neutral' });
        } else if (upperWick > lowerWick * 2) {
          patterns.push({ name: 'GRAVESTONE', type: 'bearish' });
        } else if (lowerWick > upperWick * 2) {
          patterns.push({ name: 'DRAGONFLY', type: 'bullish' });
        }
      }
      
      // Hammer (bullish reversal) - mecha inferior larga
      if (lowerWick > body * 1.5 && upperWick < body * 0.8 && isBullish) {
        patterns.push({ name: 'HAMMER', type: 'bullish' });
      }
      
      // Inverted Hammer
      if (upperWick > body * 1.5 && lowerWick < body * 0.8 && isBullish) {
        patterns.push({ name: 'INV HAMMER', type: 'bullish' });
      }
      
      // Shooting Star (bearish reversal) - mecha superior larga
      if (upperWick > body * 1.5 && lowerWick < body * 0.8 && isBearish) {
        patterns.push({ name: 'SHOOTING STAR', type: 'bearish' });
      }
      
      // Hanging Man
      if (lowerWick > body * 1.5 && upperWick < body * 0.8 && isBearish) {
        patterns.push({ name: 'HANGING MAN', type: 'bearish' });
      }
      
      // Marubozu (vela de cuerpo completo sin mechas)
      if (body > range * 0.85) {
        if (isBullish) {
          patterns.push({ name: 'BULL MARUBOZU', type: 'bullish' });
        } else {
          patterns.push({ name: 'BEAR MARUBOZU', type: 'bearish' });
        }
      }
      
      // Spinning Top (cuerpo peque√±o, mechas similares)
      if (body < range * 0.3 && Math.abs(upperWick - lowerWick) < range * 0.2) {
        patterns.push({ name: 'SPINNING TOP', type: 'neutral' });
      }
      
      // --- TWO CANDLE PATTERNS ---
      
      // Bullish Engulfing
      if (prev.close < prev.open && isBullish && 
          c.open <= prev.close && c.close >= prev.open &&
          body > prevBody) {
        patterns.push({ name: 'BULL ENGULF', type: 'bullish' });
      }
      
      // Bearish Engulfing
      if (prev.close > prev.open && isBearish && 
          c.open >= prev.close && c.close <= prev.open &&
          body > prevBody) {
        patterns.push({ name: 'BEAR ENGULF', type: 'bearish' });
      }
      
      // Piercing Line (bullish)
      if (prev.close < prev.open && isBullish &&
          c.open < prev.low && c.close > (prev.open + prev.close) / 2) {
        patterns.push({ name: 'PIERCING', type: 'bullish' });
      }
      
      // Dark Cloud Cover (bearish)
      if (prev.close > prev.open && isBearish &&
          c.open > prev.high && c.close < (prev.open + prev.close) / 2) {
        patterns.push({ name: 'DARK CLOUD', type: 'bearish' });
      }
      
      // Tweezer Bottom (bullish)
      if (Math.abs(c.low - prev.low) < range * 0.1 && isBullish && prev.close < prev.open) {
        patterns.push({ name: 'TWEEZER BTM', type: 'bullish' });
      }
      
      // Tweezer Top (bearish)
      if (Math.abs(c.high - prev.high) < range * 0.1 && isBearish && prev.close > prev.open) {
        patterns.push({ name: 'TWEEZER TOP', type: 'bearish' });
      }
      
      // --- THREE CANDLE PATTERNS ---
      
      // Morning Star (bullish reversal)
      if (prev2.close < prev2.open &&  // First: bearish
          Math.abs(prev.close - prev.open) < prevRange * 0.4 && // Second: small body
          isBullish && c.close > (prev2.open + prev2.close) / 2) { // Third: bullish
        patterns.push({ name: 'MORNING STAR', type: 'bullish' });
      }
      
      // Evening Star (bearish reversal)
      if (prev2.close > prev2.open && 
          Math.abs(prev.close - prev.open) < prevRange * 0.4 &&
          isBearish && c.close < (prev2.open + prev2.close) / 2) {
        patterns.push({ name: 'EVENING STAR', type: 'bearish' });
      }
      
      // Three White Soldiers (bullish)
      if (prev2.close > prev2.open && prev.close > prev.open && isBullish &&
          prev.close > prev2.close && c.close > prev.close) {
        patterns.push({ name: '3 WHITE SOLD', type: 'bullish' });
      }
      
      // Three Black Crows (bearish)
      if (prev2.close < prev2.open && prev.close < prev.open && isBearish &&
          prev.close < prev2.close && c.close < prev.close) {
        patterns.push({ name: '3 BLACK CROW', type: 'bearish' });
      }
      
      // --- TREND PATTERNS ---
      
      // Strong momentum up (3+ consecutive green candles)
      const lastFive = candles.slice(-5);
      const greenCount = lastFive.filter(c => c.close > c.open).length;
      const redCount = lastFive.filter(c => c.close < c.open).length;
      
      if (greenCount >= 4) {
        patterns.push({ name: 'STRONG UP', type: 'bullish' });
      } else if (redCount >= 4) {
        patterns.push({ name: 'STRONG DOWN', type: 'bearish' });
      }
      
      // Higher highs and higher lows (uptrend)
      if (c.high > prev.high && c.low > prev.low && prev.high > prev2.high) {
        patterns.push({ name: 'UPTREND', type: 'bullish' });
      }
      
      // Lower highs and lower lows (downtrend)
      if (c.high < prev.high && c.low < prev.low && prev.high < prev2.high) {
        patterns.push({ name: 'DOWNTREND', type: 'bearish' });
      }
      
      return patterns.slice(0, 4); // Limitar a 4 patrones para UI
    }

    // ============================================
    // SPOOF DETECTION
    // ============================================

    function detectSpoofing(currentBids, currentAsks) {
      const lastBids = state.lastOrderBook.bids;
      const lastAsks = state.lastOrderBook.asks;
      
      if (lastBids.length === 0) return false;
      
      // Check for large orders that disappeared
      for (const lastBid of lastBids) {
        const vol = parseFloat(lastBid[1]);
        if (vol > CONFIG.SPOOF_THRESHOLD) {
          const stillExists = currentBids.some(b => 
            parseFloat(b[0]) === parseFloat(lastBid[0]) && 
            parseFloat(b[1]) > vol * 0.5
          );
          if (!stillExists) return true;
        }
      }
      
      for (const lastAsk of lastAsks) {
        const vol = parseFloat(lastAsk[1]);
        if (vol > CONFIG.SPOOF_THRESHOLD) {
          const stillExists = currentAsks.some(a => 
            parseFloat(a[0]) === parseFloat(lastAsk[0]) && 
            parseFloat(a[1]) > vol * 0.5
          );
          if (!stillExists) return true;
        }
      }
      
      return false;
    }

    // ============================================
    // ALERTS SYSTEM
    // ============================================

    function addAlert(message, type = 'info') {
      state.alertCount++;
      ui.alertCount.innerText = state.alertCount;
      
      const div = document.createElement('div');
      div.className = `alert-item alert-${type}`;
      const time = new Date().toLocaleTimeString();
      div.innerHTML = `<span style="color:var(--text-dim)">[${time}]</span> ${message}`;
      
      ui.alertsContainer.prepend(div);
      
      // Reproducir sonido seg√∫n tipo de alerta
      if (state.soundEnabled) {
        if (type === 'bullish') playSound('bullish');
        else if (type === 'bearish') playSound('bearish');
        else if (type === 'warning') playSound('alert');
      }
      
      while (ui.alertsContainer.children.length > 20) {
        ui.alertsContainer.lastChild.remove();
      }
    }

    // ============================================
    // PREDICTION TRACKING
    // ============================================

    function trackPrediction(targetPrice, currentPrice) {
      const rsi = state.rsiHistory.length > 0 ? state.rsiHistory[state.rsiHistory.length - 1] : null;
      
      state.predictions.push({
        timestamp: Date.now(),
        target: targetPrice,
        actual: currentPrice,
        direction: targetPrice > currentPrice ? 'up' : 'down',
        rsi: rsi
      });
      
      // Keep last 50 predictions
      if (state.predictions.length > 50) state.predictions.shift();
      
      // Calculate accuracy after we have some results
      if (state.predictions.length >= 10) {
        let correct = 0;
        for (let i = 0; i < state.predictions.length - 5; i++) {
          const pred = state.predictions[i];
          const futurePrice = state.predictions[Math.min(i + 5, state.predictions.length - 1)].actual;
          
          const actualDirection = futurePrice > pred.actual ? 'up' : 'down';
          const isCorrect = actualDirection === pred.direction;
          if (isCorrect) correct++;
          
          // Guardar en historial si no est√° ya
          if (state.predictionHistory.length < i + 1) {
            state.predictionHistory.push(isCorrect);
          }
        }
        
        // Limitar historial a 100
        if (state.predictionHistory.length > 100) {
          state.predictionHistory = state.predictionHistory.slice(-100);
        }
        
        const accuracy = (correct / (state.predictions.length - 5)) * 100;
        ui.modelAccuracy.innerText = accuracy.toFixed(0) + '%';
        ui.accuracyBar.style.width = accuracy + '%';
        ui.accuracyPct.innerText = accuracy.toFixed(0) + '%';
        
        ui.accuracyBar.style.background = accuracy > 60 ? 'var(--accent-green)' : 
          (accuracy > 50 ? 'var(--accent-orange)' : 'var(--accent-red)');
        
        // Actualizar gr√°fico de historial
        updatePredictionHistoryChart();
      }
    }

    // ============================================
    // MAIN PREDICTION ENGINE
    // ============================================

    function runPredictionEngine(currentPrice) {
      if (state.candles.length < 30) {
        ui.aiTarget.innerText = 'Collecting data...';
        return;
      }

      const closes = state.candles.map(c => c.close);
      const signals = { bullish: 0, bearish: 0, neutral: 0 };
      let totalWeight = 0;
      let weightedScore = 0;

      // Store price history for divergence
      state.priceHistory.push(currentPrice);
      if (state.priceHistory.length > 50) state.priceHistory.shift();

      // --- RSI ---
      const rsi = calcRSI(closes, CONFIG.RSI_PERIOD);
      if (rsi !== null) {
        state.rsiHistory.push(rsi);
        if (state.rsiHistory.length > 50) state.rsiHistory.shift();
        
        document.getElementById('rsiValue').innerText = rsi.toFixed(1);
        const rsiEl = document.getElementById('rsiSignal');
        
        if (rsi > 70) {
          rsiEl.className = 'indicator-signal signal-sell'; rsiEl.innerText = 'OVERBOUGHT';
          signals.bearish++; weightedScore -= 1;
        } else if (rsi < 30) {
          rsiEl.className = 'indicator-signal signal-buy'; rsiEl.innerText = 'OVERSOLD';
          signals.bullish++; weightedScore += 1;
        } else {
          rsiEl.className = 'indicator-signal signal-neutral'; rsiEl.innerText = 'NEUTRAL';
          signals.neutral++;
        }
        totalWeight++;
      }

      // --- RSI DIVERGENCE ---
      const divergence = detectRSIDivergence(state.priceHistory, state.rsiHistory);
      const divEl = document.getElementById('divSignal');
      const divValEl = document.getElementById('divValue');
      
      if (divergence === 'bullish') {
        divEl.className = 'indicator-signal signal-buy'; divEl.innerText = 'BULLISH';
        divValEl.innerText = '‚Üó DETECTED';
        signals.bullish++; weightedScore += 2;
        totalWeight += 2;
        ui.divergenceBadge.style.display = 'block';
        ui.divergenceBadge.className = 'divergence-badge div-bullish';
        ui.divergenceBadge.innerText = '‚Üó BULL DIV';
        addAlert('RSI BULLISH DIVERGENCE detected!', 'bullish');
      } else if (divergence === 'bearish') {
        divEl.className = 'indicator-signal signal-sell'; divEl.innerText = 'BEARISH';
        divValEl.innerText = '‚Üò DETECTED';
        signals.bearish++; weightedScore -= 2;
        totalWeight += 2;
        ui.divergenceBadge.style.display = 'block';
        ui.divergenceBadge.className = 'divergence-badge div-bearish';
        ui.divergenceBadge.innerText = '‚Üò BEAR DIV';
        addAlert('RSI BEARISH DIVERGENCE detected!', 'bearish');
      } else {
        divEl.className = 'indicator-signal signal-neutral'; divEl.innerText = 'NONE';
        divValEl.innerText = 'No signal';
        ui.divergenceBadge.style.display = 'none';
      }

      // --- MACD ---
      const macd = calcMACD(closes);
      if (macd.macd !== null) {
        document.getElementById('macdValue').innerText = macd.histogram.toFixed(5);
        const macdEl = document.getElementById('macdSignal');
        
        if (macd.histogram > 0 && macd.macd > macd.signal) {
          macdEl.className = 'indicator-signal signal-buy'; macdEl.innerText = 'BULLISH';
          signals.bullish++; weightedScore += 1.5;
        } else if (macd.histogram < 0 && macd.macd < macd.signal) {
          macdEl.className = 'indicator-signal signal-sell'; macdEl.innerText = 'BEARISH';
          signals.bearish++; weightedScore -= 1.5;
        } else {
          macdEl.className = 'indicator-signal signal-neutral'; macdEl.innerText = 'CROSSING';
          signals.neutral++;
        }
        totalWeight += 1.5;
      }

      // --- Stochastic RSI ---
      const stochRSI = calcStochRSI(closes, CONFIG.STOCH_PERIOD);
      if (stochRSI !== null) {
        document.getElementById('stochValue').innerText = stochRSI.toFixed(1);
        const stochEl = document.getElementById('stochSignal');
        
        if (stochRSI > 80) {
          stochEl.className = 'indicator-signal signal-sell'; stochEl.innerText = 'OVERBOUGHT';
          signals.bearish++; weightedScore -= 1;
        } else if (stochRSI < 20) {
          stochEl.className = 'indicator-signal signal-buy'; stochEl.innerText = 'OVERSOLD';
          signals.bullish++; weightedScore += 1;
        } else {
          stochEl.className = 'indicator-signal signal-neutral'; stochEl.innerText = 'NEUTRAL';
          signals.neutral++;
        }
        totalWeight++;
      }

      // --- Williams %R ---
      const willR = calcWilliamsR(state.candles, CONFIG.WILLR_PERIOD);
      if (willR !== null) {
        document.getElementById('willrValue').innerText = willR.toFixed(1);
        const willEl = document.getElementById('willrSignal');
        
        if (willR > -20) {
          willEl.className = 'indicator-signal signal-sell'; willEl.innerText = 'OVERBOUGHT';
          signals.bearish++; weightedScore -= 0.8;
        } else if (willR < -80) {
          willEl.className = 'indicator-signal signal-buy'; willEl.innerText = 'OVERSOLD';
          signals.bullish++; weightedScore += 0.8;
        } else {
          willEl.className = 'indicator-signal signal-neutral'; willEl.innerText = 'NEUTRAL';
          signals.neutral++;
        }
        totalWeight += 0.8;
      }

      // --- Bollinger Bands ---
      const bb = calcBollingerBands(closes, CONFIG.BB_PERIOD, CONFIG.BB_STD);
      if (bb) {
        const bbPosition = ((currentPrice - bb.lower) / (bb.upper - bb.lower)) * 100;
        document.getElementById('bbValue').innerText = bbPosition.toFixed(0) + '%';
        const bbEl = document.getElementById('bbSignal');
        
        if (currentPrice > bb.upper) {
          bbEl.className = 'indicator-signal signal-sell'; bbEl.innerText = 'ABOVE';
          signals.bearish++; weightedScore -= 1.2;
        } else if (currentPrice < bb.lower) {
          bbEl.className = 'indicator-signal signal-buy'; bbEl.innerText = 'BELOW';
          signals.bullish++; weightedScore += 1.2;
        } else {
          bbEl.className = 'indicator-signal signal-neutral'; bbEl.innerText = 'IN BAND';
          signals.neutral++;
        }
        totalWeight += 1.2;
      }

      // --- EMA Cross ---
      const emaFast = calcEMA(closes, CONFIG.EMA_FAST);
      const emaSlow = calcEMA(closes, CONFIG.EMA_SLOW);
      if (emaFast && emaSlow) {
        const emaDiff = ((emaFast - emaSlow) / emaSlow) * 100;
        document.getElementById('emaValue').innerText = emaDiff.toFixed(3) + '%';
        const emaEl = document.getElementById('emaSignal');
        
        if (emaFast > emaSlow && currentPrice > emaFast) {
          emaEl.className = 'indicator-signal signal-buy'; emaEl.innerText = 'BULLISH';
          signals.bullish++; weightedScore += 1.3;
        } else if (emaFast < emaSlow && currentPrice < emaFast) {
          emaEl.className = 'indicator-signal signal-sell'; emaEl.innerText = 'BEARISH';
          signals.bearish++; weightedScore -= 1.3;
        } else {
          emaEl.className = 'indicator-signal signal-neutral'; emaEl.innerText = 'MIXED';
          signals.neutral++;
        }
        totalWeight += 1.3;
      }

      // --- ADX ---
      const adx = calcADX(state.candles, CONFIG.ADX_PERIOD);
      if (adx) {
        document.getElementById('adxValue').innerText = adx.adx.toFixed(1);
        const adxEl = document.getElementById('adxSignal');
        
        if (adx.adx > 25) {
          if (adx.plusDI > adx.minusDI) {
            adxEl.className = 'indicator-signal signal-buy'; adxEl.innerText = 'STRONG ‚Üë';
            signals.bullish++; weightedScore += 1;
          } else {
            adxEl.className = 'indicator-signal signal-sell'; adxEl.innerText = 'STRONG ‚Üì';
            signals.bearish++; weightedScore -= 1;
          }
        } else {
          adxEl.className = 'indicator-signal signal-neutral'; adxEl.innerText = 'WEAK';
          signals.neutral++;
        }
        totalWeight++;
      }

      // --- VWAP ---
      const vwap = calcVWAP(state.candles);
      if (vwap) {
        document.getElementById('vwapValue').innerText = vwap.toFixed(4);
        const vwapEl = document.getElementById('vwapSignal');
        
        if (currentPrice > vwap * 1.002) {
          vwapEl.className = 'indicator-signal signal-buy'; vwapEl.innerText = 'ABOVE';
          signals.bullish++; weightedScore += 1;
        } else if (currentPrice < vwap * 0.998) {
          vwapEl.className = 'indicator-signal signal-sell'; vwapEl.innerText = 'BELOW';
          signals.bearish++; weightedScore -= 1;
        } else {
          vwapEl.className = 'indicator-signal signal-neutral'; vwapEl.innerText = 'AT VWAP';
          signals.neutral++;
        }
        totalWeight++;
      }

      // --- OBV ---
      const obv = calcOBV(state.candles);
      document.getElementById('obvValue').innerText = (obv.obv / 1000000).toFixed(2) + 'M';
      const obvEl = document.getElementById('obvSignal');
      
      if (obv.trend === 'bullish') {
        obvEl.className = 'indicator-signal signal-buy'; obvEl.innerText = 'BULLISH';
        signals.bullish++; weightedScore += 0.8;
      } else if (obv.trend === 'bearish') {
        obvEl.className = 'indicator-signal signal-sell'; obvEl.innerText = 'BEARISH';
        signals.bearish++; weightedScore -= 0.8;
      } else {
        obvEl.className = 'indicator-signal signal-neutral'; obvEl.innerText = 'NEUTRAL';
        signals.neutral++;
      }
      totalWeight += 0.8;

      // --- Momentum ---
      const momentum = calcMomentum(closes, 10);
      if (momentum !== null) {
        document.getElementById('momValue').innerText = momentum.toFixed(2) + '%';
        const momEl = document.getElementById('momSignal');
        
        if (momentum > 0.5) {
          momEl.className = 'indicator-signal signal-buy'; momEl.innerText = 'POSITIVE';
          signals.bullish++; weightedScore += 0.8;
        } else if (momentum < -0.5) {
          momEl.className = 'indicator-signal signal-sell'; momEl.innerText = 'NEGATIVE';
          signals.bearish++; weightedScore -= 0.8;
        } else {
          momEl.className = 'indicator-signal signal-neutral'; momEl.innerText = 'FLAT';
          signals.neutral++;
        }
        totalWeight += 0.8;
      }

      // --- CVD Signal ---
      const cvdEl = document.getElementById('cvdSignal');
      document.getElementById('cvdValue').innerText = (state.cvd / 1000).toFixed(1) + 'K';
      if (state.cvd > 10000) {
        cvdEl.className = 'indicator-signal signal-buy'; cvdEl.innerText = 'BUYING';
        weightedScore += 0.5;
      } else if (state.cvd < -10000) {
        cvdEl.className = 'indicator-signal signal-sell'; cvdEl.innerText = 'SELLING';
        weightedScore -= 0.5;
      } else {
        cvdEl.className = 'indicator-signal signal-neutral'; cvdEl.innerText = 'NEUTRAL';
      }

      // --- Whale Flow ---
      const netWhaleFlow = state.whaleBuyVol - state.whaleSellVol;
      const whaleFlowEl = document.getElementById('whaleFlowSignal');
      document.getElementById('whaleFlowValue').innerText = (netWhaleFlow / 1000).toFixed(0) + 'K';
      
      if (netWhaleFlow > 100000) {
        whaleFlowEl.className = 'indicator-signal signal-buy'; whaleFlowEl.innerText = 'ACCUMULATING';
        weightedScore += 1;
      } else if (netWhaleFlow < -100000) {
        whaleFlowEl.className = 'indicator-signal signal-sell'; whaleFlowEl.innerText = 'DISTRIBUTING';
        weightedScore -= 1;
      } else {
        whaleFlowEl.className = 'indicator-signal signal-neutral'; whaleFlowEl.innerText = 'NEUTRAL';
      }

      // --- ATR Levels ---
      const atr = calcATR(state.candles, CONFIG.ATR_PERIOD);
      if (atr) {
        document.getElementById('r2').innerText = (currentPrice + atr * 2).toFixed(4);
        document.getElementById('r1').innerText = (currentPrice + atr).toFixed(4);
        document.getElementById('currentLevel').innerText = currentPrice.toFixed(4);
        document.getElementById('s1').innerText = (currentPrice - atr).toFixed(4);
        document.getElementById('s2').innerText = (currentPrice - atr * 2).toFixed(4);
      }

      // --- Candle Patterns ---
      const patterns = detectCandlePatterns(state.candles);
      if (patterns.length > 0) {
        ui.patternsContainer.innerHTML = patterns.map(p => 
          `<span class="pattern-tag" style="color:${p.type === 'bullish' ? 'var(--accent-green)' : (p.type === 'bearish' ? 'var(--accent-red)' : 'var(--accent-purple)')}">${p.name}</span>`
        ).join('');
        
        patterns.forEach(p => {
          if (p.type === 'bullish') { weightedScore += 0.5; signals.bullish++; }
          else if (p.type === 'bearish') { weightedScore -= 0.5; signals.bearish++; }
        });
      } else {
        ui.patternsContainer.innerHTML = '<span style="color:var(--text-dim); font-size:10px;">No patterns</span>';
      }

      // --- PROJECTION ---
      let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0, sumW = 0;
      const n = Math.min(closes.length, 30);
      
      for (let i = closes.length - n; i < closes.length; i++) {
        const idx = i - (closes.length - n);
        const weight = 1 + (idx / n);
        sumX += idx * weight;
        sumY += closes[i] * weight;
        sumXY += idx * closes[i] * weight;
        sumXX += idx * idx * weight;
        sumW += weight;
      }
      
      const slope = (sumW * sumXY - sumX * sumY) / (sumW * sumXX - sumX * sumX);
      const intercept = (sumY - slope * sumX) / sumW;
      const projection = slope * (n + 5) + intercept;
      
      const signalAdjustment = (weightedScore / totalWeight) * (atr || 0) * 0.5;
      const finalTarget = projection + signalAdjustment;

      // Track prediction
      trackPrediction(finalTarget, currentPrice);

      // --- UPDATE UI ---
      ui.aiTarget.innerText = '$ ' + finalTarget.toFixed(4);
      ui.aiTarget.style.color = finalTarget > currentPrice ? 'var(--accent-green)' : 'var(--accent-red)';
      
      const maxSignals = signals.bullish + signals.bearish + signals.neutral;
      const dominantSignal = Math.max(signals.bullish, signals.bearish, signals.neutral);
      const confidence = (dominantSignal / maxSignals) * 100;
      ui.conf.innerText = confidence.toFixed(0) + '%';

      const normalizedScore = (weightedScore / (totalWeight || 1)) * 50 + 50;
      const fillWidth = Math.abs(normalizedScore - 50);
      const fillColor = normalizedScore > 50 ? 'var(--accent-green)' : 'var(--accent-red)';
      const fillLeft = normalizedScore > 50 ? '50%' : (50 - fillWidth) + '%';
      
      ui.scoreFill.style.width = fillWidth + '%';
      ui.scoreFill.style.left = fillLeft;
      ui.scoreFill.style.background = fillColor;

      ui.bullCount.innerText = signals.bullish;
      ui.neutCount.innerText = signals.neutral;
      ui.bearCount.innerText = signals.bearish;

      const scorePercent = ((weightedScore / totalWeight + 1) / 2 * 100).toFixed(0);
      ui.totalScore.innerText = scorePercent + '/100';
      ui.totalScore.style.color = weightedScore > 0 ? 'var(--accent-green)' : (weightedScore < 0 ? 'var(--accent-red)' : 'var(--text-main)');

      if (signals.bullish > signals.bearish + 2) {
        ui.consensus.innerText = 'STRONG BULLISH';
        ui.consensus.style.color = 'var(--accent-green)';
        ui.scoreLabel.innerText = 'Strong buy pressure';
      } else if (signals.bullish > signals.bearish) {
        ui.consensus.innerText = 'BULLISH';
        ui.consensus.style.color = 'var(--accent-green)';
        ui.scoreLabel.innerText = 'Buy pressure dominant';
      } else if (signals.bearish > signals.bullish + 2) {
        ui.consensus.innerText = 'STRONG BEARISH';
        ui.consensus.style.color = 'var(--accent-red)';
        ui.scoreLabel.innerText = 'Strong sell pressure';
      } else if (signals.bearish > signals.bullish) {
        ui.consensus.innerText = 'BEARISH';
        ui.consensus.style.color = 'var(--accent-red)';
        ui.scoreLabel.innerText = 'Sell pressure dominant';
      } else {
        ui.consensus.innerText = 'CONSOLIDATION';
        ui.consensus.style.color = 'var(--accent-orange)';
        ui.scoreLabel.innerText = 'Mixed signals';
      }
    }

    // ============================================
    // API CALLS
    // ============================================

    async function fetchFearGreed() {
      try {
        const response = await fetch('https://api.alternative.me/fng/?limit=1');
        const data = await response.json();
        if (data?.data?.[0]) {
          const fng = data.data[0];
          ui.fg.innerText = fng.value;
          ui.fgLabel.innerText = fng.value_classification;
          const val = parseInt(fng.value);
          ui.fg.style.color = val <= 25 ? 'var(--accent-red)' : val <= 45 ? 'var(--accent-orange)' : val <= 55 ? 'var(--text-main)' : val <= 75 ? '#90EE90' : 'var(--accent-green)';
        }
      } catch (err) {
        console.error('Fear & Greed error:', err);
      }
    }

    async function fetchDerivativesData() {
      try {
        // Funding Rate
        const fundingRes = await fetch('https://fapi.binance.com/fapi/v1/fundingRate?symbol=XRPUSDT&limit=1');
        const fundingData = await fundingRes.json();
        if (fundingData?.[0]) {
          const rate = parseFloat(fundingData[0].fundingRate) * 100;
          ui.fundingRate.innerText = rate.toFixed(4) + '%';
          ui.fundingRate.style.color = rate > 0 ? 'var(--accent-green)' : 'var(--accent-red)';
          
          if (Math.abs(rate) > 0.1) {
            addAlert(`High Funding Rate: ${rate.toFixed(4)}% - ${rate > 0 ? 'Longs paying shorts' : 'Shorts paying longs'}`, rate > 0 ? 'warning' : 'info');
          }
        }

        // Open Interest
        const oiRes = await fetch('https://fapi.binance.com/fapi/v1/openInterest?symbol=XRPUSDT');
        const oiData = await oiRes.json();
        if (oiData?.openInterest) {
          const oi = parseFloat(oiData.openInterest);
          ui.openInterest.innerText = (oi / 1000000).toFixed(1) + 'M';
        }

        // Long/Short Ratio
        const lsRes = await fetch('https://fapi.binance.com/futures/data/globalLongShortAccountRatio?symbol=XRPUSDT&period=5m&limit=1');
        const lsData = await lsRes.json();
        if (lsData?.[0]) {
          const ratio = parseFloat(lsData[0].longShortRatio);
          document.getElementById('lsValue').innerText = ratio.toFixed(2);
          
          const lsEl = document.getElementById('lsSignal');
          if (ratio > 1.5) {
            lsEl.className = 'indicator-signal signal-warning'; lsEl.innerText = 'CROWDED LONG';
          } else if (ratio < 0.7) {
            lsEl.className = 'indicator-signal signal-warning'; lsEl.innerText = 'CROWDED SHORT';
          } else if (ratio > 1) {
            lsEl.className = 'indicator-signal signal-buy'; lsEl.innerText = 'LONG BIAS';
          } else {
            lsEl.className = 'indicator-signal signal-sell'; lsEl.innerText = 'SHORT BIAS';
          }
        }

      } catch (err) {
        console.error('Derivatives fetch error:', err);
      }
    }

    // ETF Data - Actualizado desde xrp-insights.com
    async function fetchETFData() {
      // Los datos de ETF se actualizan desde fuentes oficiales
      // Por ahora usamos datos verificados del 25 Dec 2025
      const etfData = {
        totalAum: 1409.36,  // Millones USD
        xrpLocked: 746.32,  // Millones XRP
        supplyPct: 0.7463,
        etfs: [
          { ticker: 'XRPC', name: 'Canary Capital', aum: 328.5, xrp: 176.2 },
          { ticker: 'TOXR', name: '21Shares', aum: 257.2, xrp: 135.7 },
          { ticker: 'XRP', name: 'Bitwise', aum: 233.0, xrp: 122.8 },
          { ticker: 'GXRP', name: 'Grayscale', aum: 228.3, xrp: 121.5 },
          { ticker: 'XRPZ', name: 'Franklin', aum: 208.6, xrp: 111.9 },
          { ticker: 'XRPR', name: 'REX-Osprey', aum: 101.4, xrp: 50.7 },
          { ticker: 'BITW', name: 'Bitwise Idx', aum: 52.3, xrp: 27.5 }
        ]
      };

      // Actualizar UI
      const totalAumEl = document.getElementById('etfTotalAum');
      const xrpLockedEl = document.getElementById('etfXrpLocked');
      const supplyPctEl = document.getElementById('etfSupplyPct');
      const progressBarEl = document.getElementById('etfProgressBar');
      
      if (totalAumEl) totalAumEl.innerText = '$' + (etfData.totalAum / 1000).toFixed(2) + 'B';
      if (xrpLockedEl) xrpLockedEl.innerText = etfData.xrpLocked.toFixed(1) + 'M';
      
      // Progress bar: % hacia 1B XRP (1000M)
      const progressPct = (etfData.xrpLocked / 1000) * 100;
      if (supplyPctEl) supplyPctEl.innerText = progressPct.toFixed(1) + '%';
      if (progressBarEl) progressBarEl.style.width = progressPct + '%';
      
      // Header stats
      const etfAumHeader = document.getElementById('etfAum');
      const xrpLockedHeader = document.getElementById('xrpLocked');
      if (etfAumHeader) etfAumHeader.innerText = '$' + (etfData.totalAum / 1000).toFixed(2) + 'B';
      if (xrpLockedHeader) xrpLockedHeader.innerText = etfData.xrpLocked.toFixed(1) + 'M';

      // Intentar obtener datos en vivo (si hay API disponible)
      try {
        const response = await fetch('https://xrp-insights.com/api/etf-data', { 
          mode: 'cors',
          headers: { 'Accept': 'application/json' }
        });
        if (response.ok) {
          const liveData = await response.json();
          if (liveData?.totalAum) {
            if (totalAumEl) totalAumEl.innerText = '$' + (liveData.totalAum / 1000).toFixed(2) + 'B';
            if (etfAumHeader) etfAumHeader.innerText = '$' + (liveData.totalAum / 1000).toFixed(2) + 'B';
          }
          if (liveData?.xrpLocked) {
            if (xrpLockedEl) xrpLockedEl.innerText = liveData.xrpLocked.toFixed(1) + 'M';
            if (xrpLockedHeader) xrpLockedHeader.innerText = liveData.xrpLocked.toFixed(1) + 'M';
            const livePct = (liveData.xrpLocked / 1000) * 100;
            if (supplyPctEl) supplyPctEl.innerText = livePct.toFixed(1) + '%';
            if (progressBarEl) progressBarEl.style.width = livePct + '%';
          }
        }
      } catch (e) {
        // API no disponible, usar datos est√°ticos
        console.log('ETF live data not available, using cached data');
      }
    }

    async function fetchBTCPrice() {
      try {
        const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
        const data = await res.json();
        if (data?.price) {
          state.btcPrice = parseFloat(data.price);
          ui.btcPrice.innerText = '$' + (state.btcPrice / 1000).toFixed(1) + 'K';
        }
      } catch (err) {
        console.error('BTC price error:', err);
      }
    }

    async function fetchHistoricalData() {
      try {
        const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=XRPUSDT&interval=${state.currentTimeframe}&limit=100`);
        const data = await response.json();
        
        state.candles = data.map(k => ({
          time: k[0] / 1000,
          open: parseFloat(k[1]),
          high: parseFloat(k[2]),
          low: parseFloat(k[3]),
          close: parseFloat(k[4]),
          volume: parseFloat(k[5])
        }));
        
        if (candleSeries) candleSeries.setData(state.candles);
        
        // Actualizar l√≠neas de tendencia
        updateTrendLines();
        
        if (state.candles.length > 0) {
          state.currentPrice = state.candles[state.candles.length - 1].close;
          runPredictionEngine(state.currentPrice);
        }
        
        console.log(`Historical data loaded (${state.currentTimeframe}):`, state.candles.length, 'candles');
      } catch (err) {
        console.error('Historical fetch error:', err);
      }
    }

    // ============================================
    // WEBSOCKET
    // ============================================

    let ws;

    function getWsUrl() {
      return `wss://stream.binance.com:9443/stream?streams=xrpusdt@kline_${state.currentTimeframe}/xrpusdt@depth20@100ms/xrpusdt@ticker/xrpusdt@aggTrade`;
    }

    function connectAPI() {
      ui.statusText.innerText = 'CONNECTING...';
      ui.statusPill.className = 'status-pill';
      
      const wsUrl = getWsUrl();
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        ui.statusText.innerText = 'LIVE';
        ui.statusPill.classList.add('status-live');
        addAlert('System connected to Binance streams', 'info');
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        const data = msg.data;
        const stream = msg.stream;

        if (stream.includes('kline') && candleSeries) {
          const k = data.k;
          const candle = {
            time: k.t / 1000,
            open: parseFloat(k.o),
            high: parseFloat(k.h),
            low: parseFloat(k.l),
            close: parseFloat(k.c),
            volume: parseFloat(k.v)
          };
          
          candleSeries.update(candle);

          if (k.x) {
            state.candles.push(candle);
            if (state.candles.length > CONFIG.HISTORY_SIZE) state.candles.shift();
            runPredictionEngine(candle.close);
            // Actualizar l√≠neas de tendencia cuando se cierra una vela
            updateTrendLines();
          }
        }

        if (stream.includes('ticker')) {
          const price = parseFloat(data.c);
          const change = parseFloat(data.P);
          const volume = parseFloat(data.q);
          
          state.currentPrice = price;
          
          ui.price.innerText = price.toFixed(4);
          ui.midPrice.innerText = price.toFixed(4);
          ui.priceChange.innerHTML = `<span class="${change >= 0 ? 'c-green' : 'c-red'}">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</span>`;
          ui.volume.innerText = (volume / 1000000).toFixed(2) + 'M';
          
          if (state.candles.length > 0) {
            runPredictionEngine(price);
          }
        }

        if (stream.includes('depth')) {
          // Spoof detection
          const spoofDetected = detectSpoofing(data.bids, data.asks);
          ui.spoofWarning.style.display = spoofDetected ? 'inline' : 'none';
          if (spoofDetected) {
            addAlert('Potential SPOOFING detected in order book!', 'warning');
          }
          
          state.lastOrderBook = { bids: data.bids, asks: data.asks };
          updateOrderBook(data.bids, data.asks);
        }

        if (stream.includes('aggtrade') || stream.includes('aggTrade')) {
          const qty = parseFloat(data.q);
          const price = parseFloat(data.p);
          const isBuy = !data.m;
          
          state.cvd += isBuy ? qty : -qty;
          ui.cvdText.innerHTML = `CVD: <span class="${state.cvd >= 0 ? 'c-green' : 'c-red'}">${state.cvd >= 0 ? '+' : ''}${(state.cvd / 1000).toFixed(1)}K</span>`;
          
          if (qty >= CONFIG.WHALE_THRESHOLD) {
            addWhaleAlert(qty, price, isBuy);
            if (isBuy) state.whaleBuyVol += qty;
            else state.whaleSellVol += qty;
          }
        }
      };

      ws.onerror = () => {
        ui.statusText.innerText = 'ERROR';
        ui.statusPill.classList.add('status-err');
      };

      ws.onclose = () => {
        ui.statusText.innerText = 'RECONNECTING...';
        ui.statusPill.classList.remove('status-live');
        setTimeout(connectAPI, 3000);
      };
    }

    function updateOrderBook(bids, asks) {
      ui.bids.innerHTML = '';
      ui.asks.innerHTML = '';
      
      let totalBidVol = 0, totalAskVol = 0;
      let walls = [];

      const reversedAsks = asks.slice(0, 7).reverse();
      for (const ask of reversedAsks) {
        const price = parseFloat(ask[0]);
        const vol = parseFloat(ask[1]);
        totalAskVol += vol;
        if (vol >= CONFIG.WALL_THRESHOLD) walls.push({ type: 'SELL', price, vol });
        
        const row = document.createElement('div');
        row.className = 'ob-row ob-ask';
        row.innerHTML = `<span>${price.toFixed(4)}</span><span>${(vol/1000).toFixed(1)}K</span>`;
        if (vol >= CONFIG.WALL_THRESHOLD) row.style.background = 'rgba(255,68,102,0.15)';
        ui.asks.appendChild(row);
      }

      for (let i = 0; i < 7 && i < bids.length; i++) {
        const price = parseFloat(bids[i][0]);
        const vol = parseFloat(bids[i][1]);
        totalBidVol += vol;
        if (vol >= CONFIG.WALL_THRESHOLD) walls.push({ type: 'BUY', price, vol });
        
        const row = document.createElement('div');
        row.className = 'ob-row ob-bid';
        row.innerHTML = `<span>${price.toFixed(4)}</span><span>${(vol/1000).toFixed(1)}K</span>`;
        if (vol >= CONFIG.WALL_THRESHOLD) row.style.background = 'rgba(0,255,136,0.15)';
        ui.bids.appendChild(row);
      }

      const total = totalBidVol + totalAskVol;
      if (total > 0) {
        const bidPct = (totalBidVol / total) * 100;
        ui.liqBarBid.style.width = bidPct + '%';
        ui.liqBarAsk.style.width = (100 - bidPct) + '%';
        
        const dominant = bidPct > 55 ? 'BULLS' : (bidPct < 45 ? 'BEARS' : 'BALANCED');
        const domColor = bidPct > 55 ? 'c-green' : (bidPct < 45 ? 'c-red' : '');
        ui.liqText.innerHTML = `<span class="${domColor}"><strong>${dominant}</strong></span> ${bidPct.toFixed(0)}% / ${(100-bidPct).toFixed(0)}%`;
        
        const imbalance = ((totalBidVol - totalAskVol) / total) * 100;
        document.getElementById('obValue').innerText = imbalance.toFixed(1) + '%';
        const obEl = document.getElementById('obSignal');
        
        if (imbalance > 15) {
          obEl.className = 'indicator-signal signal-buy'; obEl.innerText = 'BUY WALL';
        } else if (imbalance < -15) {
          obEl.className = 'indicator-signal signal-sell'; obEl.innerText = 'SELL WALL';
        } else {
          obEl.className = 'indicator-signal signal-neutral'; obEl.innerText = 'BALANCED';
        }
      }

      ui.wallDetection.innerHTML = '';
      walls.slice(0, 2).forEach(wall => {
        const div = document.createElement('div');
        div.className = 'wall-indicator';
        div.innerHTML = `<span class="${wall.type === 'BUY' ? 'c-green' : 'c-red'}">‚óè ${wall.type}</span> @ ${wall.price.toFixed(4)} (${(wall.vol/1000).toFixed(0)}K)`;
        ui.wallDetection.appendChild(div);
      });
    }

    function addWhaleAlert(qty, price, isBuy) {
      state.whaleCount++;
      ui.whaleCount.innerText = state.whaleCount;
      
      // Limpiar mensaje inicial si es el primer whale
      if (state.whaleCount === 1) {
        ui.whaleList.innerHTML = '';
      }
      
      const div = document.createElement('div');
      div.className = `whale-item ${isBuy ? 'buy' : 'sell'}`;
      
      const time = new Date().toLocaleTimeString();
      const value = (qty * price / 1000).toFixed(1);
      
      div.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
          <span>
            <span class="${isBuy ? 'c-green' : 'c-red'}">‚óè ${isBuy ? 'BUY' : 'SELL'}</span>
            <strong>${(qty/1000).toFixed(0)}K</strong>
          </span>
          <span style="font-size:8px; background:rgba(255,149,0,0.2); color:var(--accent-orange); padding:1px 4px; border-radius:2px;">BINANCE</span>
          <span style="color:var(--text-dim); font-size:9px;">${value}K$ ${time}</span>
        </div>
      `;
      
      ui.whaleList.prepend(div);
      
      // Alert for big whales (>25K ahora que el threshold base es 5K)
      if (qty >= 25000) {
        addAlert(`üêã BIG WHALE: ${isBuy ? 'BUY' : 'SELL'} ${(qty/1000).toFixed(0)}K XRP ($${value}K) on Binance`, isBuy ? 'bullish' : 'bearish');
        if (state.soundEnabled) playSound('whale');
      }
      
      while (ui.whaleList.children.length > 12) {
        ui.whaleList.lastChild.remove();
      }
    }

    // ============================================
    // INIT
    // ============================================

    window.addEventListener('DOMContentLoaded', () => {
      console.log('XRP ORACULUM V3 INITIALIZING...');
      
      // Clock
      setInterval(() => {
        ui.clock.innerText = new Date().toLocaleTimeString();
      }, 1000);
      
      // Timeframe selector
      const tfSelect = document.getElementById('timeframeSelect');
      if (tfSelect) {
        tfSelect.addEventListener('change', (e) => {
          changeTimeframe(e.target.value);
        });
      }
      
      // Initialize audio context on first user interaction
      document.body.addEventListener('click', () => {
        initAudio();
      }, { once: true });
      
      setTimeout(() => {
        initChart();
        connectAPI();
        fetchHistoricalData();
        fetchFearGreed();
        fetchDerivativesData();
        fetchBTCPrice();
        fetchETFData();
        updatePredictionHistoryChart();
      }, 100);
      
      // Periodic updates
      setInterval(fetchFearGreed, 300000);
      setInterval(fetchDerivativesData, 60000);
      setInterval(fetchBTCPrice, 30000);
      setInterval(fetchETFData, 120000); // ETF data cada 2 minutos
      
      // Reset CVD and whale flow hourly
      setInterval(() => {
        state.cvd = 0;
        state.whaleBuyVol = 0;
        state.whaleSellVol = 0;
        addAlert('Hourly reset: CVD and Whale Flow counters cleared', 'info');
      }, 3600000);

      // Cargar alertas guardadas
      loadCustomAlerts();
      
      // Actualizar Multi-TF cada 30 segundos
      setInterval(updateMultiTimeframe, 30000);
      
      // Actualizar l√≠neas de tendencia cada 30 segundos
      setInterval(updateTrendLines, 30000);
    });

  </script>

  <!-- ============================================
       TOOLS PANEL OVERLAY
       ============================================ -->
  <div id="toolsOverlay" class="tools-overlay" onclick="closeToolsIfClickOutside(event)">
    <div class="tools-panel" onclick="event.stopPropagation()">
      <div class="tools-header">
        <h2>üõ†Ô∏è TRADING TOOLS</h2>
        <button class="tools-close" onclick="toggleToolsPanel()">√ó</button>
      </div>

      <div class="tools-tabs">
        <button class="tools-tab active" onclick="switchToolTab('mtf')">üìä Multi-TF</button>
        <button class="tools-tab" onclick="switchToolTab('risk')">üéØ Risk Calc</button>
        <button class="tools-tab" onclick="switchToolTab('alerts')">üîî Alerts</button>
        <button class="tools-tab" onclick="switchToolTab('fibo')">üìê Fibonacci</button>
        <button class="tools-tab" onclick="switchToolTab('session')">üìà Session</button>
        <button class="tools-tab" onclick="switchToolTab('strategy')">ü§ñ Strategy</button>
        <button class="tools-tab" onclick="switchToolTab('corr')">üîó Correlation</button>
        <button class="tools-tab" onclick="switchToolTab('watchlist')">üëÅÔ∏è Watchlist</button>
      </div>

      <div class="tools-content">
        <!-- MULTI-TIMEFRAME SECTION -->
        <div id="mtfSection" class="tool-section active">
          <div class="mtf-grid" id="mtfGrid">
            <div class="mtf-card" data-tf="1m">
              <div class="mtf-tf">1M</div>
              <div class="mtf-price" id="mtf-price-1m">--</div>
              <div class="mtf-signal neutral" id="mtf-signal-1m">LOADING</div>
              <div class="mtf-indicators">
                <div>RSI: <span class="mtf-rsi" id="mtf-rsi-1m">--</span></div>
                <div>MACD: <span id="mtf-macd-1m">--</span></div>
                <div>Trend: <span id="mtf-trend-1m">--</span></div>
              </div>
            </div>
            <div class="mtf-card" data-tf="5m">
              <div class="mtf-tf">5M</div>
              <div class="mtf-price" id="mtf-price-5m">--</div>
              <div class="mtf-signal neutral" id="mtf-signal-5m">LOADING</div>
              <div class="mtf-indicators">
                <div>RSI: <span class="mtf-rsi" id="mtf-rsi-5m">--</span></div>
                <div>MACD: <span id="mtf-macd-5m">--</span></div>
                <div>Trend: <span id="mtf-trend-5m">--</span></div>
              </div>
            </div>
            <div class="mtf-card" data-tf="15m">
              <div class="mtf-tf">15M</div>
              <div class="mtf-price" id="mtf-price-15m">--</div>
              <div class="mtf-signal neutral" id="mtf-signal-15m">LOADING</div>
              <div class="mtf-indicators">
                <div>RSI: <span class="mtf-rsi" id="mtf-rsi-15m">--</span></div>
                <div>MACD: <span id="mtf-macd-15m">--</span></div>
                <div>Trend: <span id="mtf-trend-15m">--</span></div>
              </div>
            </div>
            <div class="mtf-card" data-tf="1h">
              <div class="mtf-tf">1H</div>
              <div class="mtf-price" id="mtf-price-1h">--</div>
              <div class="mtf-signal neutral" id="mtf-signal-1h">LOADING</div>
              <div class="mtf-indicators">
                <div>RSI: <span class="mtf-rsi" id="mtf-rsi-1h">--</span></div>
                <div>MACD: <span id="mtf-macd-1h">--</span></div>
                <div>Trend: <span id="mtf-trend-1h">--</span></div>
              </div>
            </div>
            <div class="mtf-card" data-tf="4h">
              <div class="mtf-tf">4H</div>
              <div class="mtf-price" id="mtf-price-4h">--</div>
              <div class="mtf-signal neutral" id="mtf-signal-4h">LOADING</div>
              <div class="mtf-indicators">
                <div>RSI: <span class="mtf-rsi" id="mtf-rsi-4h">--</span></div>
                <div>MACD: <span id="mtf-macd-4h">--</span></div>
                <div>Trend: <span id="mtf-trend-4h">--</span></div>
              </div>
            </div>
          </div>
          <div style="margin-top:15px; padding:15px; background:rgba(0,212,255,0.05); border-radius:8px; border:1px solid rgba(0,212,255,0.2);">
            <div style="font-family:var(--font-tech); font-size:11px; color:var(--accent-cyan); margin-bottom:10px;">üìà MTF CONSENSUS</div>
            <div style="display:flex; justify-content:space-around; text-align:center;">
              <div>
                <div style="font-size:24px; font-weight:bold; color:var(--accent-green);" id="mtf-bullish-count">0</div>
                <div style="font-size:10px; color:var(--text-dim);">BULLISH</div>
              </div>
              <div>
                <div style="font-size:24px; font-weight:bold; color:var(--text-dim);" id="mtf-neutral-count">0</div>
                <div style="font-size:10px; color:var(--text-dim);">NEUTRAL</div>
              </div>
              <div>
                <div style="font-size:24px; font-weight:bold; color:var(--accent-red);" id="mtf-bearish-count">0</div>
                <div style="font-size:10px; color:var(--text-dim);">BEARISH</div>
              </div>
            </div>
            <div style="text-align:center; margin-top:10px; font-size:14px; font-weight:bold;" id="mtf-verdict">ANALYZING...</div>
          </div>
        </div>

        <!-- RISK CALCULATOR SECTION -->
        <div id="riskSection" class="tool-section">
          <div class="risk-grid">
            <div class="risk-inputs">
              <h3>üìù PARAMETERS</h3>
              <div class="input-group">
                <label>Account Balance (USDT)</label>
                <input type="number" id="riskBalance" value="1000" placeholder="1000">
              </div>
              <div class="input-group">
                <label>Risk per Trade (%)</label>
                <input type="number" id="riskPercent" value="2" step="0.5" placeholder="2">
              </div>
              <div class="input-row">
                <div class="input-group">
                  <label>Entry Price</label>
                  <input type="number" id="riskEntry" step="0.0001" placeholder="Current price">
                </div>
                <div class="input-group">
                  <label>Leverage (1-125x)</label>
                  <input type="number" id="riskLeverage" value="1" min="1" max="125" placeholder="1">
                </div>
              </div>
              <div class="input-row">
                <div class="input-group">
                  <label>Stop Loss Price</label>
                  <input type="number" id="riskSL" step="0.0001" placeholder="SL price">
                </div>
                <div class="input-group">
                  <label>Take Profit Price</label>
                  <input type="number" id="riskTP" step="0.0001" placeholder="TP price">
                </div>
              </div>
              <button class="add-alert-btn" onclick="calculateRisk()" style="margin-top:10px;">
                ‚ö° CALCULATE
              </button>
              <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="control-btn" onclick="setCurrentPriceAsEntry()" style="flex:1; padding:8px;">
                  üìç Use Current Price
                </button>
                <button class="control-btn" onclick="suggestSLTP()" style="flex:1; padding:8px;">
                  üéØ Auto SL/TP
                </button>
              </div>
            </div>

            <div class="risk-results">
              <h3>üìä RESULTS</h3>
              <div class="result-item">
                <span class="result-label">Risk Amount</span>
                <span class="result-value red" id="riskAmount">$0.00</span>
              </div>
              <div class="result-item">
                <span class="result-label">Position Size</span>
                <span class="result-value cyan" id="positionSize">0 XRP</span>
              </div>
              <div class="result-item">
                <span class="result-label">Position Value</span>
                <span class="result-value cyan" id="positionValue">$0.00</span>
              </div>
              <div class="result-item">
                <span class="result-label">Distance to SL</span>
                <span class="result-value red" id="slDistance">0%</span>
              </div>
              <div class="result-item">
                <span class="result-label">Distance to TP</span>
                <span class="result-value green" id="tpDistance">0%</span>
              </div>
              <div class="result-item">
                <span class="result-label">Potential Loss</span>
                <span class="result-value red" id="potentialLoss">-$0.00</span>
              </div>
              <div class="result-item">
                <span class="result-label">Potential Profit</span>
                <span class="result-value green" id="potentialProfit">+$0.00</span>
              </div>
              <div class="result-item">
                <span class="result-label">Liquidation Price</span>
                <span class="result-value red" id="liqPrice">$0.00</span>
              </div>
              <div class="risk-ratio">
                <div class="risk-ratio-value" id="rrRatio">0:0</div>
                <div class="risk-ratio-label">RISK:REWARD RATIO</div>
              </div>
            </div>
          </div>
        </div>

        <!-- PRICE ALERTS SECTION -->
        <div id="alertsSection" class="tool-section">
          <div class="alerts-container">
            <div class="alerts-form">
              <h3>‚ûï CREATE ALERT</h3>
              <div class="alert-type-btns">
                <button class="alert-type-btn active above" id="alertAboveBtn" onclick="setAlertType('above')">
                  üìà Price Above
                </button>
                <button class="alert-type-btn below" id="alertBelowBtn" onclick="setAlertType('below')">
                  üìâ Price Below
                </button>
              </div>
              <div class="input-group">
                <label>Alert Price (USDT)</label>
                <input type="number" id="customAlertPrice" step="0.0001" placeholder="Enter price...">
              </div>
              <div class="input-group">
                <label>Note (optional)</label>
                <input type="text" id="customAlertNote" placeholder="e.g., Resistance level" maxlength="50">
              </div>
              <button class="add-alert-btn" onclick="addCustomAlert()">
                üîî ADD ALERT
              </button>
              <div style="margin-top:15px; padding:12px; background:rgba(255,255,255,0.03); border-radius:8px;">
                <div style="font-size:10px; color:var(--text-dim); margin-bottom:8px;">QUICK ALERTS</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                  <button class="control-btn" onclick="addQuickAlert(1)" style="font-size:10px;">+1%</button>
                  <button class="control-btn" onclick="addQuickAlert(-1)" style="font-size:10px;">-1%</button>
                  <button class="control-btn" onclick="addQuickAlert(2.5)" style="font-size:10px;">+2.5%</button>
                  <button class="control-btn" onclick="addQuickAlert(-2.5)" style="font-size:10px;">-2.5%</button>
                  <button class="control-btn" onclick="addQuickAlert(5)" style="font-size:10px;">+5%</button>
                  <button class="control-btn" onclick="addQuickAlert(-5)" style="font-size:10px;">-5%</button>
                </div>
              </div>
            </div>

            <div class="alerts-list-panel">
              <h3>üìã ACTIVE ALERTS <span id="alertsCount" style="opacity:0.5; font-weight:normal;">(0)</span></h3>
              <div class="custom-alerts-list" id="customAlertsList">
                <div class="no-alerts">No alerts configured. Create your first alert!</div>
              </div>
              <button class="control-btn" onclick="clearAllAlerts()" style="width:100%; margin-top:10px; padding:10px; color:var(--accent-red);">
                üóëÔ∏è Clear All Alerts
              </button>
            </div>
          </div>
        </div>

        <!-- FIBONACCI SECTION -->
        <div id="fiboSection" class="tool-section">
          <div class="fibo-container">
            <div class="fibo-levels">
              <h3 style="font-family:var(--font-tech); font-size:12px; color:var(--accent-cyan); margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.05);">üìê FIBONACCI RETRACEMENT</h3>
              <div class="fibo-level-row">
                <span class="fibo-label">0% (High)</span>
                <div class="fibo-bar"><div class="fibo-bar-fill" style="width:100%; background:var(--accent-green);"></div></div>
                <span class="fibo-price c-green" id="fibo-0">--</span>
              </div>
              <div class="fibo-level-row">
                <span class="fibo-label">23.6%</span>
                <div class="fibo-bar"><div class="fibo-bar-fill" style="width:76.4%; background:var(--accent-cyan);"></div></div>
                <span class="fibo-price c-cyan" id="fibo-236">--</span>
              </div>
              <div class="fibo-level-row">
                <span class="fibo-label">38.2%</span>
                <div class="fibo-bar"><div class="fibo-bar-fill" style="width:61.8%; background:var(--accent-purple);"></div></div>
                <span class="fibo-price c-purple" id="fibo-382">--</span>
              </div>
              <div class="fibo-level-row">
                <span class="fibo-label">50%</span>
                <div class="fibo-bar"><div class="fibo-bar-fill" style="width:50%; background:var(--accent-orange);"></div></div>
                <span class="fibo-price c-orange" id="fibo-50">--</span>
              </div>
              <div class="fibo-level-row">
                <span class="fibo-label">61.8%</span>
                <div class="fibo-bar"><div class="fibo-bar-fill" style="width:38.2%; background:var(--accent-yellow);"></div></div>
                <span class="fibo-price" style="color:var(--accent-yellow);" id="fibo-618">--</span>
              </div>
              <div class="fibo-level-row">
                <span class="fibo-label">78.6%</span>
                <div class="fibo-bar"><div class="fibo-bar-fill" style="width:21.4%; background:var(--accent-red);"></div></div>
                <span class="fibo-price c-red" id="fibo-786">--</span>
              </div>
              <div class="fibo-level-row">
                <span class="fibo-label">100% (Low)</span>
                <div class="fibo-bar"><div class="fibo-bar-fill" style="width:0%; background:var(--accent-red);"></div></div>
                <span class="fibo-price c-red" id="fibo-100">--</span>
              </div>
              <div style="margin-top:15px; padding:12px; background:rgba(0,212,255,0.05); border-radius:8px; text-align:center;">
                <div style="font-size:10px; color:var(--text-dim);">CURRENT PRICE</div>
                <div style="font-family:var(--font-data); font-size:20px; color:var(--accent-cyan);" id="fibo-current">--</div>
                <div style="font-size:10px; color:var(--text-dim);" id="fibo-zone">--</div>
              </div>
            </div>
            <div class="fibo-info">
              <h3 style="font-family:var(--font-tech); font-size:12px; color:var(--accent-cyan); margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.05);">‚ÑπÔ∏è SWING DETECTION</h3>
              <div style="margin-bottom:15px;">
                <div style="font-size:10px; color:var(--text-dim); margin-bottom:5px;">SWING HIGH (24H)</div>
                <div style="font-family:var(--font-data); font-size:18px; color:var(--accent-green);" id="swing-high">--</div>
              </div>
              <div style="margin-bottom:15px;">
                <div style="font-size:10px; color:var(--text-dim); margin-bottom:5px;">SWING LOW (24H)</div>
                <div style="font-family:var(--font-data); font-size:18px; color:var(--accent-red);" id="swing-low">--</div>
              </div>
              <div style="margin-bottom:15px;">
                <div style="font-size:10px; color:var(--text-dim); margin-bottom:5px;">RANGE</div>
                <div style="font-family:var(--font-data); font-size:16px; color:var(--text-main);" id="fibo-range">--</div>
              </div>
              <div style="padding:15px; background:rgba(168,85,247,0.1); border-radius:8px; border:1px solid rgba(168,85,247,0.2);">
                <div style="font-size:11px; font-weight:600; color:var(--accent-purple); margin-bottom:8px;">üí° KEY LEVELS</div>
                <div style="font-size:10px; color:var(--text-dim); line-height:1.6;">
                  <div>‚Ä¢ <strong>38.2% & 61.8%</strong>: Strongest retracement zones</div>
                  <div>‚Ä¢ <strong>50%</strong>: Psychological level</div>
                  <div>‚Ä¢ <strong>78.6%</strong>: Last defense before trend reversal</div>
                </div>
              </div>
              <button class="add-alert-btn" onclick="updateFibonacci()" style="margin-top:15px;">üîÑ Refresh Levels</button>
            </div>
          </div>
        </div>

        <!-- SESSION STATS SECTION -->
        <div id="sessionSection" class="tool-section">
          <div class="session-grid">
            <div class="session-stat">
              <div class="session-stat-value c-cyan" id="session-duration">00:00:00</div>
              <div class="session-stat-label">Session Time</div>
            </div>
            <div class="session-stat">
              <div class="session-stat-value" id="session-high">--</div>
              <div class="session-stat-label">Session High</div>
            </div>
            <div class="session-stat">
              <div class="session-stat-value" id="session-low">--</div>
              <div class="session-stat-label">Session Low</div>
            </div>
            <div class="session-stat">
              <div class="session-stat-value" id="session-range">--</div>
              <div class="session-stat-label">Range %</div>
            </div>
            <div class="session-stat">
              <div class="session-stat-value c-green" id="session-signals-bull">0</div>
              <div class="session-stat-label">Bullish Signals</div>
            </div>
            <div class="session-stat">
              <div class="session-stat-value c-red" id="session-signals-bear">0</div>
              <div class="session-stat-label">Bearish Signals</div>
            </div>
            <div class="session-stat">
              <div class="session-stat-value c-purple" id="session-patterns">0</div>
              <div class="session-stat-label">Patterns Detected</div>
            </div>
            <div class="session-stat">
              <div class="session-stat-value c-orange" id="session-whales">0</div>
              <div class="session-stat-label">Whale Trades</div>
            </div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
            <div class="session-timeline">
              <div style="font-family:var(--font-tech); font-size:11px; color:var(--accent-cyan); margin-bottom:10px;">üìä PRICE ACTION</div>
              <div class="timeline-row">
                <span style="color:var(--text-dim);">Open Price</span>
                <span id="session-open" style="font-family:var(--font-data);">--</span>
              </div>
              <div class="timeline-row">
                <span style="color:var(--text-dim);">Current Price</span>
                <span id="session-current" style="font-family:var(--font-data);">--</span>
              </div>
              <div class="timeline-row">
                <span style="color:var(--text-dim);">Change</span>
                <span id="session-change" style="font-family:var(--font-data);">--</span>
              </div>
              <div class="timeline-row">
                <span style="color:var(--text-dim);">Volatility (ATR)</span>
                <span id="session-volatility" style="font-family:var(--font-data);">--</span>
              </div>
            </div>
            <div class="session-timeline">
              <div style="font-family:var(--font-tech); font-size:11px; color:var(--accent-cyan); margin-bottom:10px;">üéØ PREDICTIONS</div>
              <div class="timeline-row">
                <span style="color:var(--text-dim);">Total Predictions</span>
                <span id="session-predictions" style="font-family:var(--font-data);">0</span>
              </div>
              <div class="timeline-row">
                <span style="color:var(--text-dim);">Correct</span>
                <span id="session-correct" style="font-family:var(--font-data); color:var(--accent-green);">0</span>
              </div>
              <div class="timeline-row">
                <span style="color:var(--text-dim);">Incorrect</span>
                <span id="session-incorrect" style="font-family:var(--font-data); color:var(--accent-red);">0</span>
              </div>
              <div class="timeline-row">
                <span style="color:var(--text-dim);">Session Accuracy</span>
                <span id="session-accuracy" style="font-family:var(--font-data); color:var(--accent-cyan);">--%</span>
              </div>
            </div>
          </div>
          <button class="add-alert-btn" onclick="resetSessionStats()" style="margin-top:15px;">üîÑ Reset Session Stats</button>
        </div>

        <!-- STRATEGY BUILDER SECTION -->
        <div id="strategySection" class="tool-section">
          <div class="strategy-container">
            <div class="strategy-builder">
              <h3 style="font-family:var(--font-tech); font-size:12px; color:var(--accent-cyan); margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.05);">ü§ñ CREATE STRATEGY</h3>
              <div class="input-group">
                <label>Strategy Name</label>
                <input type="text" id="strategyName" placeholder="e.g., RSI Oversold Buy" maxlength="30">
              </div>
              <div style="font-size:10px; color:var(--text-dim); margin:10px 0 5px;">CONDITION 1</div>
              <div class="condition-row">
                <select id="strategy-ind-1">
                  <option value="rsi">RSI</option>
                  <option value="stochRsi">Stoch RSI</option>
                  <option value="macd">MACD</option>
                  <option value="price">Price</option>
                  <option value="volume">Volume 24h</option>
                  <option value="funding">Funding Rate</option>
                </select>
                <select id="strategy-op-1">
                  <option value="<">&lt; Less than</option>
                  <option value=">">&gt; Greater than</option>
                  <option value="cross_up">‚Üó Cross Up</option>
                  <option value="cross_down">‚Üò Cross Down</option>
                </select>
                <input type="number" id="strategy-val-1" placeholder="Value">
              </div>
              <div class="logic-connector">
                <select id="strategy-logic" style="background:rgba(168,85,247,0.2); border-color:var(--accent-purple); color:var(--accent-purple);">
                  <option value="AND">AND</option>
                  <option value="OR">OR</option>
                </select>
              </div>
              <div style="font-size:10px; color:var(--text-dim); margin:5px 0;">CONDITION 2 (optional)</div>
              <div class="condition-row">
                <select id="strategy-ind-2">
                  <option value="">-- None --</option>
                  <option value="rsi">RSI</option>
                  <option value="stochRsi">Stoch RSI</option>
                  <option value="macd">MACD</option>
                  <option value="price">Price</option>
                  <option value="volume">Volume 24h</option>
                  <option value="funding">Funding Rate</option>
                </select>
                <select id="strategy-op-2">
                  <option value="<">&lt; Less than</option>
                  <option value=">">&gt; Greater than</option>
                  <option value="cross_up">‚Üó Cross Up</option>
                  <option value="cross_down">‚Üò Cross Down</option>
                </select>
                <input type="number" id="strategy-val-2" placeholder="Value">
              </div>
              <div class="input-group" style="margin-top:15px;">
                <label>Alert Type</label>
                <select id="strategy-alert-type" style="width:100%; padding:10px;">
                  <option value="bullish">üü¢ Bullish Signal</option>
                  <option value="bearish">üî¥ Bearish Signal</option>
                  <option value="warning">üü† Warning</option>
                </select>
              </div>
              <button class="add-alert-btn" onclick="createStrategy()" style="margin-top:15px;">‚ûï Create Strategy</button>
            </div>
            <div class="strategy-list">
              <h3 style="font-family:var(--font-tech); font-size:12px; color:var(--accent-cyan); margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.05);">üìã MY STRATEGIES <span id="strategiesCount" style="opacity:0.5;">(0)</span></h3>
              <div id="strategiesList">
                <div class="no-alerts">No strategies created yet. Build your first strategy!</div>
              </div>
            </div>
          </div>
        </div>

        <!-- CORRELATION SECTION -->
        <div id="corrSection" class="tool-section">
          <div class="corr-grid">
            <div class="corr-card">
              <div class="corr-pair">XRP / BTC</div>
              <div class="corr-value positive" id="corr-btc">0.00</div>
              <div class="corr-label">24H CORRELATION</div>
              <div class="corr-bar"><div class="corr-bar-fill" id="corr-btc-bar" style="width:50%; background:var(--accent-green);"></div></div>
              <div style="margin-top:10px; font-size:10px; color:var(--text-dim);">
                BTC: <span id="corr-btc-price" style="color:var(--accent-cyan);">--</span>
                <span id="corr-btc-change">--</span>
              </div>
            </div>
            <div class="corr-card">
              <div class="corr-pair">XRP / ETH</div>
              <div class="corr-value positive" id="corr-eth">0.00</div>
              <div class="corr-label">24H CORRELATION</div>
              <div class="corr-bar"><div class="corr-bar-fill" id="corr-eth-bar" style="width:50%; background:var(--accent-green);"></div></div>
              <div style="margin-top:10px; font-size:10px; color:var(--text-dim);">
                ETH: <span id="corr-eth-price" style="color:var(--accent-cyan);">--</span>
                <span id="corr-eth-change">--</span>
              </div>
            </div>
            <div class="corr-card">
              <div class="corr-pair">XRP / SOL</div>
              <div class="corr-value positive" id="corr-sol">0.00</div>
              <div class="corr-label">24H CORRELATION</div>
              <div class="corr-bar"><div class="corr-bar-fill" id="corr-sol-bar" style="width:50%; background:var(--accent-green);"></div></div>
              <div style="margin-top:10px; font-size:10px; color:var(--text-dim);">
                SOL: <span id="corr-sol-price" style="color:var(--accent-cyan);">--</span>
                <span id="corr-sol-change">--</span>
              </div>
            </div>
          </div>
          <div style="margin-top:20px; padding:15px; background:rgba(0,212,255,0.05); border-radius:8px; border:1px solid rgba(0,212,255,0.2);">
            <div style="font-family:var(--font-tech); font-size:11px; color:var(--accent-cyan); margin-bottom:10px;">üìä CORRELATION GUIDE</div>
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:15px; text-align:center; font-size:10px;">
              <div>
                <div style="color:var(--accent-green); font-weight:bold;">+0.7 to +1.0</div>
                <div style="color:var(--text-dim);">Strong Positive</div>
                <div style="color:var(--text-dim); font-size:9px;">Move together</div>
              </div>
              <div>
                <div style="color:var(--accent-orange); font-weight:bold;">-0.3 to +0.3</div>
                <div style="color:var(--text-dim);">Weak/None</div>
                <div style="color:var(--text-dim); font-size:9px;">Independent</div>
              </div>
              <div>
                <div style="color:var(--accent-red); font-weight:bold;">-0.7 to -1.0</div>
                <div style="color:var(--text-dim);">Strong Negative</div>
                <div style="color:var(--text-dim); font-size:9px;">Move opposite</div>
              </div>
            </div>
          </div>
          <button class="add-alert-btn" onclick="updateCorrelations()" style="margin-top:15px;">üîÑ Refresh Correlations</button>
        </div>

        <!-- WATCHLIST SECTION -->
        <div id="watchlistSection" class="tool-section">
          <div class="watchlist-grid" id="watchlistGrid">
            <div class="watchlist-card" data-symbol="BTCUSDT">
              <div class="watchlist-icon">‚Çø</div>
              <div class="watchlist-info">
                <div class="watchlist-symbol">BTC</div>
                <div class="watchlist-name">Bitcoin</div>
              </div>
              <div class="watchlist-mini-chart" id="chart-btc"></div>
              <div class="watchlist-price">
                <div class="watchlist-price-value" id="watch-btc-price">--</div>
                <div class="watchlist-change" id="watch-btc-change">--</div>
              </div>
            </div>
            <div class="watchlist-card" data-symbol="ETHUSDT">
              <div class="watchlist-icon">Œû</div>
              <div class="watchlist-info">
                <div class="watchlist-symbol">ETH</div>
                <div class="watchlist-name">Ethereum</div>
              </div>
              <div class="watchlist-mini-chart" id="chart-eth"></div>
              <div class="watchlist-price">
                <div class="watchlist-price-value" id="watch-eth-price">--</div>
                <div class="watchlist-change" id="watch-eth-change">--</div>
              </div>
            </div>
            <div class="watchlist-card" data-symbol="SOLUSDT">
              <div class="watchlist-icon">‚óé</div>
              <div class="watchlist-info">
                <div class="watchlist-symbol">SOL</div>
                <div class="watchlist-name">Solana</div>
              </div>
              <div class="watchlist-mini-chart" id="chart-sol"></div>
              <div class="watchlist-price">
                <div class="watchlist-price-value" id="watch-sol-price">--</div>
                <div class="watchlist-change" id="watch-sol-change">--</div>
              </div>
            </div>
            <div class="watchlist-card" data-symbol="XRPUSDT">
              <div class="watchlist-icon" style="background:rgba(0,212,255,0.2);">‚úï</div>
              <div class="watchlist-info">
                <div class="watchlist-symbol" style="color:var(--accent-cyan);">XRP</div>
                <div class="watchlist-name">Ripple</div>
              </div>
              <div class="watchlist-mini-chart" id="chart-xrp"></div>
              <div class="watchlist-price">
                <div class="watchlist-price-value" id="watch-xrp-price" style="color:var(--accent-cyan);">--</div>
                <div class="watchlist-change" id="watch-xrp-change">--</div>
              </div>
            </div>
            <div class="watchlist-card" data-symbol="ADAUSDT">
              <div class="watchlist-icon">‚Ç≥</div>
              <div class="watchlist-info">
                <div class="watchlist-symbol">ADA</div>
                <div class="watchlist-name">Cardano</div>
              </div>
              <div class="watchlist-mini-chart" id="chart-ada"></div>
              <div class="watchlist-price">
                <div class="watchlist-price-value" id="watch-ada-price">--</div>
                <div class="watchlist-change" id="watch-ada-change">--</div>
              </div>
            </div>
            <div class="watchlist-card" data-symbol="DOGEUSDT">
              <div class="watchlist-icon">√ê</div>
              <div class="watchlist-info">
                <div class="watchlist-symbol">DOGE</div>
                <div class="watchlist-name">Dogecoin</div>
              </div>
              <div class="watchlist-mini-chart" id="chart-doge"></div>
              <div class="watchlist-price">
                <div class="watchlist-price-value" id="watch-doge-price">--</div>
                <div class="watchlist-change" id="watch-doge-change">--</div>
              </div>
            </div>
          </div>
          <div style="margin-top:20px; padding:15px; background:rgba(0,0,0,0.2); border-radius:8px;">
            <div style="font-family:var(--font-tech); font-size:11px; color:var(--accent-cyan); margin-bottom:10px;">üìà MARKET OVERVIEW</div>
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:15px; text-align:center;">
              <div>
                <div style="font-size:10px; color:var(--text-dim);">TOTAL MARKET CAP</div>
                <div style="font-family:var(--font-data); font-size:16px; color:var(--text-main);" id="total-mcap">--</div>
              </div>
              <div>
                <div style="font-size:10px; color:var(--text-dim);">BTC DOMINANCE</div>
                <div style="font-family:var(--font-data); font-size:16px; color:var(--accent-orange);" id="btc-dom">--</div>
              </div>
              <div>
                <div style="font-size:10px; color:var(--text-dim);">24H VOLUME</div>
                <div style="font-family:var(--font-data); font-size:16px; color:var(--accent-purple);" id="total-vol">--</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // TOOLS PANEL FUNCTIONALITY
    // ============================================

    // State for tools
    const toolsState = {
      alertType: 'above',
      customAlerts: [],
      mtfData: {}
    };

    // Toggle tools panel
    function toggleToolsPanel() {
      const overlay = document.getElementById('toolsOverlay');
      overlay.classList.toggle('active');
      if (overlay.classList.contains('active')) {
        updateMultiTimeframe();
        setCurrentPriceAsEntry();
      }
    }

    function closeToolsIfClickOutside(e) {
      if (e.target.id === 'toolsOverlay') {
        toggleToolsPanel();
      }
    }

    // Switch between tool tabs
    function switchToolTab(tab) {
      document.querySelectorAll('.tools-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tool-section').forEach(s => s.classList.remove('active'));
      
      document.querySelector(`[onclick="switchToolTab('${tab}')"]`).classList.add('active');
      document.getElementById(tab + 'Section').classList.add('active');
    }

    // ============================================
    // 1. MULTI-TIMEFRAME ANALYSIS
    // ============================================

    async function fetchTimeframeData(tf) {
      try {
        const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=XRPUSDT&interval=${tf}&limit=100`);
        const data = await response.json();
        return data.map(k => ({
          open: parseFloat(k[1]),
          high: parseFloat(k[2]),
          low: parseFloat(k[3]),
          close: parseFloat(k[4]),
          volume: parseFloat(k[5])
        }));
      } catch (e) {
        console.error('Error fetching ' + tf, e);
        return null;
      }
    }

    function calculateTFIndicators(candles) {
      if (!candles || candles.length < 26) return null;
      
      const closes = candles.map(c => c.close);
      const currentPrice = closes[closes.length - 1];
      
      // RSI
      let gains = 0, losses = 0;
      for (let i = closes.length - 14; i < closes.length; i++) {
        const diff = closes[i] - closes[i - 1];
        if (diff > 0) gains += diff;
        else losses -= diff;
      }
      const avgGain = gains / 14;
      const avgLoss = losses / 14;
      const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
      const rsi = 100 - (100 / (1 + rs));

      // EMA helper
      const ema = (data, period) => {
        const k = 2 / (period + 1);
        let ema = data.slice(0, period).reduce((a, b) => a + b, 0) / period;
        for (let i = period; i < data.length; i++) {
          ema = data[i] * k + ema * (1 - k);
        }
        return ema;
      };

      // MACD
      const ema12 = ema(closes, 12);
      const ema26 = ema(closes, 26);
      const macdLine = ema12 - ema26;

      // Trend (EMA 9 vs 21)
      const ema9 = ema(closes, 9);
      const ema21 = ema(closes, 21);
      const trend = ema9 > ema21 ? 'UP' : ema9 < ema21 ? 'DOWN' : 'FLAT';

      // Signal
      let signal = 'NEUTRAL';
      let bullScore = 0, bearScore = 0;
      
      if (rsi < 30) bullScore += 2;
      else if (rsi > 70) bearScore += 2;
      
      if (macdLine > 0) bullScore++;
      else if (macdLine < 0) bearScore++;
      
      if (trend === 'UP') bullScore++;
      else if (trend === 'DOWN') bearScore++;

      if (bullScore >= 3) signal = 'BULLISH';
      else if (bearScore >= 3) signal = 'BEARISH';

      return { price: currentPrice, rsi, macd: macdLine, trend, signal };
    }

    async function updateMultiTimeframe() {
      const timeframes = ['1m', '5m', '15m', '1h', '4h'];
      let bullish = 0, bearish = 0, neutral = 0;

      for (const tf of timeframes) {
        const candles = await fetchTimeframeData(tf);
        const indicators = calculateTFIndicators(candles);
        
        if (indicators) {
          toolsState.mtfData[tf] = indicators;
          
          // Update card
          const card = document.querySelector(`.mtf-card[data-tf="${tf}"]`);
          document.getElementById(`mtf-price-${tf}`).textContent = '$' + indicators.price.toFixed(4);
          
          const signalEl = document.getElementById(`mtf-signal-${tf}`);
          signalEl.textContent = indicators.signal;
          signalEl.className = 'mtf-signal ' + indicators.signal.toLowerCase();
          
          const rsiEl = document.getElementById(`mtf-rsi-${tf}`);
          rsiEl.textContent = indicators.rsi.toFixed(1);
          rsiEl.className = 'mtf-rsi ' + (indicators.rsi < 30 ? 'oversold' : indicators.rsi > 70 ? 'overbought' : 'neutral');
          
          document.getElementById(`mtf-macd-${tf}`).textContent = indicators.macd > 0 ? 'üìà' : indicators.macd < 0 ? 'üìâ' : '‚û°Ô∏è';
          document.getElementById(`mtf-trend-${tf}`).textContent = indicators.trend;

          // Update card border
          card.className = 'mtf-card ' + (indicators.signal === 'BULLISH' ? 'bullish' : indicators.signal === 'BEARISH' ? 'bearish' : '');

          // Count signals
          if (indicators.signal === 'BULLISH') bullish++;
          else if (indicators.signal === 'BEARISH') bearish++;
          else neutral++;
        }
      }

      // Update consensus
      document.getElementById('mtf-bullish-count').textContent = bullish;
      document.getElementById('mtf-neutral-count').textContent = neutral;
      document.getElementById('mtf-bearish-count').textContent = bearish;

      const verdict = document.getElementById('mtf-verdict');
      if (bullish >= 4) {
        verdict.textContent = 'üöÄ STRONG BULLISH';
        verdict.style.color = 'var(--accent-green)';
      } else if (bearish >= 4) {
        verdict.textContent = 'üîª STRONG BEARISH';
        verdict.style.color = 'var(--accent-red)';
      } else if (bullish > bearish) {
        verdict.textContent = 'üìà BULLISH BIAS';
        verdict.style.color = 'var(--accent-green)';
      } else if (bearish > bullish) {
        verdict.textContent = 'üìâ BEARISH BIAS';
        verdict.style.color = 'var(--accent-red)';
      } else {
        verdict.textContent = '‚öñÔ∏è MIXED SIGNALS';
        verdict.style.color = 'var(--accent-orange)';
      }
    }

    // ============================================
    // 2. RISK CALCULATOR
    // ============================================

    function setCurrentPriceAsEntry() {
      const currentPrice = state.price || 0;
      document.getElementById('riskEntry').value = currentPrice.toFixed(4);
    }

    function suggestSLTP() {
      const entry = parseFloat(document.getElementById('riskEntry').value);
      if (!entry) {
        alert('Please set entry price first');
        return;
      }
      // 2% SL, 4% TP (1:2 ratio)
      document.getElementById('riskSL').value = (entry * 0.98).toFixed(4);
      document.getElementById('riskTP').value = (entry * 1.04).toFixed(4);
      calculateRisk();
    }

    function calculateRisk() {
      const balance = parseFloat(document.getElementById('riskBalance').value) || 0;
      const riskPct = parseFloat(document.getElementById('riskPercent').value) || 0;
      const entry = parseFloat(document.getElementById('riskEntry').value) || 0;
      const sl = parseFloat(document.getElementById('riskSL').value) || 0;
      const tp = parseFloat(document.getElementById('riskTP').value) || 0;
      const leverage = parseFloat(document.getElementById('riskLeverage').value) || 1;

      if (!entry || !sl) {
        alert('Please fill Entry and Stop Loss prices');
        return;
      }

      // Calculations
      const riskAmount = balance * (riskPct / 100);
      const slDistancePct = Math.abs((entry - sl) / entry) * 100;
      const tpDistancePct = tp ? Math.abs((tp - entry) / entry) * 100 : 0;
      
      // Position size based on risk
      const positionValue = riskAmount / (slDistancePct / 100);
      const positionSize = positionValue / entry;
      
      // Actual position with leverage
      const leveragedPosition = positionValue * leverage;
      const actualXRP = leveragedPosition / entry;

      // P&L
      const potentialLoss = riskAmount;
      const potentialProfit = tp ? positionValue * (tpDistancePct / 100) : 0;

      // Risk:Reward ratio
      const rr = potentialProfit > 0 ? (potentialProfit / potentialLoss).toFixed(2) : 0;

      // Liquidation price (simplified)
      const liqPrice = entry > sl 
        ? entry * (1 - (1 / leverage) + 0.005) // Long
        : entry * (1 + (1 / leverage) - 0.005); // Short

      // Update UI
      document.getElementById('riskAmount').textContent = '$' + riskAmount.toFixed(2);
      document.getElementById('positionSize').textContent = actualXRP.toFixed(2) + ' XRP';
      document.getElementById('positionValue').textContent = '$' + leveragedPosition.toFixed(2);
      document.getElementById('slDistance').textContent = slDistancePct.toFixed(2) + '%';
      document.getElementById('tpDistance').textContent = tp ? tpDistancePct.toFixed(2) + '%' : '--';
      document.getElementById('potentialLoss').textContent = '-$' + potentialLoss.toFixed(2);
      document.getElementById('potentialProfit').textContent = tp ? '+$' + potentialProfit.toFixed(2) : '--';
      document.getElementById('liqPrice').textContent = leverage > 1 ? '$' + liqPrice.toFixed(4) : 'N/A (Spot)';
      document.getElementById('rrRatio').textContent = '1:' + rr;

      // Color code RR ratio
      const rrEl = document.getElementById('rrRatio');
      if (rr >= 2) rrEl.style.color = 'var(--accent-green)';
      else if (rr >= 1) rrEl.style.color = 'var(--accent-orange)';
      else rrEl.style.color = 'var(--accent-red)';
    }

    // ============================================
    // 3. CUSTOM PRICE ALERTS
    // ============================================

    function setAlertType(type) {
      toolsState.alertType = type;
      document.getElementById('alertAboveBtn').classList.remove('active');
      document.getElementById('alertBelowBtn').classList.remove('active');
      document.getElementById('alert' + type.charAt(0).toUpperCase() + type.slice(1) + 'Btn').classList.add('active');
    }

    function addCustomAlert() {
      const price = parseFloat(document.getElementById('customAlertPrice').value);
      const note = document.getElementById('customAlertNote').value || '';
      
      if (!price) {
        alert('Please enter a valid price');
        return;
      }

      const alert = {
        id: Date.now(),
        price: price,
        type: toolsState.alertType,
        note: note,
        triggered: false,
        createdAt: new Date().toISOString()
      };

      toolsState.customAlerts.push(alert);
      saveCustomAlerts();
      renderCustomAlerts();
      
      document.getElementById('customAlertPrice').value = '';
      document.getElementById('customAlertNote').value = '';
      
      addAlert(`Price alert set: ${toolsState.alertType === 'above' ? 'üìà' : 'üìâ'} $${price.toFixed(4)}`, 'info');
    }

    function addQuickAlert(pct) {
      const currentPrice = state.price || 0;
      if (!currentPrice) return;
      
      const alertPrice = currentPrice * (1 + pct / 100);
      const alert = {
        id: Date.now(),
        price: alertPrice,
        type: pct > 0 ? 'above' : 'below',
        note: `${pct > 0 ? '+' : ''}${pct}% from $${currentPrice.toFixed(4)}`,
        triggered: false,
        createdAt: new Date().toISOString()
      };

      toolsState.customAlerts.push(alert);
      saveCustomAlerts();
      renderCustomAlerts();
      
      addAlert(`Quick alert set: ${pct > 0 ? 'üìà' : 'üìâ'} $${alertPrice.toFixed(4)} (${pct > 0 ? '+' : ''}${pct}%)`, 'info');
    }

    function deleteCustomAlert(id) {
      toolsState.customAlerts = toolsState.customAlerts.filter(a => a.id !== id);
      saveCustomAlerts();
      renderCustomAlerts();
    }

    function clearAllAlerts() {
      if (confirm('Are you sure you want to delete all alerts?')) {
        toolsState.customAlerts = [];
        saveCustomAlerts();
        renderCustomAlerts();
      }
    }

    function renderCustomAlerts() {
      const container = document.getElementById('customAlertsList');
      const activeAlerts = toolsState.customAlerts.filter(a => !a.triggered);
      
      document.getElementById('alertsCount').textContent = `(${activeAlerts.length})`;

      if (activeAlerts.length === 0) {
        container.innerHTML = '<div class="no-alerts">No alerts configured. Create your first alert!</div>';
        return;
      }

      container.innerHTML = activeAlerts
        .sort((a, b) => b.price - a.price)
        .map(alert => `
          <div class="custom-alert-item ${alert.type} ${alert.triggered ? 'triggered' : ''}">
            <div class="alert-info">
              <div class="alert-price">${alert.type === 'above' ? 'üìà' : 'üìâ'} $${alert.price.toFixed(4)}</div>
              <div class="alert-condition">${alert.type === 'above' ? 'When price goes above' : 'When price goes below'}${alert.note ? ' ‚Ä¢ ' + alert.note : ''}</div>
            </div>
            <button class="alert-delete" onclick="deleteCustomAlert(${alert.id})">‚úï</button>
          </div>
        `).join('');
    }

    function checkCustomAlerts(currentPrice) {
      if (!currentPrice || toolsState.customAlerts.length === 0) return;

      toolsState.customAlerts.forEach(alert => {
        if (alert.triggered) return;

        const triggered = (alert.type === 'above' && currentPrice >= alert.price) ||
                         (alert.type === 'below' && currentPrice <= alert.price);

        if (triggered) {
          alert.triggered = true;
          saveCustomAlerts();
          renderCustomAlerts();
          
          // Play sound and add alert
          const msg = `üîî PRICE ALERT: XRP ${alert.type === 'above' ? 'reached' : 'dropped to'} $${alert.price.toFixed(4)}${alert.note ? ' (' + alert.note + ')' : ''}`;
          addAlert(msg, alert.type === 'above' ? 'bullish' : 'bearish');
          
          // Browser notification
          if (Notification.permission === 'granted') {
            new Notification('XRP ORACULUM Alert', { body: msg, icon: 'üîî' });
          }
        }
      });
    }

    function saveCustomAlerts() {
      try {
        localStorage.setItem('xrp_oraculum_alerts', JSON.stringify(toolsState.customAlerts));
      } catch (e) {}
    }

    function loadCustomAlerts() {
      try {
        const saved = localStorage.getItem('xrp_oraculum_alerts');
        if (saved) {
          toolsState.customAlerts = JSON.parse(saved);
          renderCustomAlerts();
        }
      } catch (e) {}
      
      // Request notification permission
      if (Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    // Hook into price updates to check alerts
    const originalUpdatePrice = window.updateUI || function(){};
    const checkAlertsInterval = setInterval(() => {
      if (state.price) {
        checkCustomAlerts(state.price);
        checkStrategies();
      }
    }, 1000);

    // ============================================
    // 4. FIBONACCI AUTO-LEVELS
    // ============================================

    async function updateFibonacci() {
      try {
        // Fetch 24h klines for swing detection
        const response = await fetch('https://api.binance.com/api/v3/klines?symbol=XRPUSDT&interval=1h&limit=24');
        const data = await response.json();
        
        if (!data || data.length === 0) return;

        // Find swing high and low
        let high = 0, low = Infinity;
        data.forEach(k => {
          const h = parseFloat(k[2]);
          const l = parseFloat(k[3]);
          if (h > high) high = h;
          if (l < low) low = l;
        });

        const range = high - low;
        const currentPrice = state.price || parseFloat(data[data.length - 1][4]);

        // Calculate Fibonacci levels
        const levels = {
          '0': high,
          '236': high - (range * 0.236),
          '382': high - (range * 0.382),
          '50': high - (range * 0.5),
          '618': high - (range * 0.618),
          '786': high - (range * 0.786),
          '100': low
        };

        // Update UI
        document.getElementById('fibo-0').textContent = '$' + levels['0'].toFixed(4);
        document.getElementById('fibo-236').textContent = '$' + levels['236'].toFixed(4);
        document.getElementById('fibo-382').textContent = '$' + levels['382'].toFixed(4);
        document.getElementById('fibo-50').textContent = '$' + levels['50'].toFixed(4);
        document.getElementById('fibo-618').textContent = '$' + levels['618'].toFixed(4);
        document.getElementById('fibo-786').textContent = '$' + levels['786'].toFixed(4);
        document.getElementById('fibo-100').textContent = '$' + levels['100'].toFixed(4);
        
        document.getElementById('swing-high').textContent = '$' + high.toFixed(4);
        document.getElementById('swing-low').textContent = '$' + low.toFixed(4);
        document.getElementById('fibo-range').textContent = '$' + range.toFixed(4) + ' (' + ((range/low)*100).toFixed(2) + '%)';
        document.getElementById('fibo-current').textContent = '$' + currentPrice.toFixed(4);

        // Determine zone
        let zone = '';
        if (currentPrice > levels['236']) zone = 'Above 23.6% - Strong bullish zone';
        else if (currentPrice > levels['382']) zone = 'Between 23.6% - 38.2%';
        else if (currentPrice > levels['50']) zone = 'Between 38.2% - 50% - Key support zone';
        else if (currentPrice > levels['618']) zone = 'Between 50% - 61.8% - Critical zone';
        else if (currentPrice > levels['786']) zone = 'Between 61.8% - 78.6% - Danger zone';
        else zone = 'Below 78.6% - Potential reversal';
        
        document.getElementById('fibo-zone').textContent = zone;

      } catch (e) {
        console.error('Fibonacci error:', e);
      }
    }

    // ============================================
    // 5. SESSION STATS
    // ============================================

    const sessionStats = {
      startTime: Date.now(),
      startPrice: null,
      high: 0,
      low: Infinity,
      bullishSignals: 0,
      bearishSignals: 0,
      patternsDetected: 0,
      whaleTrades: 0,
      predictions: 0,
      correct: 0,
      incorrect: 0
    };

    function updateSessionStats() {
      const now = Date.now();
      const elapsed = now - sessionStats.startTime;
      const hours = Math.floor(elapsed / 3600000);
      const mins = Math.floor((elapsed % 3600000) / 60000);
      const secs = Math.floor((elapsed % 60000) / 1000);
      
      document.getElementById('session-duration').textContent = 
        String(hours).padStart(2, '0') + ':' + String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');

      if (state.price) {
        if (sessionStats.startPrice === null) sessionStats.startPrice = state.price;
        if (state.price > sessionStats.high) sessionStats.high = state.price;
        if (state.price < sessionStats.low) sessionStats.low = state.price;

        document.getElementById('session-high').textContent = '$' + sessionStats.high.toFixed(4);
        document.getElementById('session-high').style.color = 'var(--accent-green)';
        document.getElementById('session-low').textContent = '$' + sessionStats.low.toFixed(4);
        document.getElementById('session-low').style.color = 'var(--accent-red)';
        
        const range = ((sessionStats.high - sessionStats.low) / sessionStats.low * 100);
        document.getElementById('session-range').textContent = range.toFixed(2) + '%';
        document.getElementById('session-range').style.color = range > 2 ? 'var(--accent-orange)' : 'var(--text-main)';
        
        document.getElementById('session-open').textContent = '$' + sessionStats.startPrice.toFixed(4);
        document.getElementById('session-current').textContent = '$' + state.price.toFixed(4);
        
        const change = ((state.price - sessionStats.startPrice) / sessionStats.startPrice * 100);
        document.getElementById('session-change').textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
        document.getElementById('session-change').style.color = change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
      }

      document.getElementById('session-signals-bull').textContent = sessionStats.bullishSignals;
      document.getElementById('session-signals-bear').textContent = sessionStats.bearishSignals;
      document.getElementById('session-patterns').textContent = sessionStats.patternsDetected;
      document.getElementById('session-whales').textContent = sessionStats.whaleTrades;
      
      document.getElementById('session-predictions').textContent = sessionStats.predictions;
      document.getElementById('session-correct').textContent = sessionStats.correct;
      document.getElementById('session-incorrect').textContent = sessionStats.incorrect;
      
      const accuracy = sessionStats.predictions > 0 ? (sessionStats.correct / sessionStats.predictions * 100) : 0;
      document.getElementById('session-accuracy').textContent = accuracy.toFixed(1) + '%';
    }

    function resetSessionStats() {
      if (confirm('Reset all session statistics?')) {
        sessionStats.startTime = Date.now();
        sessionStats.startPrice = state.price;
        sessionStats.high = state.price || 0;
        sessionStats.low = state.price || Infinity;
        sessionStats.bullishSignals = 0;
        sessionStats.bearishSignals = 0;
        sessionStats.patternsDetected = 0;
        sessionStats.whaleTrades = 0;
        sessionStats.predictions = 0;
        sessionStats.correct = 0;
        sessionStats.incorrect = 0;
        updateSessionStats();
        addAlert('Session stats reset', 'info');
      }
    }

    // Track signals for session
    const originalAddAlert = window.addAlert;
    window.addAlert = function(msg, type) {
      if (type === 'bullish') sessionStats.bullishSignals++;
      if (type === 'bearish') sessionStats.bearishSignals++;
      if (msg.includes('pattern') || msg.includes('Pattern')) sessionStats.patternsDetected++;
      if (msg.includes('Whale') || msg.includes('whale')) sessionStats.whaleTrades++;
      originalAddAlert(msg, type);
    };

    // Update session stats every second
    setInterval(updateSessionStats, 1000);

    // ============================================
    // 6. STRATEGY BUILDER
    // ============================================

    let customStrategies = [];

    function createStrategy() {
      const name = document.getElementById('strategyName').value.trim();
      if (!name) {
        alert('Please enter a strategy name');
        return;
      }

      const ind1 = document.getElementById('strategy-ind-1').value;
      const op1 = document.getElementById('strategy-op-1').value;
      const val1 = document.getElementById('strategy-val-1').value;
      const logic = document.getElementById('strategy-logic').value;
      const ind2 = document.getElementById('strategy-ind-2').value;
      const op2 = document.getElementById('strategy-op-2').value;
      const val2 = document.getElementById('strategy-val-2').value;
      const alertType = document.getElementById('strategy-alert-type').value;

      if (!val1) {
        alert('Please enter a value for condition 1');
        return;
      }

      const strategy = {
        id: Date.now(),
        name: name,
        condition1: { indicator: ind1, operator: op1, value: parseFloat(val1) },
        logic: logic,
        condition2: ind2 ? { indicator: ind2, operator: op2, value: parseFloat(val2) } : null,
        alertType: alertType,
        active: true,
        triggered: false,
        lastTriggered: null
      };

      customStrategies.push(strategy);
      saveStrategies();
      renderStrategies();
      
      // Clear form
      document.getElementById('strategyName').value = '';
      document.getElementById('strategy-val-1').value = '';
      document.getElementById('strategy-val-2').value = '';
      document.getElementById('strategy-ind-2').value = '';
      
      addAlert(`Strategy created: ${name}`, 'info');
    }

    function getIndicatorValue(indicator) {
      switch(indicator) {
        case 'rsi': return state.indicators?.rsi || 50;
        case 'stochRsi': return state.indicators?.stochRsi || 50;
        case 'macd': return state.indicators?.macd || 0;
        case 'price': return state.price || 0;
        case 'volume': return state.volume24h || 0;
        case 'funding': return state.fundingRate || 0;
        default: return 0;
      }
    }

    function evaluateCondition(condition, prevValue) {
      const currentValue = getIndicatorValue(condition.indicator);
      switch(condition.operator) {
        case '<': return currentValue < condition.value;
        case '>': return currentValue > condition.value;
        case 'cross_up': return prevValue < condition.value && currentValue >= condition.value;
        case 'cross_down': return prevValue > condition.value && currentValue <= condition.value;
        default: return false;
      }
    }

    const prevIndicatorValues = {};

    function checkStrategies() {
      customStrategies.forEach(strategy => {
        if (!strategy.active) return;
        
        // Cooldown: don't trigger same strategy within 60 seconds
        if (strategy.lastTriggered && Date.now() - strategy.lastTriggered < 60000) return;

        const cond1Met = evaluateCondition(strategy.condition1, prevIndicatorValues[strategy.condition1.indicator]);
        let result = cond1Met;

        if (strategy.condition2) {
          const cond2Met = evaluateCondition(strategy.condition2, prevIndicatorValues[strategy.condition2.indicator]);
          result = strategy.logic === 'AND' ? (cond1Met && cond2Met) : (cond1Met || cond2Met);
        }

        if (result) {
          strategy.lastTriggered = Date.now();
          const msg = `ü§ñ Strategy "${strategy.name}" triggered!`;
          addAlert(msg, strategy.alertType);
          
          if (Notification.permission === 'granted') {
            new Notification('XRP ORACULUM Strategy', { body: msg });
          }
        }
      });

      // Store previous values for cross detection
      prevIndicatorValues.rsi = state.indicators?.rsi || 50;
      prevIndicatorValues.stochRsi = state.indicators?.stochRsi || 50;
      prevIndicatorValues.macd = state.indicators?.macd || 0;
      prevIndicatorValues.price = state.price || 0;
    }

    function toggleStrategy(id) {
      const strategy = customStrategies.find(s => s.id === id);
      if (strategy) {
        strategy.active = !strategy.active;
        saveStrategies();
        renderStrategies();
      }
    }

    function deleteStrategy(id) {
      customStrategies = customStrategies.filter(s => s.id !== id);
      saveStrategies();
      renderStrategies();
    }

    function renderStrategies() {
      const container = document.getElementById('strategiesList');
      document.getElementById('strategiesCount').textContent = `(${customStrategies.length})`;

      if (customStrategies.length === 0) {
        container.innerHTML = '<div class="no-alerts">No strategies created yet. Build your first strategy!</div>';
        return;
      }

      container.innerHTML = customStrategies.map(s => {
        const cond1Text = `${s.condition1.indicator.toUpperCase()} ${s.condition1.operator} ${s.condition1.value}`;
        const cond2Text = s.condition2 ? ` ${s.logic} ${s.condition2.indicator.toUpperCase()} ${s.condition2.operator} ${s.condition2.value}` : '';
        
        return `
          <div class="strategy-item ${s.active ? 'active' : ''}">
            <div class="strategy-item-header">
              <span class="strategy-item-name">${s.name}</span>
              <div style="display:flex; align-items:center; gap:10px;">
                <div class="strategy-item-toggle ${s.active ? 'active' : ''}" onclick="toggleStrategy(${s.id})"></div>
                <button class="alert-delete" onclick="deleteStrategy(${s.id})">‚úï</button>
              </div>
            </div>
            <div class="strategy-conditions">
              IF ${cond1Text}${cond2Text} ‚Üí ${s.alertType.toUpperCase()} alert
            </div>
          </div>
        `;
      }).join('');
    }

    function saveStrategies() {
      try {
        localStorage.setItem('xrp_oraculum_strategies', JSON.stringify(customStrategies));
      } catch(e) {}
    }

    function loadStrategies() {
      try {
        const saved = localStorage.getItem('xrp_oraculum_strategies');
        if (saved) {
          customStrategies = JSON.parse(saved);
          renderStrategies();
        }
      } catch(e) {}
    }

    // ============================================
    // 7. CORRELATION TRACKER
    // ============================================

    async function updateCorrelations() {
      const pairs = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT'];
      const xrpData = await fetchPriceHistory('XRPUSDT');
      
      for (const pair of pairs) {
        const pairData = await fetchPriceHistory(pair);
        if (xrpData && pairData) {
          const corr = calculateCorrelation(xrpData.returns, pairData.returns);
          const symbol = pair.replace('USDT', '').toLowerCase();
          
          const corrEl = document.getElementById(`corr-${symbol}`);
          corrEl.textContent = corr.toFixed(2);
          corrEl.className = 'corr-value ' + (corr > 0.3 ? 'positive' : corr < -0.3 ? 'negative' : 'neutral');
          
          const barEl = document.getElementById(`corr-${symbol}-bar`);
          barEl.style.width = (Math.abs(corr) * 100) + '%';
          barEl.style.background = corr > 0 ? 'var(--accent-green)' : 'var(--accent-red)';
          
          document.getElementById(`corr-${symbol}-price`).textContent = '$' + pairData.price.toFixed(symbol === 'btc' ? 0 : 2);
          const changeEl = document.getElementById(`corr-${symbol}-change`);
          changeEl.textContent = (pairData.change >= 0 ? '+' : '') + pairData.change.toFixed(2) + '%';
          changeEl.style.color = pairData.change >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
        }
      }
    }

    async function fetchPriceHistory(symbol) {
      try {
        const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1h&limit=24`);
        const data = await response.json();
        
        const closes = data.map(k => parseFloat(k[4]));
        const returns = [];
        for (let i = 1; i < closes.length; i++) {
          returns.push((closes[i] - closes[i-1]) / closes[i-1]);
        }
        
        const price = closes[closes.length - 1];
        const change = ((closes[closes.length - 1] - closes[0]) / closes[0]) * 100;
        
        return { returns, price, change };
      } catch(e) {
        return null;
      }
    }

    function calculateCorrelation(arr1, arr2) {
      const n = Math.min(arr1.length, arr2.length);
      if (n === 0) return 0;
      
      const mean1 = arr1.reduce((a, b) => a + b, 0) / n;
      const mean2 = arr2.reduce((a, b) => a + b, 0) / n;
      
      let num = 0, den1 = 0, den2 = 0;
      for (let i = 0; i < n; i++) {
        const d1 = arr1[i] - mean1;
        const d2 = arr2[i] - mean2;
        num += d1 * d2;
        den1 += d1 * d1;
        den2 += d2 * d2;
      }
      
      return den1 && den2 ? num / Math.sqrt(den1 * den2) : 0;
    }

    // ============================================
    // 8. WATCHLIST
    // ============================================

    const watchlistSymbols = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT', 'XRPUSDT', 'ADAUSDT', 'DOGEUSDT'];

    async function updateWatchlist() {
      for (const symbol of watchlistSymbols) {
        try {
          const response = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${symbol}`);
          const data = await response.json();
          
          const shortSymbol = symbol.replace('USDT', '').toLowerCase();
          const price = parseFloat(data.lastPrice);
          const change = parseFloat(data.priceChangePercent);
          
          const priceEl = document.getElementById(`watch-${shortSymbol}-price`);
          const changeEl = document.getElementById(`watch-${shortSymbol}-change`);
          
          if (priceEl) {
            priceEl.textContent = '$' + (price > 100 ? price.toFixed(0) : price.toFixed(price > 1 ? 2 : 4));
          }
          
          if (changeEl) {
            changeEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
            changeEl.className = 'watchlist-change ' + (change >= 0 ? 'up' : 'down');
          }
          
          // Mini chart
          updateMiniChart(shortSymbol, symbol);
          
        } catch(e) {}
      }
    }

    async function updateMiniChart(shortSymbol, symbol) {
      try {
        const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1h&limit=8`);
        const data = await response.json();
        
        const container = document.getElementById(`chart-${shortSymbol}`);
        if (!container) return;
        
        const closes = data.map(k => parseFloat(k[4]));
        const min = Math.min(...closes);
        const max = Math.max(...closes);
        const range = max - min || 1;
        
        container.innerHTML = closes.map((c, i) => {
          const height = ((c - min) / range * 100);
          const color = i > 0 && closes[i] >= closes[i-1] ? 'var(--accent-green)' : 'var(--accent-red)';
          return `<div class="mini-bar" style="height:${Math.max(10, height)}%; background:${color};"></div>`;
        }).join('');
      } catch(e) {}
    }

    // ============================================
    // INITIALIZATION FOR NEW TOOLS
    // ============================================

    // Load saved data and start updates
    loadStrategies();
    
    // Update watchlist every 10 seconds
    setInterval(updateWatchlist, 10000);
    updateWatchlist();
    
    // Update correlations every 2 minutes
    setInterval(updateCorrelations, 120000);
    
    // Update Fibonacci when tools panel opens
    const origToggleToolsPanel = toggleToolsPanel;
    toggleToolsPanel = function() {
      origToggleToolsPanel();
      if (document.getElementById('toolsOverlay').classList.contains('active')) {
        updateFibonacci();
        updateCorrelations();
        updateWatchlist();
      }
    };

  </script>

  <!-- PWA INSTALL BANNER -->
  <div id="pwaInstallBanner" class="pwa-install-banner">
    <div class="pwa-install-content">
      <div class="pwa-install-icon"><span>X</span></div>
      <div class="pwa-install-text">
        <h4>Install XRP ORACULUM</h4>
        <p>Add to home screen for the best experience</p>
      </div>
    </div>
    <button class="pwa-install-btn" id="pwaInstallBtn">
      üì≤ INSTALL APP
    </button>
    <button class="pwa-install-close" id="pwaInstallClose">‚úï</button>
  </div>

  <!-- iOS INSTALL INSTRUCTIONS MODAL -->
  <div id="iosInstallModal" class="ios-install-modal">
    <div class="ios-install-content">
      <h3>üì± Install on iPhone/iPad</h3>
      <div class="ios-step">
        <div class="ios-step-num">1</div>
        <div class="ios-step-text">Tap the <span class="ios-step-icon">‚¨ÜÔ∏è</span> Share button in Safari</div>
      </div>
      <div class="ios-step">
        <div class="ios-step-num">2</div>
        <div class="ios-step-text">Scroll down and tap <strong>"Add to Home Screen"</strong></div>
      </div>
      <div class="ios-step">
        <div class="ios-step-num">3</div>
        <div class="ios-step-text">Tap <strong>"Add"</strong> to install the app</div>
      </div>
      <button class="add-alert-btn" onclick="closeIosModal()" style="margin-top:20px;">Got it!</button>
    </div>
  </div>

  <script>
    // ============================================
    // PWA INSTALLATION LOGIC
    // ============================================

    let deferredPrompt = null;
    const pwaInstallBanner = document.getElementById('pwaInstallBanner');
    const pwaInstallBtn = document.getElementById('pwaInstallBtn');
    const pwaInstallClose = document.getElementById('pwaInstallClose');
    const iosInstallModal = document.getElementById('iosInstallModal');

    // Detect if running as installed PWA
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                         window.navigator.standalone === true;

    // Detect iOS
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    // Detect if already dismissed
    const pwaDismissed = localStorage.getItem('pwa_install_dismissed');
    const pwaDismissedTime = pwaDismissed ? parseInt(pwaDismissed) : 0;
    const daysSinceDismiss = (Date.now() - pwaDismissedTime) / (1000 * 60 * 60 * 24);

    // Show banner after delay if not installed and not recently dismissed
    function checkShowInstallBanner() {
      if (isStandalone) return; // Already installed
      if (daysSinceDismiss < 7 && pwaDismissed) return; // Dismissed within 7 days
      
      setTimeout(() => {
        if (isIOS) {
          // Show iOS-specific banner
          pwaInstallBanner.classList.add('show');
          pwaInstallBtn.textContent = 'üì≤ HOW TO INSTALL';
        } else if (deferredPrompt) {
          // Show Android/Desktop banner
          pwaInstallBanner.classList.add('show');
        }
      }, 5000); // Show after 5 seconds
    }

    // Listen for beforeinstallprompt (Android/Desktop)
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      checkShowInstallBanner();
    });

    // Handle install button click
    pwaInstallBtn.addEventListener('click', async () => {
      if (isIOS) {
        // Show iOS instructions
        iosInstallModal.classList.add('show');
        pwaInstallBanner.classList.remove('show');
      } else if (deferredPrompt) {
        // Trigger native install prompt
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
          console.log('PWA installed');
          addAlert('üéâ App installed successfully!', 'bullish');
        }
        
        deferredPrompt = null;
        pwaInstallBanner.classList.remove('show');
      }
    });

    // Handle close button
    pwaInstallClose.addEventListener('click', () => {
      pwaInstallBanner.classList.remove('show');
      localStorage.setItem('pwa_install_dismissed', Date.now().toString());
    });

    // Close iOS modal
    function closeIosModal() {
      iosInstallModal.classList.add('show');
      iosInstallModal.classList.remove('show');
      localStorage.setItem('pwa_install_dismissed', Date.now().toString());
    }

    // Close iOS modal on outside click
    iosInstallModal.addEventListener('click', (e) => {
      if (e.target === iosInstallModal) {
        closeIosModal();
      }
    });

    // Listen for successful installation
    window.addEventListener('appinstalled', () => {
      console.log('XRP ORACULUM installed');
      pwaInstallBanner.classList.remove('show');
      deferredPrompt = null;
    });

    // Check on load
    if (!isStandalone) {
      checkShowInstallBanner();
    }

    // ============================================
    // SERVICE WORKER REGISTRATION
    // ============================================

    // Create and register Service Worker inline
    const swCode = `
      const CACHE_NAME = 'xrp-oraculum-v3-cache';
      const OFFLINE_URL = '/offline.html';
      
      // Assets to cache immediately
      const PRECACHE_ASSETS = [
        './',
        './index.html'
      ];
      
      // Install event
      self.addEventListener('install', (event) => {
        console.log('[SW] Installing...');
        self.skipWaiting();
      });
      
      // Activate event
      self.addEventListener('activate', (event) => {
        console.log('[SW] Activated');
        event.waitUntil(clients.claim());
      });
      
      // Fetch event - Network first, fallback to cache
      self.addEventListener('fetch', (event) => {
        // Skip non-GET requests
        if (event.request.method !== 'GET') return;
        
        // Skip API requests (always fetch from network)
        if (event.request.url.includes('api.binance.com') || 
            event.request.url.includes('api.alternative.me')) {
          return;
        }
        
        event.respondWith(
          fetch(event.request)
            .then((response) => {
              // Clone and cache successful responses
              if (response.ok) {
                const responseClone = response.clone();
                caches.open(CACHE_NAME).then((cache) => {
                  cache.put(event.request, responseClone);
                });
              }
              return response;
            })
            .catch(() => {
              // Fallback to cache
              return caches.match(event.request);
            })
        );
      });
    `;

    // Register Service Worker
    if ('serviceWorker' in navigator) {
      // Create blob URL for inline SW
      const swBlob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(swBlob);
      
      // Try to register
      navigator.serviceWorker.register(swUrl, { scope: '.' })
        .then((registration) => {
          console.log('[PWA] Service Worker registered:', registration.scope);
        })
        .catch((error) => {
          // SW registration may fail on file:// or some hosting
          console.log('[PWA] Service Worker registration skipped:', error.message);
        });
    }

    // ============================================
    // ONLINE/OFFLINE STATUS
    // ============================================

    function updateOnlineStatus() {
      if (!navigator.onLine) {
        addAlert('‚ö†Ô∏è You are offline. Some features may be limited.', 'warning');
        document.getElementById('apiStatusText').textContent = 'OFFLINE';
        document.getElementById('statusPill').classList.remove('status-live');
        document.getElementById('statusPill').classList.add('status-err');
      }
    }

    window.addEventListener('online', () => {
      addAlert('‚úÖ Back online! Reconnecting...', 'bullish');
      // Reconnect WebSocket
      if (typeof connectWebSocket === 'function') {
        connectWebSocket();
      }
    });

    window.addEventListener('offline', updateOnlineStatus);

    // Check initial status
    if (!navigator.onLine) {
      updateOnlineStatus();
    }

    // ============================================
    // MOBILE TOUCH OPTIMIZATIONS
    // ============================================

    // Prevent double-tap zoom on buttons
    document.addEventListener('touchend', (e) => {
      if (e.target.tagName === 'BUTTON' || e.target.classList.contains('control-btn')) {
        e.preventDefault();
        e.target.click();
      }
    }, { passive: false });

    // Improve scroll performance
    document.addEventListener('touchstart', () => {}, { passive: true });
    document.addEventListener('touchmove', () => {}, { passive: true });

    // Handle viewport height on mobile (fixes 100vh issue)
    function setVH() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    setVH();
    window.addEventListener('resize', setVH);

    // ============================================
    // KEYBOARD SHORTCUTS
    // ============================================

    document.addEventListener('keydown', (e) => {
      // T = Toggle Tools
      if (e.key === 't' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT') {
        toggleToolsPanel();
      }
      // Escape = Close modals
      if (e.key === 'Escape') {
        document.getElementById('toolsOverlay').classList.remove('active');
        iosInstallModal.classList.remove('show');
      }
      // S = Toggle sound
      if (e.key === 's' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT') {
        toggleSound();
      }
      // D = Toggle dark/light mode
      if (e.key === 'd' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT') {
        toggleTheme();
      }
    });

    console.log('%c XRP ORACULUM OkrtSystem Labs ', 'background: linear-gradient(135deg, #00d4ff, #a855f7); color: #000; font-size: 20px; font-weight: bold; padding: 10px 20px; border-radius: 5px;');
    console.log('%c by OkrtSystem Labs ', 'color: #00d4ff; font-size: 12px;');
    console.log('%c Keyboard shortcuts: T=Tools, S=Sound, D=Dark mode, ESC=Close ', 'color: #94a3b8; font-size: 10px;');

  </script>
</body>
</html>
