<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ORACULUM — AI Engine (Order Flow Mode)</title>
  <style>
    :root {
      --bg: #070A10;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.04);
      --bd: rgba(255,255,255,0.10);
      --txt: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --good: #2dd4bf;
      --bad: #fb7185;
      --warn: #fbbf24;
      --accent: #60a5fa;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(900px 500px at 40% -10%, rgba(96,165,250,.18), transparent 60%), var(--bg); color:var(--txt); font-family:var(--sans);}
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--bd);background:rgba(0,0,0,0.35);backdrop-filter: blur(6px); position:sticky; top:0; z-index:50;}
    .brand{display:flex;flex-direction:column;line-height:1.1}
    .brand b{letter-spacing:.6px}
    .brand small{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{font-family:var(--mono);font-size:12px;padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:rgba(255,255,255,0.04);}
    .pill.live{border-color:rgba(45,212,191,.45);color:var(--good);}
    .pill.down{border-color:rgba(251,113,133,.45);color:var(--bad);}
    .btn{cursor:pointer;border:1px solid var(--bd);background:rgba(255,255,255,0.06);color:var(--txt);padding:7px 10px;border-radius:10px;font-family:var(--sans);font-size:13px}
    .btn:hover{background:rgba(255,255,255,0.09)}
    input,select{border:1px solid var(--bd);background:rgba(0,0,0,0.25);color:var(--txt);padding:7px 10px;border-radius:10px;font-family:var(--mono);font-size:13px}
    main{padding:14px 16px;max-width:1280px;margin:0 auto}
    .grid{display:grid;grid-template-columns: 1.2fr 1fr 1fr; gap:12px}
    @media (max-width: 1100px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--bd);background:var(--card);border-radius:16px;padding:12px}
    .card h3{margin:0 0 10px 0;font-size:13px;letter-spacing:.6px;color:rgba(255,255,255,0.82);text-transform:uppercase}
    .kpis{display:grid;grid-template-columns: repeat(4,1fr); gap:10px}
    @media (max-width: 1100px){.kpis{grid-template-columns: repeat(2,1fr)}}
    .kpi{border:1px solid rgba(255,255,255,0.08);background:var(--card2);border-radius:14px;padding:10px}
    .kpi .v{font-family:var(--mono);font-size:18px;font-weight:700}
    .kpi .l{color:var(--muted);font-size:11px;margin-top:4px;text-transform:uppercase;letter-spacing:.5px}
    .split{display:grid;grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 1100px){.split{grid-template-columns:1fr}}
    .ob{display:grid;grid-template-columns:1fr 1fr; gap:10px}
    .obcol{border:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.20);border-radius:14px;padding:8px}
    .obrow{display:flex;justify-content:space-between;font-family:var(--mono);font-size:12px;padding:2px 6px}
    .ask{color:var(--bad)}
    .bid{color:var(--good)}
    .log{font-family:var(--mono);font-size:12px;white-space:pre-wrap;max-height:220px;overflow:auto;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:10px}
    .footmark{position:fixed;right:12px;bottom:10px;font-family:var(--mono);font-size:12px;color:rgba(255,255,255,0.55)}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.12);background:rgba(0,0,0,0.2);font-family:var(--mono);font-size:12px}
    .tag.buy{border-color:rgba(45,212,191,.45);color:var(--good)}
    .tag.sell{border-color:rgba(251,113,133,.45);color:var(--bad)}
    .tag.neu{border-color:rgba(251,191,36,.45);color:var(--warn)}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <b>ORACULUM — Order Flow Mode</b>
    <small>Sin gráfico de velas · Ingesta por Order Book + Trades · AI Engine PRO</small>
  </div>
  <div class="row">
    <span id="connPill" class="pill down">OFFLINE</span>
    <label class="row" style="gap:6px;">
      <span class="pill">SYMBOL</span>
      <input id="symbolInput" value="XRPUSDT" style="width:120px" />
    </label>
    <button id="btnConnect" class="btn">Conectar</button>
    <button id="btnDisconnect" class="btn">Desconectar</button>
  </div>
</header>

<main>
  <div class="card">
    <h3>Telemetría</h3>
    <div class="kpis">
      <div class="kpi"><div class="v" id="kpiPrice">—</div><div class="l">Último precio</div></div>
      <div class="kpi"><div class="v" id="kpiSpread">—</div><div class="l">Spread</div></div>
      <div class="kpi"><div class="v" id="kpiImb">—</div><div class="l">Imbalance (Top 20)</div></div>
      <div class="kpi"><div class="v" id="kpiDelta">—</div><div class="l">Trade Delta (1m)</div></div>
    </div>
  </div>

  <div style="height:12px"></div>

  <div class="grid">
    <div class="card">
      <h3>Order Book (Top 20)</h3>
      <div class="ob">
        <div class="obcol">
          <div class="obrow"><span class="ask">ASK</span><span class="ask">QTY</span></div>
          <div id="asks"></div>
        </div>
        <div class="obcol">
          <div class="obrow"><span class="bid">BID</span><span class="bid">QTY</span></div>
          <div id="bids"></div>
        </div>
      </div>
      <div style="margin-top:10px;color:var(--muted);font-size:12px">
        Fuente: Binance WS <span class="pill">@depth20@100ms</span> · Render batched (rAF).
      </div>
    </div>

    <div class="card">
      <h3>AI Engine PRO</h3>
      <div class="split">
        <div>
          <div class="row" style="justify-content:space-between">
            <span class="pill">STATUS</span>
            <span id="aiStatus" class="pill">LOADING</span>
          </div>
          <div style="height:10px"></div>
          <div class="kpis" style="grid-template-columns:repeat(2,1fr)">
            <div class="kpi"><div class="v" id="aiVersion">—</div><div class="l">Versión</div></div>
            <div class="kpi"><div class="v" id="aiAccuracy">—</div><div class="l">Accuracy</div></div>
            <div class="kpi"><div class="v" id="aiUptime">—</div><div class="l">Uptime</div></div>
            <div class="kpi"><div class="v" id="aiSessions">—</div><div class="l">Sessions</div></div>
          </div>
        </div>
        <div>
          <div class="row" style="justify-content:space-between">
            <span class="pill">SEÑAL</span>
            <span id="aiSignal" class="tag neu">NEUTRAL</span>
          </div>
          <div style="height:10px"></div>
          <div class="kpi">
            <div class="v" id="aiWhy" style="font-size:13px;line-height:1.25;font-weight:600;">—</div>
            <div class="l">Razonamiento (última)</div>
          </div>
          <div style="height:10px"></div>
          <div class="kpi">
            <div class="v" id="aiHorizon" style="font-size:13px">—</div>
            <div class="l">Horizonte / Confianza</div>
          </div>
        </div>
      </div>
      <div style="margin-top:10px;color:var(--muted);font-size:12px">
        Entrada principal: candles 1m agregadas desde <span class="pill">@aggTrade</span> (sin gráfico).
      </div>
    </div>

    <div class="card">
      <h3>Eventos</h3>
      <div id="log" class="log"></div>
    </div>
  </div>
</main>

<div class="footmark">OkrtSystem · B33RU5</div>

<script src="ai-engine-pro.js"></script>
<script nonce="okrt-nograph-2026">
'use strict';

const FIREBASE_CONFIG = {
      // ⚠️ REEMPLAZA CON TUS DATOS DE FIREBASE
      apiKey: "AIzaSyC_mWJcJMCrQv005hvYfHiUf7WDwgpD_nI",
      authDomain: "oraculum-ia.firebaseapp.com",
      projectId: "oraculum-ia",
      storageBucket: "oraculum-ia.firebasestorage.app",
      messagingSenderId: "965301309562",
      appId: "1:965301309562:web:9e81e2a57421454227abc3"
    };

const UI = {
  connPill: document.getElementById('connPill'),
  symbolInput: document.getElementById('symbolInput'),
  btnConnect: document.getElementById('btnConnect'),
  btnDisconnect: document.getElementById('btnDisconnect'),
  kpiPrice: document.getElementById('kpiPrice'),
  kpiSpread: document.getElementById('kpiSpread'),
  kpiImb: document.getElementById('kpiImb'),
  kpiDelta: document.getElementById('kpiDelta'),
  asks: document.getElementById('asks'),
  bids: document.getElementById('bids'),
  log: document.getElementById('log'),
  aiStatus: document.getElementById('aiStatus'),
  aiVersion: document.getElementById('aiVersion'),
  aiAccuracy: document.getElementById('aiAccuracy'),
  aiUptime: document.getElementById('aiUptime'),
  aiSessions: document.getElementById('aiSessions'),
  aiSignal: document.getElementById('aiSignal'),
  aiWhy: document.getElementById('aiWhy'),
  aiHorizon: document.getElementById('aiHorizon'),
};

function log(msg){
  const ts = new Date().toLocaleTimeString();
  UI.log.textContent = `[${ts}] ${msg}\n` + UI.log.textContent;
  // cap logs
  if(UI.log.textContent.length > 12000) UI.log.textContent = UI.log.textContent.slice(0, 12000);
}

function setConn(state){
  if(state==='LIVE') {
    UI.connPill.textContent = 'LIVE';
    UI.connPill.className = 'pill live';
  } else {
    UI.connPill.textContent = state || 'OFFLINE';
    UI.connPill.className = 'pill down';
  }
}

// -------------------------
// Streams (Binance)
// -------------------------
let ws = null;
let wsIntentionalClose = false;
let wsReconnectTimer = null;
let wsToken = 0;

// batching for DOM
let pendingBook = null;
let rafScheduled = false;

// trade aggregation (1m candle + delta)
let currentMinute = null;
let candle = null;
let buyVol1m = 0;
let sellVol1m = 0;

function normSymbol(){
  return (UI.symbolInput.value || 'XRPUSDT').trim().toLowerCase();
}

function getWsUrl(){
  const s = normSymbol();
  return `wss://stream.binance.com:9443/stream?streams=${s}@depth20@100ms/${s}@ticker/${s}@aggTrade`;
}

function resetAgg(){
  currentMinute = null;
  candle = null;
  buyVol1m = 0;
  sellVol1m = 0;
  UI.kpiDelta.textContent = '—';
}

function closeWS(){
  if(!ws) return;
  try {
    wsIntentionalClose = true;
    if(wsReconnectTimer) { clearTimeout(wsReconnectTimer); wsReconnectTimer = null; }
    ws.onopen = ws.onmessage = ws.onerror = ws.onclose = null;
    ws.close(1000, 'intentional');
  } catch(_) {}
  ws = null;
}

function connect(){
  const token = ++wsToken;
  wsIntentionalClose = false;
  if(wsReconnectTimer) { clearTimeout(wsReconnectTimer); wsReconnectTimer = null; }

  // Avoid duplicate opens
  if(ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
    log('WS already open/connecting; skip');
    return;
  }

  const url = getWsUrl();
  log(`Connecting: ${url}`);
  setConn('CONNECTING');
  ws = new WebSocket(url);

  ws.onopen = () => {
    if(token !== wsToken) return;
    setConn('LIVE');
    log('WS connected');
  };

  ws.onerror = () => {
    if(token !== wsToken) return;
    log('WS error');
  };

  ws.onclose = () => {
    if(token !== wsToken) return;
    setConn('OFFLINE');
    log(wsIntentionalClose ? 'WS closed (intentional)' : 'WS closed');
    if(wsIntentionalClose) return;
    wsReconnectTimer = setTimeout(() => {
      wsReconnectTimer = null;
      connect();
    }, 1500);
  };

  ws.onmessage = (event) => {
    if(token !== wsToken) return;
    let msg;
    try { msg = JSON.parse(event.data); } catch(_) { return; }
    if(!msg || !msg.stream || !msg.data) return;

    const stream = msg.stream;
    const data = msg.data;

    if(stream.includes('@ticker')) {
      const price = parseFloat(data.c);
      if(Number.isFinite(price)) {
        UI.kpiPrice.textContent = price.toFixed(6).replace(/0+$/,'').replace(/\.$/,'');
      }
      return;
    }

    if(stream.includes('@depth')) {
      pendingBook = data;
      if(!rafScheduled) {
        rafScheduled = true;
        requestAnimationFrame(flushBookUI);
      }
      return;
    }

    if(stream.includes('@aggTrade')) {
      handleAggTrade(data);
      return;
    }
  };
}

function flushBookUI(){
  rafScheduled = false;
  if(!pendingBook) return;
  const d = pendingBook; pendingBook = null;

  const bids = (d.b || []).slice(0, 20);
  const asks = (d.a || []).slice(0, 20);

  // Render ladder
  UI.asks.innerHTML = asks.map(x => {
    const p = parseFloat(x[0]); const q = parseFloat(x[1]);
    return `<div class="obrow"><span class="ask">${p.toFixed(6).replace(/0+$/,'').replace(/\.$/,'')}</span><span class="ask">${q.toFixed(2)}</span></div>`;
  }).join('');

  UI.bids.innerHTML = bids.map(x => {
    const p = parseFloat(x[0]); const q = parseFloat(x[1]);
    return `<div class="obrow"><span class="bid">${p.toFixed(6).replace(/0+$/,'').replace(/\.$/,'')}</span><span class="bid">${q.toFixed(2)}</span></div>`;
  }).join('');

  // Metrics
  const bestBid = bids[0] ? parseFloat(bids[0][0]) : NaN;
  const bestAsk = asks[0] ? parseFloat(asks[0][0]) : NaN;

  if(Number.isFinite(bestBid) && Number.isFinite(bestAsk)) {
    const spread = bestAsk - bestBid;
    UI.kpiSpread.textContent = spread.toFixed(6).replace(/0+$/,'').replace(/\.$/,'');
  }

  const bidVol = bids.reduce((s,x)=>s+ (parseFloat(x[1])||0), 0);
  const askVol = asks.reduce((s,x)=>s+ (parseFloat(x[1])||0), 0);
  const denom = (bidVol + askVol);
  const imb = denom > 0 ? (bidVol - askVol) / denom : 0;
  UI.kpiImb.textContent = (imb*100).toFixed(1) + '%';
}

function handleAggTrade(t){
  // Binance aggTrade: p (price), q (qty), T (tradeTime), m (isBuyerMaker)
  const price = parseFloat(t.p);
  const qty = parseFloat(t.q);
  const ts = t.T ? new Date(t.T) : new Date();
  if(!Number.isFinite(price) || !Number.isFinite(qty)) return;

  const minKey = ts.getUTCFullYear()+'-'+(ts.getUTCMonth()+1)+'-'+ts.getUTCDate()+' '+ts.getUTCHours()+':'+ts.getUTCMinutes();

  if(currentMinute === null) {
    currentMinute = minKey;
    candle = {
      time: Math.floor(ts.getTime()/1000),
      open: price, high: price, low: price, close: price,
      volume: qty
    };
    buyVol1m = 0; sellVol1m = 0;
  }

  // If minute changed, finalize previous candle
  if(minKey !== currentMinute) {
    const finalized = candle;
    // push to AI engine
    try {
      if(window.AIEnginePro && typeof window.AIEnginePro.onMarketData === 'function') {
        window.AIEnginePro.onMarketData(finalized);
      }
    } catch(e) {
      // non-fatal
    }

    // reset for new minute
    currentMinute = minKey;
    candle = {
      time: Math.floor(ts.getTime()/1000),
      open: price, high: price, low: price, close: price,
      volume: qty
    };
    buyVol1m = 0; sellVol1m = 0;
  } else {
    // update current candle
    candle.high = Math.max(candle.high, price);
    candle.low  = Math.min(candle.low, price);
    candle.close = price;
    candle.volume += qty;
  }

  // trade delta (isBuyerMaker == true => sell aggressor)
  if(t.m) sellVol1m += qty;
  else buyVol1m += qty;

  const delta = buyVol1m - sellVol1m;
  UI.kpiDelta.textContent = delta.toFixed(2);
}

// -------------------------
// AI Panel (light)
// -------------------------
function updateAI() {
  if(document.hidden) return;

  if(!window.AIEnginePro || !window.AIEnginePro.isReady) {
    UI.aiStatus.textContent = 'LOADING';
    return;
  }
  UI.aiStatus.textContent = 'READY';
  if(window.AIEnginePro.version) UI.aiVersion.textContent = String(window.AIEnginePro.version);

  try {
    const stats = window.AIEnginePro.getStats ? window.AIEnginePro.getStats() : null;
    if(stats) {
      if(typeof stats.accuracy === 'number') UI.aiAccuracy.textContent = (stats.accuracy*100).toFixed(1) + '%';
      if(typeof stats.uptimeMinutes === 'number') UI.aiUptime.textContent = stats.uptimeMinutes.toFixed(0) + 'm';
      if(typeof stats.sessions === 'number') UI.aiSessions.textContent = stats.sessions.toFixed(0);
    }
  } catch(_) {}

  try {
    const pred = window.AIEnginePro.getPrediction ? window.AIEnginePro.getPrediction() : null;
    if(pred) {
      const signal = (pred.signal || pred.action || 'NEUTRAL').toString().toUpperCase();
      UI.aiSignal.textContent = signal;
      UI.aiSignal.className = 'tag ' + (signal.includes('BUY') ? 'buy' : signal.includes('SELL') ? 'sell' : 'neu');
      UI.aiWhy.textContent = (pred.why || pred.reason || pred.summary || '—');
      const hz = pred.horizon || pred.tf || pred.timeframe || '—';
      const conf = (typeof pred.confidence === 'number') ? Math.round(pred.confidence*100)+'%' : (pred.confidence || '—');
      UI.aiHorizon.textContent = `${hz} · ${conf}`;
    }
  } catch(_) {}
}

let aiTimer = null;

function startAI() {
  // AIEnginePro expects FIREBASE_CONFIG global; already defined above
  if(window.AIEnginePro && typeof window.AIEnginePro.init === 'function') {
    try {
      window.AIEnginePro.init();
      log('AIEnginePro init()');
    } catch(e) {
      log('AIEnginePro init failed (will still run local): ' + (e && e.message ? e.message : e));
    }
  } else {
    log('AIEnginePro not found yet');
  }
  if(aiTimer) clearInterval(aiTimer);
  aiTimer = setInterval(updateAI, 1000);
}

// -------------------------
// Controls
// -------------------------
UI.btnConnect.addEventListener('click', () => {
  closeWS();
  resetAgg();
  connect();
});

UI.btnDisconnect.addEventListener('click', () => {
  closeWS();
  setConn('OFFLINE');
  log('Disconnected by user');
});

UI.symbolInput.addEventListener('change', () => {
  log('Symbol changed -> reconnect');
  closeWS();
  resetAgg();
  connect();
});

document.addEventListener('DOMContentLoaded', () => {
  // Load engine script then init
  startAI();
  connect();
  log('ORACULUM Order Flow Mode started');
});
</script>

</body>
</html>
